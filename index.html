<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Technology Expert's</title>
  <style>
    :root{
      --bg0:#050816;
      --bg1:#070b1f;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.70);

      --neonBlue:#3CF2FF;
      --neonPurple:#AA5AFF;
      --neonGreen:#50FFC8;

      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(60,242,255,.18), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, rgba(170,90,255,.16), transparent 55%),
        radial-gradient(900px 700px at 60% 90%, rgba(80,255,200,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    a{ color:inherit; }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 38px;
    }

    .topBrand{
      display:flex;
      gap:14px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 8px 2px 6px;
    }

    .brandTitle{
      font-size: clamp(34px, 4.6vw, 56px);
      font-weight: 900;
      letter-spacing: .2px;
      line-height: 1.02;
      text-shadow: 0 10px 40px rgba(0,0,0,.65);
    }

    .brandSubtitle{
      margin-top: 8px;
      color: var(--muted);
      font-weight: 600;
      max-width: 720px;
    }

    .pillRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.20);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      font-weight: 800;
      letter-spacing:.2px;
      color: rgba(234,242,255,.92);
    }

    .card{
      margin-top: 16px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* --------- Neon Tiles (Inicio) --------- */
    .roleGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:14px;
      margin-top:18px;
    }
    @media (max-width:560px){
      .roleGrid{ gap:10px; }
    }

    .roleTile{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      border-radius:18px;
      padding:14px 10px 12px;
      cursor:pointer;
      box-shadow: var(--shadow);
      position:relative;
      transition: transform .16s ease, filter .16s ease;
      backdrop-filter: blur(10px);
      min-height: 130px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .roleTile:hover{ transform: translateY(-2px); }
    .roleTile:active{ transform: scale(.98); }

    .iconBox{
      height:64px; width:64px;
      border-radius:16px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
    }
    .ico{ width:34px; height:34px; color: currentColor; filter: drop-shadow(0 0 12px currentColor); }

    .roleLabel{
      font-weight: 900;
      letter-spacing: .7px;
      font-size: 12px;
      opacity:.98;
      text-align:center;
    }

    .neon-blue{ color: var(--neonBlue); border-color: rgba(60,242,255,.35); box-shadow: 0 0 0 1px rgba(60,242,255,.35), 0 0 18px rgba(60,242,255,.18), var(--shadow); }
    .neon-purple{ color: var(--neonPurple); border-color: rgba(170,90,255,.35); box-shadow: 0 0 0 1px rgba(170,90,255,.35), 0 0 18px rgba(170,90,255,.20), var(--shadow); }
    .neon-green{ color: var(--neonGreen); border-color: rgba(80,255,200,.30); box-shadow: 0 0 0 1px rgba(80,255,200,.30), 0 0 18px rgba(80,255,200,.18), var(--shadow); }

    /* --------- Buttons Neon Tech --------- */
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      color: var(--text);
      font-weight: 900;
      letter-spacing:.3px;
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .15s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:10px;
      min-height: 44px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: scale(.98); }
    .btn.small{ padding: 10px 12px; border-radius: 14px; min-height:40px; }
    .btn.full{ width:100%; justify-content:center; }
    .btn.blue{ border-color: rgba(60,242,255,.35); box-shadow: 0 0 0 1px rgba(60,242,255,.25), 0 0 18px rgba(60,242,255,.12), var(--shadow); }
    .btn.purple{ border-color: rgba(170,90,255,.35); box-shadow: 0 0 0 1px rgba(170,90,255,.22), 0 0 18px rgba(170,90,255,.14), var(--shadow); }
    .btn.green{ border-color: rgba(80,255,200,.30); box-shadow: 0 0 0 1px rgba(80,255,200,.20), 0 0 18px rgba(80,255,200,.12), var(--shadow); }
    .btn.danger{ border-color: rgba(255,80,100,.35); box-shadow: 0 0 0 1px rgba(255,80,100,.22), 0 0 18px rgba(255,80,100,.10), var(--shadow); }
    .btn.ghost{ background: rgba(255,255,255,.06); }

    /* --------- Sections / Tabs --------- */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
    }
    .tabBtn{
      flex: 1 1 160px;
      text-align:center;
    }

    .hidden{ display:none !important; }

    .h2{
      font-size: 26px;
      margin: 0 0 8px;
      font-weight: 900;
    }
    .h3{
      font-size: 16px;
      margin: 14px 0 8px;
      font-weight: 900;
      color: rgba(234,242,255,.92);
    }

    /* --------- Inputs --------- */
    input, textarea, select{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      color: var(--text);
      font-weight: 800;
      letter-spacing:.2px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.2);
    }
    input::placeholder, textarea::placeholder{ color: rgba(234,242,255,.45); font-weight:700; }
    textarea{ min-height: 92px; resize: vertical; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width:720px){
      .grid2,.grid3{ grid-template-columns: 1fr; }
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    /* --------- Lists --------- */
    .list{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .item{
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .itemTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .itemTitle{
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 15px;
      color: rgba(234,242,255,.95);
    }
    .itemMeta{
      color: rgba(234,242,255,.70);
      font-weight: 700;
      font-size: 12px;
    }
    .kv{
      margin-top: 8px;
      display:grid;
      gap: 4px;
      color: rgba(234,242,255,.88);
      font-weight: 700;
      font-size: 13px;
    }
    .kv span b{ color: rgba(234,242,255,.98); }

    /* --------- Modal --------- */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width:min(520px, 100%);
      background: rgba(10,12,30,.92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      padding: 16px;
      box-shadow: 0 26px 80px rgba(0,0,0,.75);
      backdrop-filter: blur(10px);
    }
    .modalTitle{
      font-size: 18px;
      font-weight: 900;
      margin: 0 0 10px;
    }
    .modalClose{
      float:right;
      cursor:pointer;
      opacity:.8;
      font-weight:900;
    }

    /* --------- Signature --------- */
    .sigBox{
      border: 1px dashed rgba(255,255,255,.25);
      background: rgba(0,0,0,.28);
      border-radius: 18px;
      padding: 10px;
    }
    canvas{
      width: 100%;
      height: 180px;
      border-radius: 14px;
      display:block;
      background: rgba(255,255,255,.04);
    }

    /* --------- Scanner --------- */
    .scanWrap{
      display:grid;
      gap:10px;
    }
    video{
      width:100%;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      box-shadow: var(--shadow);
    }
    .note{
      color: rgba(234,242,255,.70);
      font-weight: 650;
      font-size: 13px;
      margin-top: 6px;
    }

    /* --------- Top Mini Status --------- */
    .statusBar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .badge{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      font-weight: 900;
      letter-spacing:.2px;
      color: rgba(234,242,255,.92);
    }
    .badge strong{ color: var(--neonBlue); }

    /* ---------- small icons in buttons ---------- */
    .btn svg{ width:18px; height:18px; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- ===== INICIO (ROL) ===== -->
    <section id="screenHome" class="card">
      <div class="topBrand">
        <div>
          <div class="brandTitle">Technology Expert's</div>
          <div class="brandSubtitle">Selecciona qui√©n ingresa (dise√±o Neon Tech). PC / Android / iPhone.</div>
          <div class="pillRow">
            <div class="pill">üì¶ √ìrdenes</div>
            <div class="pill">üí≥ Ventas</div>
            <div class="pill">üè∑Ô∏è Inventario</div>
            <div class="pill">üì∑ Esc√°ner (barcode/QR)</div>
          </div>
        </div>
      </div>

      <div class="roleGrid">
        <button class="roleTile neon-blue" data-role="admin">
          <div class="iconBox">
            <svg viewBox="0 0 24 24" class="ico" aria-hidden="true">
              <path d="M12 2l8 4v6c0 5-3.2 9.4-8 10-4.8-.6-8-5-8-10V6l8-4z" fill="none" stroke="currentColor" stroke-width="1.8"/>
              <path d="M9.5 12.2l1.8 1.8 3.7-4" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="roleLabel">ADMINISTRADOR</div>
        </button>

        <button class="roleTile neon-purple" data-role="ventas">
          <div class="iconBox">
            <svg viewBox="0 0 24 24" class="ico" aria-hidden="true">
              <path d="M5 7h14v3a2 2 0 010 4v3H5v-3a2 2 0 010-4V7z" fill="none" stroke="currentColor" stroke-width="1.8"/>
              <path d="M9 10h6M9 13h6" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="roleLabel">VENTAS</div>
        </button>

        <button class="roleTile neon-green" data-role="tecnico">
          <div class="iconBox">
            <svg viewBox="0 0 24 24" class="ico" aria-hidden="true">
              <path d="M14 7a5 5 0 11-2 4l-7 7H3v-2l7-7a5 5 0 014-2z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="roleLabel">T√âCNICO</div>
        </button>
      </div>

      <div class="divider"></div>

      <div class="note">
        üîê Cada rol entra con usuario y contrase√±a. (Admin puede cambiarlos).
      </div>
    </section>

    <!-- ===== APP ===== -->
    <section id="screenApp" class="card hidden">

      <div class="statusBar">
        <div class="badge">Rol: <strong id="whoRole">‚Äî</strong></div>
        <div class="badge">Usuario: <strong id="whoUser">‚Äî</strong></div>
        <div class="btnRow">
          <button class="btn small ghost" id="btnLogout">
            <svg viewBox="0 0 24 24" fill="none"><path d="M10 7V5a2 2 0 012-2h7a2 2 0 012 2v14a2 2 0 01-2 2h-7a2 2 0 01-2-2v-2" stroke="currentColor" stroke-width="2"/><path d="M15 12H3m0 0l3-3M3 12l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Salir
          </button>
        </div>
      </div>

      <div class="tabs">
        <button class="btn tabBtn blue" data-screen="orders">üßæ √ìrdenes</button>
        <button class="btn tabBtn purple" data-screen="sales">üí≥ Ventas</button>
        <button class="btn tabBtn green" data-screen="inventory">üì¶ Inventario</button>
        <button class="btn tabBtn ghost" data-screen="admin">‚öôÔ∏è Admin</button>
      </div>

      <!-- ===== √ìRDENES ===== -->
      <div id="orders" class="card" style="margin-top:14px;">
        <div class="h2">Orden de Servicio</div>
        <div class="note">N√∫mero siguiente: <b id="nextOrderNo">‚Äî</b></div>

        <div class="h3">Datos del cliente</div>
        <div class="grid2">
          <input id="oCliente" placeholder="Nombre del cliente" autocomplete="name"/>
          <input id="oCedula" placeholder="C√©dula" inputmode="numeric" />
        </div>
        <div class="grid2">
          <input id="oTelefono" placeholder="Celular" inputmode="tel" autocomplete="tel"/>
          <input id="oCorreo" placeholder="Correo electr√≥nico" inputmode="email" autocomplete="email" list="emailDomains"/>
        </div>
        <datalist id="emailDomains"></datalist>

        <div class="h3">Equipo</div>
        <div class="grid2">
          <input id="oMarca" placeholder="Marca (Samsung, Xiaomi...)" list="brandList" autocomplete="off"/>
          <input id="oModelo" placeholder="Modelo del celular" autocomplete="off"/>
        </div>
        <textarea id="oFalla" placeholder="Falla reportada"></textarea>

        <div class="h3">Firma del cliente (OBLIGATORIA)</div>
        <div class="sigBox">
          <div class="note">Firma con el dedo. Si no firma, NO deja guardar.</div>
          <canvas id="sigCanvas"></canvas>
          <div class="btnRow" style="margin-top:10px;">
            <button class="btn danger" id="btnSigClear">üßΩ Borrar firma</button>
            <button class="btn blue" id="btnOrderSave">üíæ Guardar orden</button>
            <button class="btn ghost" id="btnOrderNew">üÜï Nueva orden (limpiar)</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="h3">√ìrdenes guardadas</div>
        <div class="grid2">
          <input id="qOrders" placeholder="Buscar por #, nombre, c√©dula, tel, correo, marca, modelo..." />
          <div class="btnRow">
            <button class="btn small ghost" id="btnOrdersCsv">‚¨áÔ∏è CSV √ìrdenes</button>
            <button class="btn small ghost" id="btnOrdersClear">üóëÔ∏è Borrar TODAS las √≥rdenes</button>
          </div>
        </div>
        <div id="ordersList" class="list"></div>
      </div>

      <!-- ===== VENTAS ===== -->
      <div id="sales" class="card hidden" style="margin-top:14px;">
        <div class="h2">Ventas</div>
        <div class="note">N√∫mero siguiente: <b id="nextSaleNo">‚Äî</b></div>

        <div class="h3">Datos del cliente</div>
        <div class="grid2">
          <input id="sCliente" placeholder="Nombre del cliente" autocomplete="name"/>
          <input id="sCedula" placeholder="C√©dula" inputmode="numeric"/>
        </div>
        <div class="grid2">
          <input id="sTelefono" placeholder="Celular" inputmode="tel" autocomplete="tel"/>
          <input id="sCorreo" placeholder="Correo electr√≥nico" inputmode="email" autocomplete="email" list="emailDomains2"/>
        </div>
        <datalist id="emailDomains2"></datalist>

        <div class="h3">Producto vendido</div>
        <div class="grid2">
          <input id="sProducto" placeholder="Producto (Ej: iPhone 12 128GB)" />
          <input id="sPrecio" placeholder="Precio" inputmode="decimal"/>
        </div>

        <div class="h3">IMEI (si es tel√©fono)</div>
        <div class="grid2">
          <input id="sImei1" placeholder="IMEI 1 (15 d√≠gitos)" inputmode="numeric"/>
          <input id="sImei2" placeholder="IMEI 2 (opcional)" inputmode="numeric"/>
        </div>

        <div class="h3">T√©rminos (OBLIGATORIO)</div>
        <div class="item">
          <div class="note" style="margin:0 0 10px;">
            ‚úÖ <b>NO respondemos</b> si el cliente <b>NO registra</b> los IMEI ante el operador que va a usar.
          </div>
          <label style="display:flex; gap:10px; align-items:flex-start; font-weight:900;">
            <input id="sTerminos" type="checkbox" style="width:auto; margin-top:4px; transform:scale(1.15);" />
            Acepto los t√©rminos y condiciones (obligatorio).
          </label>
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="btn purple" id="btnSaleSave">üíæ Guardar venta</button>
          <button class="btn ghost" id="btnSaleNew">üÜï Nueva venta (limpiar)</button>
        </div>

        <div class="divider"></div>

        <div class="h3">Ventas guardadas</div>
        <div class="grid2">
          <input id="qSales" placeholder="Buscar por #, nombre, c√©dula, IMEI, producto..." />
          <div class="btnRow">
            <button class="btn small ghost" id="btnSalesCsv">‚¨áÔ∏è CSV Ventas</button>
            <button class="btn small ghost" id="btnSalesClear">üóëÔ∏è Borrar TODAS las ventas</button>
          </div>
        </div>
        <div id="salesList" class="list"></div>
      </div>

      <!-- ===== INVENTARIO ===== -->
      <div id="inventory" class="card hidden" style="margin-top:14px;">
        <div class="h2">Inventario</div>

        <div class="h3">Agregar / Editar producto</div>

        <div class="grid2">
          <input id="iCode" placeholder="C√≥digo (barcode/QR)" />
          <button class="btn green" id="btnScanToInventory">üì∑ Escanear c√≥digo</button>
        </div>

        <div class="grid2">
          <input id="iNombre" placeholder="Nombre producto" />
          <input id="iMarca" placeholder="Marca (autocompleta y aprende)" list="brandList" />
        </div>

        <div class="grid3">
          <input id="iCosto" placeholder="Costo" inputmode="decimal"/>
          <input id="iPrecio" placeholder="Precio venta" inputmode="decimal"/>
          <input id="iQty" placeholder="Cantidad" inputmode="numeric"/>
        </div>

        <div class="h3">Foto (opcional)</div>
        <input id="iFoto" type="file" accept="image/*" />

        <div class="btnRow" style="margin-top:10px;">
          <button class="btn green" id="btnInvSave">üíæ Guardar en inventario</button>
          <button class="btn ghost" id="btnInvNew">üÜï Nuevo producto (limpiar)</button>
        </div>

        <div class="divider"></div>

        <div class="h3">Inventario guardado</div>
        <div class="grid2">
          <input id="qInv" placeholder="Buscar por c√≥digo, nombre, marca..." />
          <div class="btnRow">
            <button class="btn small ghost" id="btnInvCsv">‚¨áÔ∏è CSV Inventario</button>
            <button class="btn small ghost" id="btnInvClear">üóëÔ∏è Borrar TODO inventario</button>
          </div>
        </div>

        <div id="invList" class="list"></div>
      </div>

      <!-- ===== ADMIN ===== -->
      <div id="admin" class="card hidden" style="margin-top:14px;">
        <div class="h2">Admin</div>
        <div class="note">Exporta / importa backup completo y cambia usuarios.</div>

        <div class="h3">Backup</div>
        <div class="btnRow">
          <button class="btn ghost" id="btnBackupJson">üì¶ Backup JSON (todo)</button>
          <label class="btn ghost" style="cursor:pointer;">
            üì• Importar Backup JSON
            <input id="inpImportJson" type="file" accept="application/json" style="display:none;">
          </label>
        </div>

        <div class="h3">Esc√°ner (barcode/QR)</div>
        <div class="btnRow">
          <button class="btn blue" id="btnOpenScanner">üì∑ Abrir esc√°ner</button>
        </div>

        <div class="divider"></div>

        <div class="h3">Usuarios (Admin puede cambiar)</div>
        <div class="grid3">
          <input id="uAdmin" placeholder="Usuario Admin" />
          <input id="pAdmin" placeholder="Clave Admin" />
          <button class="btn blue" id="btnSaveUsers">üíæ Guardar credenciales</button>
        </div>
        <div class="grid3" style="margin-top:10px;">
          <input id="uVentas" placeholder="Usuario Ventas" />
          <input id="pVentas" placeholder="Clave Ventas" />
          <div></div>
        </div>
        <div class="grid3" style="margin-top:10px;">
          <input id="uTecnico" placeholder="Usuario T√©cnico" />
          <input id="pTecnico" placeholder="Clave T√©cnico" />
          <div></div>
        </div>

        <div class="note" style="margin-top:10px;">
          Tip: si olvidas claves, borra datos del navegador (localStorage) y se restauran por defecto.
        </div>
      </div>

    </section>
  </div>

  <!-- ===== MODAL LOGIN ===== -->
  <div id="loginModal" class="modalBackdrop">
    <div class="modal">
      <div class="modalClose" id="loginClose">‚úï</div>
      <div class="modalTitle">Acceso</div>
      <div class="note" style="margin-top:-6px;">Rol: <b id="loginRoleLabel">‚Äî</b></div>

      <div style="margin-top:12px;" class="grid2">
        <input id="loginUser" placeholder="Usuario" autocomplete="username"/>
        <input id="loginPass" placeholder="Contrase√±a" type="password" autocomplete="current-password"/>
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="btn blue" id="btnLogin">Entrar</button>
        <button class="btn ghost" id="btnBackHome">Volver</button>
      </div>

      <div class="note" style="margin-top:10px;">
        <b>Credenciales por defecto:</b><br/>
        Admin: <code>admin / admin123</code><br/>
        Ventas: <code>ventas / ventas123</code><br/>
        T√©cnico: <code>tecnico / tecnico123</code>
      </div>
    </div>
  </div>

  <!-- ===== MODAL SCANNER ===== -->
  <div id="scannerModal" class="modalBackdrop">
    <div class="modal" style="width:min(720px,100%);">
      <div class="modalClose" id="scanClose">‚úï</div>
      <div class="modalTitle">Esc√°ner (c√°mara)</div>

      <div class="scanWrap">
        <video id="scanVideo" autoplay playsinline></video>
        <div class="grid2">
          <button class="btn green" id="btnScanStart">‚ñ∂Ô∏è Iniciar</button>
          <button class="btn danger" id="btnScanStop">‚èπÔ∏è Detener</button>
        </div>

        <div class="grid2">
          <input id="scanResult" placeholder="Resultado del escaneo (se llena solo)" />
          <button class="btn blue" id="btnUseScanValue">Usar este c√≥digo</button>
        </div>

        <div class="note">
          ‚úÖ Lee muchos c√≥digos (EAN-13, CODE-128, QR, etc.) si tu navegador soporta <b>BarcodeDetector</b>.<br/>
          iPhone: puede ser limitado. Si no funciona, copia el c√≥digo manual.
        </div>
      </div>
    </div>
  </div>

  <datalist id="brandList"></datalist>

<script>
/* =========================
   STORAGE KEYS
========================= */
const LS = {
  users: "te_users_v1",
  roleSession: "te_session_v1",
  orders: "te_orders_v1",
  sales: "te_sales_v1",
  inv: "te_inventory_v1",
  orderCounter: "te_orderCounter_v1",
  saleCounter: "te_saleCounter_v1",
  brands: "te_brands_v1"
};

/* =========================
   DEFAULT USERS
========================= */
function getUsers(){
  const saved = JSON.parse(localStorage.getItem(LS.users) || "null");
  if(saved) return saved;
  const def = {
    admin:{ user:"admin", pass:"admin123" },
    ventas:{ user:"ventas", pass:"ventas123" },
    tecnico:{ user:"tecnico", pass:"tecnico123" }
  };
  localStorage.setItem(LS.users, JSON.stringify(def));
  return def;
}
function setUsers(u){ localStorage.setItem(LS.users, JSON.stringify(u)); }

/* =========================
   COUNTERS (ASC)
========================= */
function getOrderCounter(){
  const v = Number(localStorage.getItem(LS.orderCounter));
  if(!v || v < 2100){
    localStorage.setItem(LS.orderCounter, "2100");
    return 2100;
  }
  return v;
}
function setOrderCounter(n){ localStorage.setItem(LS.orderCounter, String(n)); }

function getSaleCounter(){
  const v = Number(localStorage.getItem(LS.saleCounter));
  if(!v || v < 315){
    localStorage.setItem(LS.saleCounter, "315");
    return 315;
  }
  return v;
}
function setSaleCounter(n){ localStorage.setItem(LS.saleCounter, String(n)); }

/* =========================
   DATA LOAD/SAVE
========================= */
const getArr = (k)=> JSON.parse(localStorage.getItem(k) || "[]");
const setArr = (k,a)=> localStorage.setItem(k, JSON.stringify(a));

/* =========================
   EMAIL SUGGESTIONS
========================= */
const emailDomains = ["gmail.com","hotmail.com","outlook.com","icloud.com","yahoo.com","live.com","proton.me","protonmail.com"];
function buildEmailDatalist(id){
  const dl = document.getElementById(id);
  dl.innerHTML = "";
  emailDomains.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = "@"+d;
    dl.appendChild(opt);
  });
}
buildEmailDatalist("emailDomains");
buildEmailDatalist("emailDomains2");

/* =========================
   BRAND AUTOCOMPLETE + LEARN
========================= */
const defaultBrands = [
  "Samsung","Xiaomi","Redmi","Realme","Huawei","Honor","Motorola","Nokia",
  "Apple","iPhone","iPad","Tecno","Infinix","Itel","OPPO","Vivo","OnePlus",
  "ZTE","Alcatel","Sony","LG","Google Pixel","Asus","Lenovo","TCL","Meizu",
  "BlackBerry","HTC","Micromax","Blu","Cubot","Doogee","Ulefone","Umidigi",
  "Nothing","Meitu","CAT","Fairphone","Sharp","Panasonic","Philips","Sagem",
  "Mobiwire","Lava","Karbonn","Coolpad","Hisense","Haier","Wiko","Poco"
];
function getBrands(){
  const learned = JSON.parse(localStorage.getItem(LS.brands) || "[]");
  const all = Array.from(new Set([...defaultBrands, ...learned]));
  all.sort((a,b)=> a.localeCompare(b,"es",{sensitivity:"base"}));
  return all;
}
function learnBrand(name){
  const clean = (name||"").trim();
  if(!clean) return;
  const allLower = getBrands().map(x=>x.toLowerCase());
  if(allLower.includes(clean.toLowerCase())) return;
  const learned = JSON.parse(localStorage.getItem(LS.brands) || "[]");
  learned.push(clean);
  localStorage.setItem(LS.brands, JSON.stringify(learned));
  buildBrandList();
}
function buildBrandList(){
  const dl = document.getElementById("brandList");
  dl.innerHTML = "";
  getBrands().forEach(b=>{
    const opt = document.createElement("option");
    opt.value = b;
    dl.appendChild(opt);
  });
}
buildBrandList();

/* =========================
   UI REFERENCES
========================= */
const screenHome = document.getElementById("screenHome");
const screenApp = document.getElementById("screenApp");

const loginModal = document.getElementById("loginModal");
const loginRoleLabel = document.getElementById("loginRoleLabel");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const btnLogin = document.getElementById("btnLogin");
const btnBackHome = document.getElementById("btnBackHome");
const loginClose = document.getElementById("loginClose");

const whoRole = document.getElementById("whoRole");
const whoUser = document.getElementById("whoUser");

const nextOrderNo = document.getElementById("nextOrderNo");
const nextSaleNo  = document.getElementById("nextSaleNo");

/* =========================
   ROLE + LOGIN FLOW
========================= */
let wantedRole = null;

document.querySelectorAll(".roleTile").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    wantedRole = btn.dataset.role;
    openLogin(wantedRole);
  });
});

function openLogin(role){
  loginRoleLabel.textContent = role.toUpperCase();
  loginUser.value = "";
  loginPass.value = "";
  loginModal.classList.add("show");
  setTimeout(()=> loginUser.focus(), 80);
}

function closeLogin(){
  loginModal.classList.remove("show");
}

loginClose.onclick = closeLogin;
btnBackHome.onclick = ()=>{
  closeLogin();
  wantedRole = null;
};

btnLogin.onclick = ()=>{
  const users = getUsers();
  const u = (loginUser.value||"").trim();
  const p = (loginPass.value||"").trim();
  if(!wantedRole){ alert("Selecciona un rol."); return; }
  if(u === users[wantedRole].user && p === users[wantedRole].pass){
    const session = { role:wantedRole, user:u, t:Date.now() };
    localStorage.setItem(LS.roleSession, JSON.stringify(session));
    closeLogin();
    enterApp(session);
  }else{
    alert("Usuario o contrase√±a incorrectos.");
  }
};

function getSession(){
  try{ return JSON.parse(localStorage.getItem(LS.roleSession) || "null"); }catch{ return null; }
}

function logout(){
  localStorage.removeItem(LS.roleSession);
  screenApp.classList.add("hidden");
  screenHome.classList.remove("hidden");
}

document.getElementById("btnLogout").onclick = logout;

/* =========================
   ENTER APP + PERMISSIONS
========================= */
function enterApp(session){
  screenHome.classList.add("hidden");
  screenApp.classList.remove("hidden");
  whoRole.textContent = session.role.toUpperCase();
  whoUser.textContent = session.user;

  // permissions:
  // admin: all
  // ventas: sales + inventory
  // tecnico: orders
  const role = session.role;
  document.querySelector('[data-screen="orders"]').classList.toggle("hidden", role==="ventas");
  document.querySelector('[data-screen="sales"]').classList.toggle("hidden", role==="tecnico");
  document.querySelector('[data-screen="inventory"]').classList.toggle("hidden", role==="tecnico");
  document.querySelector('[data-screen="admin"]').classList.toggle("hidden", role!=="admin");

  // default open screen
  if(role==="tecnico") showScreen("orders");
  else if(role==="ventas") showScreen("sales");
  else showScreen("orders");

  refreshCounters();
  renderAll();
  fillAdminUsers();
}

function refreshCounters(){
  nextOrderNo.textContent = String(getOrderCounter());
  nextSaleNo.textContent  = String(getSaleCounter());
}

/* tabs */
document.querySelectorAll(".tabBtn").forEach(b=>{
  b.addEventListener("click", ()=> showScreen(b.dataset.screen));
});

function showScreen(name){
  ["orders","sales","inventory","admin"].forEach(id=>{
    document.getElementById(id).classList.toggle("hidden", id!==name);
  });
  // update counters display as soon as open
  refreshCounters();
}

/* auto-enter if session exists */
const sess = getSession();
if(sess) enterApp(sess);

/* =========================
   SIGNATURE PAD (mandatory)
========================= */
const sigCanvas = document.getElementById("sigCanvas");
const sigCtx = sigCanvas.getContext("2d");
let drawing = false;
let hasSignature = false;

function resizeCanvas(){
  const rect = sigCanvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  sigCanvas.width = Math.floor(rect.width * dpr);
  sigCanvas.height = Math.floor(rect.height * dpr);
  sigCtx.scale(dpr, dpr);
  sigCtx.lineWidth = 3;
  sigCtx.lineCap = "round";
  sigCtx.strokeStyle = "#eaf2ff";
}
window.addEventListener("resize", ()=> { clearSignature(false); resizeCanvas(); });
setTimeout(resizeCanvas, 60);

function getPos(e){
  const r = sigCanvas.getBoundingClientRect();
  const t = (e.touches && e.touches[0]) ? e.touches[0] : e;
  return { x: t.clientX - r.left, y: t.clientY - r.top };
}

function startDraw(e){
  drawing = true;
  hasSignature = true;
  const p = getPos(e);
  sigCtx.beginPath();
  sigCtx.moveTo(p.x, p.y);
}
function moveDraw(e){
  if(!drawing) return;
  e.preventDefault();
  const p = getPos(e);
  sigCtx.lineTo(p.x, p.y);
  sigCtx.stroke();
}
function endDraw(){ drawing = false; }

sigCanvas.addEventListener("mousedown", startDraw);
sigCanvas.addEventListener("mousemove", moveDraw);
window.addEventListener("mouseup", endDraw);

sigCanvas.addEventListener("touchstart", startDraw, {passive:false});
sigCanvas.addEventListener("touchmove", moveDraw, {passive:false});
sigCanvas.addEventListener("touchend", endDraw);

function clearSignature(resetFlag=true){
  const rect = sigCanvas.getBoundingClientRect();
  sigCtx.clearRect(0,0,rect.width,rect.height);
  if(resetFlag) hasSignature=false;
}

document.getElementById("btnSigClear").onclick = ()=> clearSignature(true);

/* =========================
   ORDERS
========================= */
const oCliente = document.getElementById("oCliente");
const oCedula  = document.getElementById("oCedula");
const oTelefono= document.getElementById("oTelefono");
const oCorreo  = document.getElementById("oCorreo");
const oMarca   = document.getElementById("oMarca");
const oModelo  = document.getElementById("oModelo");
const oFalla   = document.getElementById("oFalla");
const ordersList = document.getElementById("ordersList");
const qOrders = document.getElementById("qOrders");

document.getElementById("btnOrderNew").onclick = ()=>{
  oCliente.value=""; oCedula.value=""; oTelefono.value=""; oCorreo.value="";
  oMarca.value=""; oModelo.value=""; oFalla.value="";
  clearSignature(true);
  oCliente.focus();
};

document.getElementById("btnOrderSave").onclick = ()=>{
  // required fields + signature
  if(!oCliente.value.trim() || !oCedula.value.trim() || !oTelefono.value.trim() || !oCorreo.value.trim()
     || !oMarca.value.trim() || !oModelo.value.trim() || !oFalla.value.trim()){
    alert("Completa todos los campos de la orden.");
    return;
  }
  if(!hasSignature){
    alert("La firma es obligatoria para guardar la orden.");
    return;
  }

  learnBrand(oMarca.value);

  const no = getOrderCounter();
  const sigData = sigCanvas.toDataURL("image/png");

  const order = {
    no,
    cliente: oCliente.value.trim(),
    cedula: oCedula.value.trim(),
    telefono: oTelefono.value.trim(),
    correo: oCorreo.value.trim(),
    marca: oMarca.value.trim(),
    modelo: oModelo.value.trim(),
    falla: oFalla.value.trim(),
    firma: sigData,
    fecha: new Date().toISOString()
  };

  const arr = getArr(LS.orders);
  arr.push(order);
  arr.sort((a,b)=> a.no - b.no);
  setArr(LS.orders, arr);

  setOrderCounter(no + 1);
  refreshCounters();
  renderOrders();

  alert("Orden guardada: #" + no);
  document.getElementById("btnOrderNew").click();
};

qOrders.addEventListener("input", renderOrders);

document.getElementById("btnOrdersClear").onclick = ()=>{
  if(!confirm("¬øBorrar TODAS las √≥rdenes?")) return;
  localStorage.removeItem(LS.orders);
  localStorage.setItem(LS.orderCounter, "2100");
  refreshCounters();
  renderOrders();
};

document.getElementById("btnOrdersCsv").onclick = ()=>{
  const arr = getArr(LS.orders);
  const rows = [
    ["no","cliente","cedula","telefono","correo","marca","modelo","falla","fecha"]
  ];
  arr.forEach(o=>{
    rows.push([o.no,o.cliente,o.cedula,o.telefono,o.correo,o.marca,o.modelo,o.falla,o.fecha]);
  });
  downloadCSV("ordenes.csv", rows);
};

function renderOrders(){
  const arr = getArr(LS.orders);
  const q = (qOrders.value||"").trim().toLowerCase();
  const filtered = !q ? arr : arr.filter(o=>{
    const s = `${o.no} ${o.cliente} ${o.cedula} ${o.telefono} ${o.correo} ${o.marca} ${o.modelo} ${o.falla}`.toLowerCase();
    return s.includes(q);
  });

  ordersList.innerHTML = "";
  filtered.forEach(o=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">Orden #${o.no}</div>
          <div class="itemMeta">${fmtDate(o.fecha)}</div>
        </div>
        <div class="btnRow">
          <button class="btn small danger" data-del="${o.no}">üóëÔ∏è</button>
        </div>
      </div>
      <div class="kv">
        <span><b>Cliente:</b> ${esc(o.cliente)}</span>
        <span><b>C√©dula:</b> ${esc(o.cedula)}</span>
        <span><b>Tel:</b> ${esc(o.telefono)} | <b>Email:</b> ${esc(o.correo)}</span>
        <span><b>Equipo:</b> ${esc(o.marca)} ${esc(o.modelo)}</span>
        <span><b>Falla:</b> ${esc(o.falla)}</span>
        <div style="margin-top:8px;">
          <b>Firma:</b><br/>
          <img src="${o.firma}" alt="firma" style="max-width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.14); margin-top:6px;">
        </div>
      </div>
    `;
    div.querySelector("[data-del]").onclick = ()=>{
      if(!confirm("¬øBorrar la orden #" + o.no + "?")) return;
      const a = getArr(LS.orders).filter(x=> x.no !== o.no);
      setArr(LS.orders, a);
      renderOrders();
    };
    ordersList.appendChild(div);
  });
}

/* =========================
   SALES
========================= */
const sCliente = document.getElementById("sCliente");
const sCedula  = document.getElementById("sCedula");
const sTelefono= document.getElementById("sTelefono");
const sCorreo  = document.getElementById("sCorreo");
const sProducto= document.getElementById("sProducto");
const sPrecio  = document.getElementById("sPrecio");
const sImei1   = document.getElementById("sImei1");
const sImei2   = document.getElementById("sImei2");
const sTerminos= document.getElementById("sTerminos");
const salesList= document.getElementById("salesList");
const qSales   = document.getElementById("qSales");

document.getElementById("btnSaleNew").onclick = ()=>{
  sCliente.value=""; sCedula.value=""; sTelefono.value=""; sCorreo.value="";
  sProducto.value=""; sPrecio.value=""; sImei1.value=""; sImei2.value="";
  sTerminos.checked=false;
  sCliente.focus();
};

document.getElementById("btnSaleSave").onclick = ()=>{
  if(!sCliente.value.trim() || !sCedula.value.trim() || !sTelefono.value.trim() || !sCorreo.value.trim()
     || !sProducto.value.trim() || !sPrecio.value.trim()){
    alert("Completa todos los campos de la venta.");
    return;
  }
  if(!sTerminos.checked){
    alert("Debes aceptar los t√©rminos y condiciones (obligatorio).");
    return;
  }

  const no = getSaleCounter();
  const sale = {
    no,
    cliente: sCliente.value.trim(),
    cedula: sCedula.value.trim(),
    telefono: sTelefono.value.trim(),
    correo: sCorreo.value.trim(),
    producto: sProducto.value.trim(),
    precio: sPrecio.value.trim(),
    imei1: sImei1.value.trim(),
    imei2: sImei2.value.trim(),
    terminos: true,
    fecha: new Date().toISOString()
  };

  const arr = getArr(LS.sales);
  arr.push(sale);
  arr.sort((a,b)=> a.no - b.no);
  setArr(LS.sales, arr);

  setSaleCounter(no + 1);
  refreshCounters();
  renderSales();

  alert("Venta guardada: #" + no);
  document.getElementById("btnSaleNew").click();
};

qSales.addEventListener("input", renderSales);

document.getElementById("btnSalesClear").onclick = ()=>{
  if(!confirm("¬øBorrar TODAS las ventas?")) return;
  localStorage.removeItem(LS.sales);
  localStorage.setItem(LS.saleCounter, "315");
  refreshCounters();
  renderSales();
};

document.getElementById("btnSalesCsv").onclick = ()=>{
  const arr = getArr(LS.sales);
  const rows = [
    ["no","cliente","cedula","telefono","correo","producto","precio","imei1","imei2","terminos","fecha"]
  ];
  arr.forEach(s=>{
    rows.push([s.no,s.cliente,s.cedula,s.telefono,s.correo,s.producto,s.precio,s.imei1,s.imei2,"SI",s.fecha]);
  });
  downloadCSV("ventas.csv", rows);
};

function renderSales(){
  const arr = getArr(LS.sales);
  const q = (qSales.value||"").trim().toLowerCase();
  const filtered = !q ? arr : arr.filter(s=>{
    const ss = `${s.no} ${s.cliente} ${s.cedula} ${s.telefono} ${s.correo} ${s.producto} ${s.imei1} ${s.imei2}`.toLowerCase();
    return ss.includes(q);
  });

  salesList.innerHTML = "";
  filtered.forEach(s=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">Venta #${s.no}</div>
          <div class="itemMeta">${fmtDate(s.fecha)}</div>
        </div>
        <div class="btnRow">
          <button class="btn small danger" data-del="${s.no}">üóëÔ∏è</button>
        </div>
      </div>
      <div class="kv">
        <span><b>Cliente:</b> ${esc(s.cliente)} | <b>C√©dula:</b> ${esc(s.cedula)}</span>
        <span><b>Tel:</b> ${esc(s.telefono)} | <b>Email:</b> ${esc(s.correo)}</span>
        <span><b>Producto:</b> ${esc(s.producto)}</span>
        <span><b>Precio:</b> ${esc(s.precio)}</span>
        <span><b>IMEI1:</b> ${esc(s.imei1 || "‚Äî")} | <b>IMEI2:</b> ${esc(s.imei2 || "‚Äî")}</span>
        <span><b>T√©rminos:</b> SI</span>
      </div>
    `;
    div.querySelector("[data-del]").onclick = ()=>{
      if(!confirm("¬øBorrar la venta #" + s.no + "?")) return;
      const a = getArr(LS.sales).filter(x=> x.no !== s.no);
      setArr(LS.sales, a);
      renderSales();
    };
    salesList.appendChild(div);
  });
}

/* =========================
   INVENTORY
========================= */
const iCode = document.getElementById("iCode");
const iNombre = document.getElementById("iNombre");
const iMarca = document.getElementById("iMarca");
const iCosto = document.getElementById("iCosto");
const iPrecio = document.getElementById("iPrecio");
const iQty = document.getElementById("iQty");
const iFoto = document.getElementById("iFoto");
const invList = document.getElementById("invList");
const qInv = document.getElementById("qInv");

document.getElementById("btnInvNew").onclick = ()=>{
  iCode.value=""; iNombre.value=""; iMarca.value="";
  iCosto.value=""; iPrecio.value=""; iQty.value="";
  iFoto.value="";
  iCode.focus();
};

document.getElementById("btnInvSave").onclick = async ()=>{
  if(!iCode.value.trim() || !iNombre.value.trim() || !iMarca.value.trim()){
    alert("C√≥digo, Nombre y Marca son obligatorios.");
    return;
  }
  learnBrand(iMarca.value);

  // foto opcional
  let photoData = "";
  if(iFoto.files && iFoto.files[0]){
    photoData = await fileToDataURL(iFoto.files[0]);
  }

  const item = {
    code: iCode.value.trim(),
    nombre: iNombre.value.trim(),
    marca: iMarca.value.trim(),
    costo: iCosto.value.trim(),
    precio: iPrecio.value.trim(),
    qty: iQty.value.trim(),
    foto: photoData,
    updatedAt: new Date().toISOString()
  };

  const arr = getArr(LS.inv);
  // si existe por code, reemplaza
  const idx = arr.findIndex(x=> x.code === item.code);
  if(idx >= 0) arr[idx] = item;
  else arr.push(item);

  arr.sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||"","es",{sensitivity:"base"}));
  setArr(LS.inv, arr);
  renderInv();
  alert("Inventario guardado.");
  document.getElementById("btnInvNew").click();
};

qInv.addEventListener("input", renderInv);

document.getElementById("btnInvClear").onclick = ()=>{
  if(!confirm("¬øBorrar TODO el inventario?")) return;
  localStorage.removeItem(LS.inv);
  renderInv();
};

document.getElementById("btnInvCsv").onclick = ()=>{
  const arr = getArr(LS.inv);
  const rows = [["code","nombre","marca","costo","precio","qty","updatedAt"]];
  arr.forEach(i=>{
    rows.push([i.code,i.nombre,i.marca,i.costo,i.precio,i.qty,i.updatedAt]);
  });
  downloadCSV("inventario.csv", rows);
};

function renderInv(){
  const arr = getArr(LS.inv);
  const q = (qInv.value||"").trim().toLowerCase();
  const filtered = !q ? arr : arr.filter(i=>{
    const s = `${i.code} ${i.nombre} ${i.marca}`.toLowerCase();
    return s.includes(q);
  });

  invList.innerHTML = "";
  filtered.forEach(i=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">${esc(i.nombre)}</div>
          <div class="itemMeta">C√≥digo: ${esc(i.code)} ‚Ä¢ ${esc(i.marca)} ‚Ä¢ ${fmtDate(i.updatedAt)}</div>
        </div>
        <div class="btnRow">
          <button class="btn small ghost" data-edit="${esc(i.code)}">‚úèÔ∏è</button>
          <button class="btn small danger" data-del="${esc(i.code)}">üóëÔ∏è</button>
        </div>
      </div>
      <div class="kv">
        <span><b>Costo:</b> ${esc(i.costo||"‚Äî")} | <b>Precio:</b> ${esc(i.precio||"‚Äî")} | <b>Cant:</b> ${esc(i.qty||"‚Äî")}</span>
        ${i.foto ? `<img src="${i.foto}" alt="foto" style="max-width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.14); margin-top:8px;">` : ""}
      </div>
    `;
    div.querySelector("[data-del]").onclick = ()=>{
      if(!confirm("¬øBorrar producto " + i.code + "?")) return;
      const a = getArr(LS.inv).filter(x=> x.code !== i.code);
      setArr(LS.inv, a);
      renderInv();
    };
    div.querySelector("[data-edit]").onclick = ()=>{
      iCode.value = i.code;
      iNombre.value = i.nombre;
      iMarca.value = i.marca;
      iCosto.value = i.costo || "";
      iPrecio.value = i.precio || "";
      iQty.value = i.qty || "";
      iFoto.value = "";
      showScreen("inventory");
      iNombre.focus();
    };
    invList.appendChild(div);
  });
}

/* =========================
   ADMIN: BACKUP + USERS
========================= */
document.getElementById("btnBackupJson").onclick = ()=>{
  const data = {
    users: getUsers(),
    orderCounter: getOrderCounter(),
    saleCounter: getSaleCounter(),
    orders: getArr(LS.orders),
    sales: getArr(LS.sales),
    inventory: getArr(LS.inv),
    brands: JSON.parse(localStorage.getItem(LS.brands) || "[]"),
    exportedAt: new Date().toISOString()
  };
  downloadJSON("backup_technology_experts.json", data);
};

document.getElementById("inpImportJson").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);

    if(data.users) setUsers(data.users);
    if(data.orderCounter) localStorage.setItem(LS.orderCounter, String(data.orderCounter));
    if(data.saleCounter) localStorage.setItem(LS.saleCounter, String(data.saleCounter));
    if(Array.isArray(data.orders)) setArr(LS.orders, data.orders);
    if(Array.isArray(data.sales)) setArr(LS.sales, data.sales);
    if(Array.isArray(data.inventory)) setArr(LS.inv, data.inventory);
    if(Array.isArray(data.brands)) localStorage.setItem(LS.brands, JSON.stringify(data.brands));

    alert("Backup importado. Recarga la p√°gina.");
    location.reload();
  }catch(err){
    console.error(err);
    alert("No se pudo importar el JSON.");
  }finally{
    e.target.value = "";
  }
});

function fillAdminUsers(){
  const u = getUsers();
  document.getElementById("uAdmin").value = u.admin.user;
  document.getElementById("pAdmin").value = u.admin.pass;
  document.getElementById("uVentas").value = u.ventas.user;
  document.getElementById("pVentas").value = u.ventas.pass;
  document.getElementById("uTecnico").value = u.tecnico.user;
  document.getElementById("pTecnico").value = u.tecnico.pass;
}

document.getElementById("btnSaveUsers").onclick = ()=>{
  const session = getSession();
  if(!session || session.role!=="admin"){
    alert("Solo ADMIN puede cambiar usuarios.");
    return;
  }
  const users = {
    admin:{ user: document.getElementById("uAdmin").value.trim(), pass: document.getElementById("pAdmin").value.trim() },
    ventas:{ user: document.getElementById("uVentas").value.trim(), pass: document.getElementById("pVentas").value.trim() },
    tecnico:{ user: document.getElementById("uTecnico").value.trim(), pass: document.getElementById("pTecnico").value.trim() }
  };
  if(!users.admin.user || !users.admin.pass || !users.ventas.user || !users.ventas.pass || !users.tecnico.user || !users.tecnico.pass){
    alert("No dejes campos vac√≠os.");
    return;
  }
  setUsers(users);
  alert("Credenciales guardadas.");
};

/* =========================
   SCANNER (BarcodeDetector)
========================= */
const scannerModal = document.getElementById("scannerModal");
const scanVideo = document.getElementById("scanVideo");
const scanResult = document.getElementById("scanResult");

let scanStream = null;
let scanning = false;
let barcodeDetector = null;
let scanTargetInput = null; // input to fill on "Usar este c√≥digo"

document.getElementById("btnOpenScanner").onclick = ()=> openScanner(null);
document.getElementById("btnScanToInventory").onclick = ()=> openScanner(iCode);

document.getElementById("scanClose").onclick = closeScanner;
document.getElementById("btnScanStart").onclick = startScan;
document.getElementById("btnScanStop").onclick = stopScan;

document.getElementById("btnUseScanValue").onclick = ()=>{
  const v = (scanResult.value||"").trim();
  if(!v){ alert("No hay resultado."); return; }
  if(scanTargetInput){
    scanTargetInput.value = v;
    if(scanTargetInput === iCode) iNombre.focus();
  }
  closeScanner();
};

function openScanner(targetInput){
  scanTargetInput = targetInput;
  scanResult.value = "";
  scannerModal.classList.add("show");

  // init detector
  if("BarcodeDetector" in window){
    try{
      barcodeDetector = new BarcodeDetector({
        formats: [
          "qr_code","ean_13","ean_8","code_128","code_39","codabar","upc_a","upc_e","itf"
        ]
      });
    }catch(e){
      barcodeDetector = null;
    }
  }else{
    barcodeDetector = null;
  }

  if(!barcodeDetector){
    alert("Tu navegador no soporta el lector. Usa Chrome/Android o PC Chrome. (iPhone puede ser limitado).");
  }
}

function closeScanner(){
  stopScan();
  scannerModal.classList.remove("show");
  scanTargetInput = null;
}

async function startScan(){
  if(scanning) return;

  if(!barcodeDetector){
    alert("No carg√≥ el lector. Revisa navegador (BarcodeDetector).");
    return;
  }

  try{
    scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    scanVideo.srcObject = scanStream;
    scanning = true;
    tickScan();
  }catch(err){
    console.error(err);
    alert("No se pudo abrir la c√°mara. Revisa permisos.");
  }
}

function stopScan(){
  scanning = false;
  if(scanStream){
    scanStream.getTracks().forEach(t=> t.stop());
    scanStream = null;
  }
  scanVideo.srcObject = null;
}

async function tickScan(){
  if(!scanning) return;

  try{
    const barcodes = await barcodeDetector.detect(scanVideo);
    if(barcodes && barcodes.length){
      const v = barcodes[0].rawValue || "";
      if(v){
        scanResult.value = v;
        // auto stop after first detection
        stopScan();
        return;
      }
    }
  }catch(err){
    // ignore occasional errors
  }
  requestAnimationFrame(tickScan);
}

/* =========================
   EXPORT HELPERS
========================= */
function downloadCSV(filename, rows){
  const escCSV = (v)=>{
    const s = String(v ?? "");
    if(s.includes('"') || s.includes(",") || s.includes("\n")) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const csv = rows.map(r=> r.map(escCSV).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function fmtDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("es-CO");
  }catch{ return iso; }
}

function renderAll(){
  renderOrders();
  renderSales();
  renderInv();
}

/* =========================
   FILE TO DATAURL (photo)
========================= */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(String(r.result||""));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Technology Expert's - Orden de Servicio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: Arial, sans-serif; padding: 16px; background:#fff; }
    h1 { margin-bottom: 6px; }
    h2 { margin-top: 18px; }
    .muted { color:#666; font-size:13px; }

    input, textarea, button {
      width:100%; padding:12px; margin:8px 0;
      font-size:16px; border-radius:12px;
      border:1px solid #d8d8d8; box-sizing:border-box;
    }
    textarea { min-height:90px; resize:vertical; }

    button { border:none; font-weight:bold; }
    .btn-primary { background:#000; color:#fff; }
    .btn-secondary { background:#666; color:#fff; }
    .btn-danger { background:#b00020; color:#fff; }

    .card { border:1px solid #e5e5e5; border-radius:14px; padding:14px; margin-top:12px; }

    /* Firma */
    .firma-wrap { border:1px dashed #bdbdbd; border-radius:14px; padding:10px; background:#fafafa; }
    canvas {
      width:100%; height:180px; background:#fff;
      border-radius:12px; border:1px solid #ddd;
      touch-action:none;
      display:block;
    }

    .row { display:flex; gap:10px; }
    .row button { width:50%; }

    .orden { border:1px solid #ddd; border-radius:12px; padding:10px; margin-top:10px; }
    .orden small { color:#666; }
    .orden-actions { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .orden-actions button { width:auto; padding:10px 12px; border-radius:12px; }

    @media (max-width: 520px){
      .row { flex-direction: column; }
      .row button { width:100%; }
    }
  </style>
</head>

<body>
  <h1>Technology Expert's</h1>
  <div class="muted">Orden de servicio ‚Äì funciona en celular, tablet y PC (por ahora guardado local)</div>

  <div class="card">
    <h2>Datos del cliente</h2>

    <input id="cliente" placeholder="Nombre del cliente" autocomplete="name">
    <input id="cedula" placeholder="C√©dula" inputmode="numeric">
    <input id="telefono" placeholder="Celular" inputmode="tel" autocomplete="tel">

    <!-- CORREO CON AUTOCOMPLETADO + APRENDE DOMINIOS -->
    <input id="correo" type="email" placeholder="Correo electr√≥nico"
           autocomplete="off" list="correoSugerencias">
    <datalist id="correoSugerencias"></datalist>

    <h2>Equipo</h2>

    <!-- MARCA AUTOCOMPLETABLE + APRENDE -->
    <input id="marca" placeholder="Marca del celular" list="listaMarcas">

    <!-- MODELO: sugerencias DEPENDEN de la marca -->
    <input id="modelo" placeholder="Modelo del celular" list="listaModelos">

    <textarea id="falla" placeholder="Falla reportada"></textarea>

    <h2>Firma del cliente (obligatoria)</h2>
    <div class="firma-wrap">
      <div class="muted">Firma con el dedo o mouse. Sin firma NO se guarda.</div>
      <canvas id="firma"></canvas>

      <div class="row">
        <button class="btn-secondary" onclick="borrarFirma()">üßΩ Borrar firma</button>
        <button class="btn-primary" onclick="guardarOrden()">üíæ Guardar orden</button>
      </div>
    </div>

    <button class="btn-secondary" onclick="nuevaOrden()">üÜï Nueva orden</button>
  </div>

  <div class="card">
    <h2>√ìrdenes guardadas</h2>
    <div id="lista"></div>
  </div>

  <!-- DATALIST -->
  <datalist id="listaMarcas"></datalist>
  <datalist id="listaModelos"></datalist>

<script>
/* ================== STORAGE ================== */
let ordenes = JSON.parse(localStorage.getItem("ordenes")) || [];
let consecutivo = Number(localStorage.getItem("consecutivo")) || 2100;

/* ================== FIRMA (POINTER EVENTS) ================== */
const canvas = document.getElementById("firma");
const ctx = canvas.getContext("2d");
let firmando = false;
let hayFirma = false;

function ajustarCanvas() {
  const r = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(r.width * dpr);
  canvas.height = Math.floor(r.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.strokeStyle = "#111";
}
window.addEventListener("load", () => { ajustarCanvas(); mostrar(); });
window.addEventListener("resize", ajustarCanvas);

function getPos(e){
  const r = canvas.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

canvas.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  firmando = true;
  hayFirma = true;
  const p = getPos(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
}, {passive:false});

canvas.addEventListener("pointermove", (e) => {
  if(!firmando) return;
  e.preventDefault();
  const p = getPos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
}, {passive:false});

function pararFirma(e){
  if(!firmando) return;
  e.preventDefault();
  firmando = false;
}
canvas.addEventListener("pointerup", pararFirma, {passive:false});
canvas.addEventListener("pointercancel", pararFirma, {passive:false});
canvas.addEventListener("pointerleave", pararFirma, {passive:false});

function borrarFirma() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  hayFirma = false;
}

/* ================== AUTOCOMPLETAR CORREO (GMAIL/HOTMAIL) + APRENDE ================== */
const K_DOMINIOS = "te_dominios_correo";
const DOMINIOS_BASE = ["gmail.com", "hotmail.com"]; // SOLO estos al inicio

function cargar(key){
  try { return JSON.parse(localStorage.getItem(key)) || []; }
  catch { return []; }
}
function guardar(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

function unicosLower(arr){
  const map = new Map();
  for(const x of arr){
    const v = String(x||"").trim().toLowerCase();
    if(!v) continue;
    map.set(v, v);
  }
  return Array.from(map.values()).sort();
}

function dominiosCorreoActuales(){
  const aprendidos = cargar(K_DOMINIOS);
  return unicosLower([...DOMINIOS_BASE, ...aprendidos]);
}

function aprenderDominioCorreo(email){
  const v = String(email||"").trim().toLowerCase();
  if(!v.includes("@")) return;
  const parts = v.split("@");
  if(parts.length < 2) return;
  const dom = parts[1].trim();
  if(!dom) return;

  const actuales = dominiosCorreoActuales();
  if(actuales.includes(dom)) return;

  const aprendidos = cargar(K_DOMINIOS);
  guardar(K_DOMINIOS, unicosLower([...aprendidos, dom]));
}

const correoInput = document.getElementById("correo");
const correoList = document.getElementById("correoSugerencias");

correoInput.addEventListener("input", () => {
  correoList.innerHTML = "";
  const v = correoInput.value.trim();
  if (!v) return;

  const parts = v.split("@");
  const user = parts[0] || "";
  const domParcial = (parts[1] || "").toLowerCase();
  if(!user) return;

  const dominios = dominiosCorreoActuales();
  for(const d of dominios){
    if(parts.length === 1){
      const o = document.createElement("option");
      o.value = `${user}@${d}`;
      correoList.appendChild(o);
    } else {
      if(d.startsWith(domParcial)){
        const o = document.createElement("option");
        o.value = `${user}@${d}`;
        correoList.appendChild(o);
      }
    }
  }
});

correoInput.addEventListener("blur", () => {
  aprenderDominioCorreo(correoInput.value);
});

/* ================== MARCAS (MUCHAS) + APRENDE ================== */
const K_MARCAS = "te_marcas";

// Lista GRANDE de marcas (celulares + algunas tablets)
const MARCAS_BASE = [
  "Samsung","Apple","iPhone","iPad","Xiaomi","Redmi","POCO","Mi",
  "Motorola","Huawei","Honor","Oppo","Vivo","Realme","OnePlus","Google Pixel",
  "Nokia","Sony","LG","ZTE","Alcatel","TCL","Asus","Lenovo","HTC",
  "Meizu","BlackBerry","Nothing","Tecno","Infinix","Itel","Sharp",
  "Panasonic","Philips","Micromax","Lava","Karbonn","Gionee","Coolpad",
  "Doogee","Ulefone","Cubot","Oukitel","Umidigi","Vernee","LeEco",
  "Wiko","Blu","Cat","Energizer","Fairphone","Kyocera","HMD",
  "Innjoo","Cherry Mobile","Celkon","Symphony","Xolo","QMobile",
  "T-Mobile","Vodafone","Orange","Nubia","ROG Phone","Zenfone"
];

// Para modelos por marca:
const K_MODELOS_POR_MARCA = "te_modelos_por_marca"; // objeto { "samsung": ["A12","A14"]... }

function normalizarClave(s){
  return String(s||"").trim().toLowerCase();
}

function unicosManteniendoCase(arr){
  const map = new Map();
  for(const x of arr){
    const clean = String(x||"").trim();
    if(!clean) continue;
    map.set(normalizarClave(clean), clean);
  }
  return Array.from(map.values()).sort((a,b)=>a.localeCompare(b));
}

function refrescarMarcas(){
  const aprendidas = cargar(K_MARCAS);
  const marcas = unicosManteniendoCase([...MARCAS_BASE, ...aprendidas]);

  document.getElementById("listaMarcas").innerHTML =
    marcas.map(m=>`<option value="${escapeAttr(m)}">`).join("");
}

function aprenderMarca(marca){
  const m = String(marca||"").trim();
  if(!m) return;
  const actuales = cargar(K_MARCAS);
  guardar(K_MARCAS, unicosManteniendoCase([...actuales, m]));
  refrescarMarcas();
}

/* ================== MODELOS POR MARCA (DEPENDE DE MARCA) ================== */
function cargarModelosPorMarca(){
  try { return JSON.parse(localStorage.getItem(K_MODELOS_POR_MARCA)) || {}; }
  catch { return {}; }
}
function guardarModelosPorMarca(obj){
  localStorage.setItem(K_MODELOS_POR_MARCA, JSON.stringify(obj));
}

function obtenerModelosDeMarca(marca){
  const key = normalizarClave(marca);
  const obj = cargarModelosPorMarca();
  const arr = Array.isArray(obj[key]) ? obj[key] : [];
  return unicosManteniendoCase(arr);
}

function refrescarModelosParaMarca(marcaActual){
  const modelos = obtenerModelosDeMarca(marcaActual);
  document.getElementById("listaModelos").innerHTML =
    modelos.map(m=>`<option value="${escapeAttr(m)}">`).join("");
}

function aprenderModeloParaMarca(marca, modelo){
  const m = String(marca||"").trim();
  const mo = String(modelo||"").trim();
  if(!m || !mo) return;

  const key = normalizarClave(m);
  const obj = cargarModelosPorMarca();
  const arr = Array.isArray(obj[key]) ? obj[key] : [];
  obj[key] = unicosManteniendoCase([...arr, mo]);
  guardarModelosPorMarca(obj);
}

refrescarMarcas();
// Por defecto: sin marca, lista modelos vac√≠a
refrescarModelosParaMarca("");

/* Cuando cambie la marca, actualiza la lista de modelos */
const marcaEl = document.getElementById("marca");
const modeloEl = document.getElementById("modelo");

marcaEl.addEventListener("input", () => {
  refrescarModelosParaMarca(marcaEl.value);
});

/* ================== APP ================== */
const clienteEl = document.getElementById("cliente");
const cedulaEl = document.getElementById("cedula");
const telefonoEl = document.getElementById("telefono");
const correoEl = document.getElementById("correo");
const fallaEl = document.getElementById("falla");
const lista = document.getElementById("lista");

function guardarOrden(){
  const cliente = clienteEl.value.trim();
  const cedula = cedulaEl.value.trim();
  const telefono = telefonoEl.value.trim();
  const correo = correoEl.value.trim();
  const marca = marcaEl.value.trim();
  const modelo = modeloEl.value.trim();
  const falla = fallaEl.value.trim();

  if (!cliente || !cedula || !telefono || !correo || !marca || !modelo || !falla) {
    alert("Completa todos los campos");
    return;
  }
  if (!hayFirma) {
    alert("La firma es obligatoria");
    return;
  }

  // Aprende: marca, modelo para esa marca, y dominio de correo
  aprenderMarca(marca);
  aprenderModeloParaMarca(marca, modelo);
  aprenderDominioCorreo(correo);

  // refresca modelos por si justo aprendi√≥ uno nuevo
  refrescarModelosParaMarca(marca);

  ordenes.push({
    numero: consecutivo++,
    cliente, cedula, telefono, correo,
    marca, modelo, falla,
    fecha: new Date().toLocaleString()
  });

  localStorage.setItem("ordenes", JSON.stringify(ordenes));
  localStorage.setItem("consecutivo", String(consecutivo));
  mostrar();
  nuevaOrden();
  alert("Orden guardada ‚úÖ");
}

function nuevaOrden(){
  clienteEl.value = "";
  cedulaEl.value = "";
  telefonoEl.value = "";
  correoEl.value = "";
  marcaEl.value = "";
  modeloEl.value = "";
  fallaEl.value = "";
  borrarFirma();
  refrescarModelosParaMarca("");
  clienteEl.focus();
}

function eliminarOrden(numero){
  if(!confirm("¬øBorrar la orden #" + numero + "?")) return;
  ordenes = ordenes.filter(o => o.numero !== numero);
  localStorage.setItem("ordenes", JSON.stringify(ordenes));
  mostrar();
}

function mostrar(){
  if(!ordenes.length){
    lista.innerHTML = `<div class="muted">No hay √≥rdenes guardadas.</div>`;
    return;
  }

  const sorted = [...ordenes].sort((a,b)=>a.numero-b.numero);
  lista.innerHTML = sorted.map(o=>`
    <div class="orden">
      <b>Orden #${o.numero}</b><br>
      <b>Cliente:</b> ${escapeHtml(o.cliente)}<br>
      <b>C√©dula:</b> ${escapeHtml(o.cedula)}<br>
      <b>Tel:</b> ${escapeHtml(o.telefono)}<br>
      <b>Email:</b> ${escapeHtml(o.correo)}<br><br>
      <b>Equipo:</b> ${escapeHtml(o.marca)} ${escapeHtml(o.modelo)}<br>
      <b>Falla:</b> ${escapeHtml(o.falla)}<br>
      <small>${escapeHtml(o.fecha)}</small>

      <div class="orden-actions">
        <button class="btn-danger" onclick="eliminarOrden(${o.numero})">üóëÔ∏è Eliminar</button>
      </div>
    </div>
  `).join("");
}

/* ================== ESCAPE ================== */
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function escapeAttr(s){
  return String(s||"").replace(/"/g, "&quot;");
}
</script>
</body>
</html>

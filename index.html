<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Technology Expert's</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#061a4a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{
      --bgA:#06123a;
      --bgB:#071f63;

      --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);

      --blue:#37B8FF;
      --purple:#A855FF;
      --green:#2CFFC6;
      --danger:#ff5b5b;

      --text:#EAF2FF;
      --muted:rgba(234,242,255,.72);

      --radius:22px;
      --radius2:16px;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 12px 40px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(55,184,255,.12), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, rgba(168,85,255,.10), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(44,255,198,.10), transparent 55%),
        linear-gradient(180deg, var(--bgA), var(--bgB));
      overflow-x:hidden;
    }

    .screen{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:calc(24px + env(safe-area-inset-top)) 24px 24px;
    }
    .hidden{display:none !important}

    .glass{
      width:min(980px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      border-radius:28px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      padding:22px;
    }

    .hero{
      padding:26px;
      position:relative;
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(500px 350px at 15% 15%, rgba(55,184,255,.18), transparent 60%),
        radial-gradient(500px 350px at 85% 25%, rgba(168,85,255,.14), transparent 60%),
        radial-gradient(520px 420px at 55% 90%, rgba(44,255,198,.12), transparent 60%);
      filter: blur(8px);
      opacity:.9;
      pointer-events:none;
    }
    .hero > *{position:relative}

    h1{
      margin:0 0 6px 0;
      font-size: clamp(34px, 6vw, 64px);
      font-weight: 950;
      letter-spacing:.2px;
      line-height:1.05;
      text-shadow: 0 16px 60px rgba(0,0,0,.55);
    }

    .subtitle{
      margin:0 0 18px 0;
      font-size: clamp(14px, 1.8vw, 18px);
      color:var(--muted);
      font-weight:700;
    }

    /* ===== LOGIN TILES (ne√≥n) ===== */
    .roleGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:18px;
      margin-top:14px;
    }
    .tile{
      appearance:none;
      border:0;
      padding:0;
      background:transparent;
      cursor:pointer;
      text-align:left;
    }
    .tileBorder{
      border-radius: var(--radius);
      padding:18px;
      background:
        radial-gradient(120% 90% at 50% 0%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.62), rgba(0,0,0,.22));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      min-height:160px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .tile:active .tileBorder{ transform: scale(.99); }
    .tile:hover .tileBorder{ transform: translateY(-1px); }

    .tile.admin{ --glow: var(--blue); }
    .tile.ventas{ --glow: var(--purple); }
    .tile.tecnico{ --glow: var(--green); }

    .tile.admin .tileBorder{
      border:2px solid rgba(55,184,255,.72);
      box-shadow: 0 0 26px rgba(55,184,255,.35), inset 0 0 22px rgba(55,184,255,.12), var(--shadow2);
    }
    .tile.ventas .tileBorder{
      border:2px solid rgba(168,85,255,.72);
      box-shadow: 0 0 26px rgba(168,85,255,.35), inset 0 0 22px rgba(168,85,255,.12), var(--shadow2);
    }
    .tile.tecnico .tileBorder{
      border:2px solid rgba(44,255,198,.72);
      box-shadow: 0 0 26px rgba(44,255,198,.30), inset 0 0 22px rgba(44,255,198,.10), var(--shadow2);
    }

    .iconWrap{
      width:78px;
      height:78px;
      border-radius:18px;
      background: rgba(0,0,0,.34);
      border:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        0 10px 30px rgba(0,0,0,.45);
    }
    .iconWrap svg{
      width:42px; height:42px;
      color: var(--glow);
      filter: drop-shadow(0 0 8px var(--glow)) drop-shadow(0 0 18px var(--glow));
    }
    .iconWrap svg path, .iconWrap svg line, .iconWrap svg polyline, .iconWrap svg circle{
      stroke: currentColor;
      stroke-width: 2.2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .tileLabel{
      color:#fff;
      font-weight: 950;
      letter-spacing: 1.4px;
      text-transform: uppercase;
      text-shadow: 0 2px 12px rgba(0,0,0,.75);
      font-size: 13px;
      opacity: .98;
    }

    .tile.tecnico{ grid-column: 1 / -1; }
    .tile.tecnico .tileBorder{ min-height: 150px; }

    .hint{
      margin: 18px 0 0 0;
      color: rgba(234,242,255,.72);
      font-weight: 650;
      font-size: 14px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }

    /* ===== Chips (tambi√©n neon suaves) ===== */
    .chip{
      border-radius: 999px;
      padding:10px 12px;
      background:
        radial-gradient(130% 120% at 50% 0%, rgba(255,255,255,.10), rgba(0,0,0,.40));
      border:1px solid rgba(255,255,255,.14);
      color: rgba(234,242,255,.92);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .chip:hover{ filter: brightness(1.07); }

    /* ===== APP SHELL ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 16px;
      margin-bottom: 14px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: var(--shadow2);
    }
    .brandTitle{ font-weight: 950; letter-spacing:.2px; }
    .session{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      font-weight: 850; color: rgba(234,242,255,.9);
    }

    /* ====== BOTONES NEON-CUBO (OPCI√ìN 1) ====== */
    @keyframes neonPulse {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.10); }
    }

    .btn{
      position:relative;
      background:
        radial-gradient(120% 120% at 50% 0%, rgba(255,255,255,.12), rgba(0,0,0,.70));
      color:#fff;
      border:2px solid rgba(255,255,255,.16);
      padding: 13px 16px;
      border-radius: 18px;
      font-weight: 950;
      cursor:pointer;
      display:inline-flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      user-select:none;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
      box-shadow: 0 14px 40px rgba(0,0,0,.40), inset 0 0 0 1px rgba(255,255,255,.06);
      letter-spacing:.2px;
    }
    .btn:hover{ filter: brightness(1.10); }
    .btn:active{ transform: scale(.99); }

    .btn::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 18px;
      background: radial-gradient(60% 60% at 50% 0%, var(--glowFade, transparent), transparent 70%);
      opacity:.55;
      filter: blur(10px);
      pointer-events:none;
      transition: opacity .12s ease;
    }
    .btn:hover::before{ opacity:.75; }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }

    .btnBlue{ --glowFade: rgba(55,184,255,.55); border-color: rgba(55,184,255,.55); box-shadow: 0 0 24px rgba(55,184,255,.18), 0 14px 40px rgba(0,0,0,.42), inset 0 0 20px rgba(55,184,255,.10); animation: neonPulse 3.2s ease-in-out infinite; }
    .btnPurple{ --glowFade: rgba(168,85,255,.55); border-color: rgba(168,85,255,.55); box-shadow: 0 0 24px rgba(168,85,255,.18), 0 14px 40px rgba(0,0,0,.42), inset 0 0 20px rgba(168,85,255,.10); animation: neonPulse 3.4s ease-in-out infinite; }
    .btnGreen{ --glowFade: rgba(44,255,198,.45); border-color: rgba(44,255,198,.50); box-shadow: 0 0 24px rgba(44,255,198,.14), 0 14px 40px rgba(0,0,0,.42), inset 0 0 20px rgba(44,255,198,.08); animation: neonPulse 3.6s ease-in-out infinite; }
    .btnDanger{ --glowFade: rgba(255,91,91,.55); border-color: rgba(255,91,91,.55); box-shadow: 0 0 24px rgba(255,91,91,.16), 0 14px 40px rgba(0,0,0,.42), inset 0 0 18px rgba(255,91,91,.08); }

    .miniBtn{
      position:relative;
      background:
        radial-gradient(120% 120% at 50% 0%, rgba(255,255,255,.10), rgba(0,0,0,.55));
      color:#fff;
      border:1px solid rgba(255,255,255,.14);
      padding:9px 12px;
      border-radius: 999px;
      font-weight: 950;
      cursor:pointer;
      box-shadow: 0 12px 34px rgba(0,0,0,.38);
    }
    .miniBtn:hover{ filter: brightness(1.10); }

    /* Tabs neon */
    .navTabs{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 14px; }
    .tabBtn{
      padding:12px 14px;
      border-radius: 999px;
      background:
        radial-gradient(130% 120% at 50% 0%, rgba(255,255,255,.10), rgba(0,0,0,.35));
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(234,242,255,.88);
      font-weight: 950;
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.30);
    }
    .tabBtn:hover{ filter: brightness(1.10); }
    .tabBtn.active{
      border-color: rgba(55,184,255,.60);
      box-shadow: 0 0 18px rgba(55,184,255,.20), 0 10px 26px rgba(0,0,0,.35);
      color:#fff;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      box-shadow: var(--shadow2);
      padding: 16px;
      margin-bottom: 14px;
    }

    h2{ margin: 0 0 10px 0; font-weight: 950; letter-spacing:.2px; }
    h3{ margin: 0 0 10px 0; font-weight: 950; letter-spacing:.2px; }

    .muted{ color: rgba(234,242,255,.72); font-weight: 650; }
    .badgeNum{
      display:inline-block;
      margin-left: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      font-weight: 950;
    }

    /* Inputs negros + texto blanco robusto */
    label{
      display:block;
      font-weight: 900;
      letter-spacing:.2px;
      margin: 10px 0 6px;
      color: rgba(234,242,255,.92);
    }
    input, textarea, select{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.62);
      color:#fff;
      padding: 14px 14px;
      font-weight: 850;
      font-size: 16px;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }
    textarea{ min-height: 92px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.45); font-weight: 750; }

    input:focus, textarea:focus, select:focus{
      border-color: rgba(55,184,255,.55);
      box-shadow: 0 0 0 3px rgba(55,184,255,.14);
    }

    .split{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 820px){ .split{ grid-template-columns: 1fr; } }

    .list{ display:flex; flex-direction:column; gap: 12px; margin-top: 12px; }
    .card{
      border-radius: 18px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      box-shadow: 0 12px 38px rgba(0,0,0,.35);
    }
    .cardTitle{ font-weight: 950; margin: 0 0 6px 0; }
    .cardLine{ margin: 2px 0; color: rgba(234,242,255,.88); font-weight: 750; }
    .cardLine b{ font-weight: 950; color:#fff; }
    .small{ font-size: 13px; color: rgba(234,242,255,.72); font-weight: 700; }

    /* Firma */
    .sigBox{
      border-radius: 18px;
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.45);
      padding: 10px;
    }
    #sigCanvas{
      width:100%;
      height: 170px;
      border-radius: 14px;
      background: rgba(0,0,0,.70);
      border: 1px solid rgba(255,255,255,.10);
      touch-action: none;
      display:block;
    }
    .sigHint{
      margin-top: 8px;
      color: rgba(234,242,255,.68);
      font-weight: 750;
      font-size: 13px;
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalCard{
      width:min(520px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      padding: 16px;
      position:relative;
      backdrop-filter: blur(10px);
    }
    .closeX{
      position:absolute;
      top: 10px; right: 10px;
      width: 40px; height: 40px;
      border-radius: 12px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      font-weight: 950;
      cursor:pointer;
    }

    .passRow{ display:flex; gap:10px; align-items:center; }
    .eyeBtn{
      width: 54px;
      height: 52px;
      border-radius: 14px;
      background: rgba(0,0,0,.60);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      font-size: 18px;
      cursor:pointer;
      font-weight: 950;
    }

    /* Scanner */
    .videoBox{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
    }
    #scanVideo{ width:100%; height:auto; display:block; }
    .scanOverlay{
      margin-top:10px;
      padding:10px;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 800;
      color: rgba(234,242,255,.85);
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      padding: 12px 14px;
      border-radius: 999px;
      box-shadow: var(--shadow2);
      font-weight: 900;
      max-width: min(740px, calc(100% - 24px));
      z-index: 99999;
      display:none;
    }

    /* QR */
    .qrWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px;
      border-radius: 18px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      margin-top: 10px;
    }
    #qrImg{
      width: 240px;
      height: 240px;
      image-rendering: crisp-edges;
      border-radius: 16px;
      background:#fff;
      padding: 10px;
    }
  </style>
</head>

bbody
  <!-- LOGIN -->
  <div id="loginScreen" class="screen">
    <div class="glass hero">
      <h1 id="bizNameTitle">Technology Expert's</h1>
      <p class="subtitle">Selecciona qui√©n ingresa (dise√±o Ne√≥n Tech). PC / Android / iPhone.</p>

      <div class="roleGrid">
        <button class="tile admin" data-role="ADMIN" type="button" aria-label="Administrador">
          <div class="tileBorder">
            <div class="iconWrap">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2l7 4v6c0 5-3 9-7 10C8 21 5 17 5 12V6l7-4z"></path>
                <path d="M9 12l2 2 4-5"></path>
              </svg>
            </div>
            <div class="tileLabel">ADMINISTRADOR</div>
          </div>
        </button>

        <button class="tile ventas" data-role="VENTAS" type="button" aria-label="Ventas">
          <div class="tileBorder">
            <div class="iconWrap">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7 3h10v18l-2-1-2 1-2-1-2 1-2-1-2 1V3z"></path>
                <path d="M9 7h6"></path>
                <path d="M9 11h6"></path>
                <path d="M9 15h5"></path>
              </svg>
            </div>
            <div class="tileLabel">VENTAS</div>
          </div>
        </button>

        <button class="tile tecnico" data-role="TECNICO" type="button" aria-label="T√©cnico">
          <div class="tileBorder">
            <div class="iconWrap">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M14 7a4 4 0 01-5 5L4 17l3 3 5-5a4 4 0 005-5z"></path>
                <circle cx="6.5" cy="17.5" r="1"></circle>
              </svg>
            </div>
            <div class="tileLabel">T√âCNICO</div>
          </div>
        </button>
      </div>

      <p class="hint">Acceso con usuario y contrase√±a. (Control b√°sico porque todo corre en el navegador).</p>

      <div class="row">
        <button class="chip" id="btnHardRefresh" type="button">‚ôªÔ∏è Actualizar / limpiar cach√©</button>
        <button class="chip" id="btnHelp" type="button">‚ùì Ayuda r√°pida</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appScreen" class="screen hidden">
    <div class="glass">

      <div class="topbar">
        <div class="brandTitle" id="bizNameTop">Technology Expert's</div>
        <div class="session">
          Rol: <span id="roleLabel">-</span>
          <button class="miniBtn" id="btnLogout" type="button">Salir</button>
        </div>
      </div>

      <div class="navTabs" id="navTabs">
        <button class="tabBtn active" data-view="dashboard" type="button">Inicio</button>
        <button class="tabBtn" data-view="orders" type="button">√ìrdenes</button>
        <button class="tabBtn" data-view="sales" type="button">Ventas</button>
        <button class="tabBtn" data-view="inventory" type="button">Inventario</button>
        <button class="tabBtn" data-view="admin" type="button">Admin</button>
      </div>

      <!-- DASHBOARD -->
      <div id="view-dashboard" class="panel">
        <h2>Panel</h2>
        <p class="muted">Usa los botones para entrar a tu m√≥dulo. Los n√∫meros van en orden ascendente.</p>

        <div class="btnRow">
          <button class="btn btnBlue" id="goOrders" type="button">üßæ Ir a √ìrdenes</button>
          <button class="btn btnPurple" id="goSales" type="button">üí≥ Ir a Ventas</button>
          <button class="btn btnGreen" id="goInv" type="button">üì¶ Ir a Inventario</button>
        </div>

        <div class="panel" style="margin-top:14px;">
          <h3>B√∫squeda r√°pida</h3>
          <input id="globalSearch" placeholder="Buscar por #, nombre, c√©dula, tel√©fono, email, marca, c√≥digo, IMEI..." />
          <div class="small" style="margin-top:8px;">Tip: escribe ‚Äú02100‚Äù, ‚Äú00315‚Äù, un IMEI o un c√≥digo de barras.</div>
          <div id="globalResults" class="list"></div>
        </div>
      </div>

      <!-- √ìRDENES -->
      <div id="view-orders" class="panel hidden">
        <h2>Orden de servicio <span class="badgeNum" id="orderNextBadge">Orden #-----</span></h2>
        <p class="muted">Firma obligatoria. Puedes agregar fotos (opcional). Se guarda en este dispositivo.</p>

        <div class="btnRow">
          <button class="btn btnBlue" id="btnOrderNew" type="button">üÜï Nueva orden (limpiar)</button>
          <button class="btn" id="btnOrderToggleList" type="button">üìã Ver lista</button>
        </div>

        <div id="orderFormPanel" class="panel" style="margin-top:14px;">
          <h3>Datos del cliente</h3>

          <div class="split">
            <div>
              <label>Nombre</label>
              <input id="o_cliente" placeholder="Nombre del cliente" />
            </div>
            <div>
              <label>C√©dula</label>
              <input id="o_cedula" placeholder="C√©dula" inputmode="numeric" />
            </div>
          </div>

          <div class="split">
            <div>
              <label>Celular</label>
              <input id="o_tel" placeholder="Celular" inputmode="tel" />
            </div>
            <div>
              <label>Correo</label>
              <input id="o_email" placeholder="Correo electr√≥nico" type="email" autocomplete="email" list="emailDatalist" />
              <datalist id="emailDatalist"></datalist>
            </div>
          </div>

          <h3 style="margin-top:14px;">Equipo</h3>

          <div class="split">
            <div>
              <label>Marca</label>
              <input id="o_marca" placeholder="Marca del celular" list="brandDatalist" />
              <datalist id="brandDatalist"></datalist>
            </div>
            <div>
              <label>Modelo</label>
              <input id="o_modelo" placeholder="Modelo del celular" />
            </div>
          </div>

          <label>Falla reportada</label>
          <textarea id="o_falla" placeholder="Describe la falla..."></textarea>

          <h3 style="margin-top:14px;">Firma del cliente (obligatoria)</h3>
          <div class="sigBox">
            <canvas id="sigCanvas"></canvas>
            <div class="sigHint">Firma con el dedo. Si est√° en blanco NO deja guardar.</div>
            <div class="btnRow">
              <button class="btn" id="btnSigClear" type="button">üßº Borrar firma</button>
            </div>
          </div>

          <h3 style="margin-top:14px;">Fotos (opcional)</h3>
          <input id="o_fotos" type="file" accept="image/*" multiple />
          <div id="o_fotosPreview" class="list"></div>

          <div class="btnRow">
            <button class="btn btnBlue" id="btnOrderSave" type="button">üíæ Guardar orden</button>
          </div>
        </div>

        <div id="orderListPanel" class="panel hidden" style="margin-top:14px;">
          <h3>√ìrdenes guardadas (ascendente)</h3>
          <input id="orderSearch" placeholder="Buscar (cliente, c√©dula, tel, email, marca, modelo, #...)" />
          <div class="btnRow">
            <button class="btn" id="btnOrderBackToForm" type="button">‚¨ÖÔ∏è Volver al formulario</button>
          </div>
          <div id="ordersList" class="list"></div>
        </div>
      </div>

      <!-- VENTAS -->
      <div id="view-sales" class="panel hidden">
        <h2>Ventas <span class="badgeNum" id="saleNextBadge">Venta #-----</span></h2>
        <p class="muted">Para venta de tel√©fonos: IMEI 1/2 y t√©rminos obligatorios.</p>

        <div class="btnRow">
          <button class="btn btnPurple" id="btnSaleNew" type="button">üÜï Nueva venta (limpiar)</button>
          <button class="btn" id="btnSaleToggleList" type="button">üìã Ver lista</button>
        </div>

        <div id="saleFormPanel" class="panel" style="margin-top:14px;">
          <h3>Datos del cliente</h3>

          <div class="split">
            <div>
              <label>Nombre</label>
              <input id="s_cliente" placeholder="Nombre del cliente" />
            </div>
            <div>
              <label>C√©dula</label>
              <input id="s_cedula" placeholder="C√©dula" inputmode="numeric" />
            </div>
          </div>

          <div class="split">
            <div>
              <label>Celular</label>
              <input id="s_tel" placeholder="Celular" inputmode="tel" />
            </div>
            <div>
              <label>Correo</label>
              <input id="s_email" placeholder="Correo electr√≥nico" type="email" autocomplete="email" list="emailDatalist2" />
              <datalist id="emailDatalist2"></datalist>
            </div>
          </div>

          <h3 style="margin-top:14px;">Producto / Tel√©fono</h3>

          <div class="split">
            <div>
              <label>Marca</label>
              <input id="s_marca" placeholder="Marca (Samsung, iPhone, Xiaomi...)" list="brandDatalist2" />
              <datalist id="brandDatalist2"></datalist>
            </div>
            <div>
              <label>Modelo</label>
              <input id="s_modelo" placeholder="Modelo (A21s, 13 Pro, Redmi...)" />
            </div>
          </div>

          <div class="split">
            <div>
              <label>IMEI 1</label>
              <div class="btnRow" style="margin-top:0;">
                <input id="s_imei1" placeholder="IMEI 1" inputmode="numeric" style="flex:1;" />
                <button class="btn btnGreen" id="btnScanImei1" type="button">üì∑ Scan</button>
              </div>
            </div>

            <div>
              <label>IMEI 2 (opcional)</label>
              <div class="btnRow" style="margin-top:0;">
                <input id="s_imei2" placeholder="IMEI 2 (si trae doble)" inputmode="numeric" style="flex:1;" />
                <button class="btn btnGreen" id="btnScanImei2" type="button">üì∑ Scan</button>
              </div>
            </div>
          </div>

          <div class="split">
            <div>
              <label>Valor venta</label>
              <input id="s_valor" placeholder="Valor" inputmode="decimal" />
            </div>
            <div>
              <label>M√©todo</label>
              <select id="s_metodo">
                <option value="Efectivo">Efectivo</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
          </div>

          <label>Observaciones (opcional)</label>
          <textarea id="s_obs" placeholder="Notas, referencia, garant√≠a, etc."></textarea>

          <div class="panel" style="margin-top:12px;">
            <h3>T√©rminos (obligatorio)</h3>
            <div class="small" style="line-height:1.35;">
              El cliente reconoce que debe <b>registrar el/los IMEI</b> ante el operador que vaya a usar.
              <b>No respondemos</b> si el cliente no registra correctamente los IMEI en la base de datos del operador.
              (Si el equipo trae 2 IMEI, deben registrarse ambos).
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
              <input id="s_terms" type="checkbox" style="width:22px;height:22px;accent-color:#37B8FF;" />
              <label style="margin:0; font-weight:950;">Acepto los t√©rminos y condiciones</label>
            </div>
          </div>

          <div class="btnRow">
            <button class="btn btnPurple" id="btnSaleSave" type="button">üíæ Guardar venta</button>
          </div>
        </div>

        <div id="saleListPanel" class="panel hidden" style="margin-top:14px;">
          <h3>Ventas guardadas (ascendente)</h3>
          <input id="saleSearch" placeholder="Buscar (cliente, c√©dula, tel, email, marca, modelo, IMEI, #...)" />
          <div class="btnRow">
            <button class="btn" id="btnSaleBackToForm" type="button">‚¨ÖÔ∏è Volver al formulario</button>
          </div>
          <div id="salesList" class="list"></div>
        </div>
      </div>

      <!-- INVENTARIO -->
      <div id="view-inventory" class="panel hidden">
        <h2>Inventario</h2>
        <p class="muted">Agrega productos por c√≥digo (barcode/QR). Foto opcional.</p>

        <div class="btnRow">
          <button class="btn btnGreen" id="btnInvNew" type="button">üÜï Nuevo producto</button>
          <button class="btn" id="btnInvToggleList" type="button">üìã Ver lista</button>
        </div>

        <div id="invFormPanel" class="panel" style="margin-top:14px;">
          <h3>Producto</h3>

          <label>C√≥digo (barcode/QR)</label>
          <div class="btnRow" style="margin-top:0;">
            <input id="i_code" placeholder="Escanea o escribe el c√≥digo" style="flex:1;" />
            <button class="btn btnGreen" id="btnScanInvCode" type="button">üì∑ Scan</button>
          </div>

          <div class="split">
            <div>
              <label>Nombre</label>
              <input id="i_name" placeholder="Nombre del producto" />
            </div>
            <div>
              <label>Marca</label>
              <input id="i_brand" placeholder="Marca" list="brandDatalist3" />
              <datalist id="brandDatalist3"></datalist>
            </div>
          </div>

          <label>Descripci√≥n (opcional)</label>
          <textarea id="i_desc" placeholder="Descripci√≥n"></textarea>

          <div class="split">
            <div>
              <label>Costo</label>
              <input id="i_cost" placeholder="Costo" inputmode="decimal" />
            </div>
            <div>
              <label>Precio</label>
              <input id="i_price" placeholder="Precio" inputmode="decimal" />
            </div>
          </div>

          <div class="split">
            <div>
              <label>Stock</label>
              <input id="i_stock" placeholder="Cantidad" inputmode="numeric" />
            </div>
            <div>
              <label>Stock m√≠nimo (alerta)</label>
              <input id="i_min" placeholder="M√≠nimo" inputmode="numeric" />
            </div>
          </div>

          <h3 style="margin-top:14px;">Foto del producto (opcional)</h3>
          <input id="i_photo" type="file" accept="image/*" />
          <div id="i_photoPreview" class="list"></div>

          <div class="btnRow">
            <button class="btn btnGreen" id="btnInvSave" type="button">üíæ Guardar producto</button>
          </div>
        </div>

        <div id="invListPanel" class="panel hidden" style="margin-top:14px;">
          <h3>Productos (ascendente)</h3>
          <input id="invSearch" placeholder="Buscar por c√≥digo, nombre, marca..." />
          <div class="btnRow">
            <button class="btn" id="btnInvBackToForm" type="button">‚¨ÖÔ∏è Volver al formulario</button>
          </div>
          <div id="invList" class="list"></div>
        </div>
      </div>
      <!-- ADMIN -->
      <div id="view-admin" class="panel hidden">
        <h2>Administrador</h2>
        <p class="muted">Exportar CSV, backup JSON, importar y borrar. Solo Admin.</p>

        <div class="panel">
          <h3>Exportar</h3>
          <div class="btnRow">
            <button class="btn btnBlue" id="btnCsvOrders" type="button">‚¨áÔ∏è CSV √ìrdenes</button>
            <button class="btn btnPurple" id="btnCsvSales" type="button">‚¨áÔ∏è CSV Ventas</button>
            <button class="btn btnGreen" id="btnCsvInv" type="button">‚¨áÔ∏è CSV Inventario</button>
          </div>
        </div>

        <div class="panel">
          <h3>Backup</h3>
          <div class="btnRow">
            <button class="btn" id="btnBackupJson" type="button">üì¶ Backup JSON (todo)</button>
            <label class="btn" style="cursor:pointer;">
              üì• Importar JSON
              <input id="importJsonFile" type="file" accept="application/json" style="display:none;">
            </label>
          </div>
          <div class="small">Incluye contadores, listas, fotos y firmas (puede pesar).</div>
        </div>

        <div class="panel">
          <h3>Configuraci√≥n</h3>
          <label>Nombre del negocio</label>
          <input id="setBizName" placeholder="Nombre del negocio" />
          <div class="btnRow">
            <button class="btn btnBlue" id="btnSaveBizName" type="button">üíæ Guardar nombre</button>
          </div>

          <h3 style="margin-top:14px;">Cambiar contrase√±as</h3>
          <div class="small">Control b√°sico (se guarda en este dispositivo).</div>

          <div class="split" style="margin-top:8px;">
            <div>
              <label>Admin (usuario)</label>
              <input id="c_admin_user" />
              <label>Admin (contrase√±a)</label>
              <input id="c_admin_pass" type="password" />
            </div>
            <div>
              <label>Ventas (usuario)</label>
              <input id="c_sales_user" />
              <label>Ventas (contrase√±a)</label>
              <input id="c_sales_pass" type="password" />
            </div>
          </div>

          <div class="split" style="margin-top:8px;">
            <div>
              <label>T√©cnico (usuario)</label>
              <input id="c_tech_user" />
              <label>T√©cnico (contrase√±a)</label>
              <input id="c_tech_pass" type="password" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn btnBlue" id="btnSaveCreds" type="button">üíæ Guardar credenciales</button>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>Peligroso</h3>
          <div class="btnRow">
            <button class="btn btnDanger" id="btnResetCounters" type="button">üîÅ Reiniciar contadores</button>
            <button class="btn btnDanger" id="btnWipeAll" type="button">üß® Borrar TODO</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODAL LOGIN -->
  <div id="modalLogin" class="modal hidden">
    <div class="modalCard">
      <button class="closeX" id="closeLogin" type="button">‚úï</button>
      <h3>Acceso</h3>
      <div class="small">Rol: <b id="loginRoleLabel">-</b></div>

      <label>Usuario</label>
      <input id="loginUser" placeholder="Usuario" autocomplete="username" />

      <label>Contrase√±a</label>
      <div class="passRow">
        <input id="loginPass" placeholder="Contrase√±a" type="password" autocomplete="current-password" inputmode="text" style="flex:1;" />
        <button class="eyeBtn" id="toggleEye" type="button" title="Ver/ocultar">üëÅ</button>
      </div>

      <div class="btnRow">
        <button class="btn btnBlue" id="btnDoLogin" type="button">Entrar</button>
      </div>

      <div class="small" style="margin-top:8px;">
        <b>Por defecto:</b><br>
        Admin: admin / admin123<br>
        Ventas: ventas / ventas123<br>
        T√©cnico: tecnico / tecnico123
      </div>
    </div>
  </div>

  <!-- MODAL SCAN -->
  <div id="modalScan" class="modal hidden">
    <div class="modalCard">
      <button class="closeX" id="closeScan" type="button">‚úï</button>
      <h3 id="scanTitle">Escanear</h3>

      <div class="videoBox">
        <video id="scanVideo" playsinline></video>
      </div>

      <div class="scanOverlay" id="scanStatus">Abriendo c√°mara...</div>

      <label style="margin-top:10px;">Si no detecta, escribe manual:</label>
      <div class="btnRow" style="margin-top:0;">
        <input id="scanManual" placeholder="Pegar/escribir c√≥digo" style="flex:1;" />
        <button class="btn btnGreen" id="useManualCode" type="button">Usar</button>
      </div>
    </div>
  </div>

  <!-- MODAL QR -->
  <div id="modalQR" class="modal hidden">
    <div class="modalCard">
      <button class="closeX" id="closeQR" type="button">‚úï</button>
      <h3 id="qrTitle">QR</h3>
      <div class="small" id="qrText"></div>
      <div class="qrWrap">
        <img id="qrImg" alt="QR" />
      </div>
      <div class="btnRow">
        <button class="btn" id="btnPrintQR" type="button">üñ®Ô∏è Imprimir</button>
      </div>
      <div class="small">Nota: el QR se genera por internet (imagen). M√°s adelante lo hacemos 100% offline.</div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
/* ====== DIAGN√ìSTICO OFFLINE (muestra errores en pantalla) ====== */
(function () {
  function showErr(msg){
    let box = document.getElementById("offlineErrBox");
    if(!box){
      box = document.createElement("div");
      box.id = "offlineErrBox";
      box.style.position = "fixed";
      box.style.left = "12px";
      box.style.right = "12px";
      box.style.bottom = "12px";
      box.style.zIndex = "99999";
      box.style.background = "#000";
      box.style.color = "#fff";
      box.style.padding = "12px";
      box.style.border = "2px solid #00e5ff";
      box.style.borderRadius = "14px";
      box.style.fontFamily = "system-ui, Arial";
      box.style.fontSize = "14px";
      box.style.whiteSpace = "pre-wrap";
      box.style.boxShadow = "0 0 20px rgba(0,229,255,.35)";
      box.textContent = "‚ö†Ô∏è Error detectado:\n";
      document.addEventListener("DOMContentLoaded", ()=> document.body.appendChild(box));
      if(document.body) document.body.appendChild(box);
    }
    box.textContent = "‚ö†Ô∏è Error detectado:\n" + msg;
  }

  window.addEventListener("error", (e) => {
    const msg = (e && (e.message || (e.error && e.error.message))) || "Error desconocido";
    showErr(msg);
  });

  window.addEventListener("unhandledrejection", (e) => {
    const msg = (e && e.reason && (e.reason.message || String(e.reason))) || "Promesa rechazada";
    showErr(msg);
  });
})();
</script>
</script>
  
  /************************
   * CONFIG / STORAGE
   ************************/
  const LS = {
    /***********************
     * CONFIG / STORAGE
     ***********************/
    const LS = {
      settings: "te_settings",
      creds: "te_creds",
      session: "te_session",
      orders: "te_orders",
      orderCounter: "te_orderCounter",
      sales: "te_sales",
      saleCounter: "te_saleCounter",
      inv: "te_inventory",
      brands: "te_brands_learned",
      emailDomains: "te_email_domains"
    };

    const START_ORDER = 2100;
    const START_SALE  = 315;
    const PAD = 5;

    const DEFAULT_BRANDS = [
      "Samsung","Apple","iPhone","iPad","Xiaomi","Redmi","POCO","Realme","Huawei","Honor","Motorola","Nokia",
      "OnePlus","OPPO","Vivo","Infinix","Tecno","Itel","ZTE","Alcatel","Sony","LG","Asus","Lenovo","BlackBerry",
      "HTC","Google Pixel","Meizu","TCL","Ulefone","Doogee","Oukitel","Umidigi","CAT","Sharp","Panasonic",
      "Philips","Sagem","Gionee","Nothing","Fairphone","Microsoft","Nubia","Blu"
    ];

    const DEFAULT_EMAIL_DOMAINS = [
      "gmail.com","hotmail.com","outlook.com","icloud.com","yahoo.com","live.com","proton.me","protonmail.com"
    ];

    const DEFAULT_CREDS = {
      ADMIN:  { user: "admin",   pass: "admin123" },
      VENTAS: { user: "ventas",  pass: "ventas123" },
      TECNICO:{ user: "tecnico", pass: "tecnico123" }
    };

    function jget(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(raw === null || raw === undefined) return fallback;
        return JSON.parse(raw);
      }catch(e){ return fallback; }
    }
    function jset(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    function getNum(key, fallback){
      const v = localStorage.getItem(key);
      if(v === null || v === undefined) return fallback;
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }
    function setNum(key, n){ localStorage.setItem(key, String(n)); }
    function padNum(n){ return String(n).padStart(PAD, "0"); }
    function nowStr(ts){ return new Date(ts).toLocaleString("es-CO"); }
    const $ = (id)=>document.getElementById(id);

    function showToast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(showToast._to);
      showToast._to = setTimeout(()=>{ t.style.display="none"; }, 2600);
    }
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    /***********************
     * SETTINGS / CREDS
     ***********************/
    function getSettings(){
      return jget(LS.settings, { businessName: "Technology Expert's" });
    }
    function setBusinessName(name){
      const s = getSettings();
      s.businessName = name;
      jset(LS.settings, s);
      applyBusinessName();
    }
    function applyBusinessName(){
      const s = getSettings();
      $("bizNameTitle").textContent = s.businessName;
      $("bizNameTop").textContent = s.businessName;
      document.title = s.businessName;
      $("setBizName").value = s.businessName;
    }
    function getCreds(){ return jget(LS.creds, DEFAULT_CREDS); }
    function saveCreds(obj){ jset(LS.creds, obj); }

    /***********************
     * INIT
     ***********************/
    function ensureInit(){
      if(!localStorage.getItem(LS.orders)) jset(LS.orders, []);
      if(!localStorage.getItem(LS.sales))  jset(LS.sales, []);
      if(!localStorage.getItem(LS.inv))    jset(LS.inv, []);
      if(localStorage.getItem(LS.orderCounter) === null) setNum(LS.orderCounter, START_ORDER);
      if(localStorage.getItem(LS.saleCounter)  === null) setNum(LS.saleCounter, START_SALE);
      if(!localStorage.getItem(LS.brands)) jset(LS.brands, []);
      if(!localStorage.getItem(LS.emailDomains)) jset(LS.emailDomains, DEFAULT_EMAIL_DOMAINS);
    }

    function getAllBrands(){
      const learned = jget(LS.brands, []);
      const all = Array.from(new Set([...DEFAULT_BRANDS, ...learned]));
      all.sort((a,b)=>a.localeCompare(b, "es", {sensitivity:"base"}));
      return all;
    }
    function learnBrand(name){
      const clean = (name||"").trim();
      if(!clean) return;
      const learned = jget(LS.brands, []);
      const exists = learned.some(x=>x.toLowerCase()===clean.toLowerCase());
      if(exists) return;
      learned.push(clean);
      jset(LS.brands, learned);
      buildBrandDatalists();
    }

    function getEmailDomains(){ return jget(LS.emailDomains, DEFAULT_EMAIL_DOMAINS); }
    function learnEmailDomain(email){
      const v = (email||"").trim().toLowerCase();
      if(!v.includes("@")) return;
      const domain = v.split("@").pop();
      if(!domain || !domain.includes(".")) return;
      const arr = getEmailDomains();
      if(arr.includes(domain)) return;
      arr.push(domain);
      arr.sort((a,b)=>a.localeCompare(b));
      jset(LS.emailDomains, arr);
    }

    function buildBrandDatalists(){
      const brands = getAllBrands();
      ["brandDatalist","brandDatalist2","brandDatalist3"].forEach(id=>{
        const dl = $(id);
        if(!dl) return;
        dl.innerHTML = "";
        brands.forEach(b=>{
          const opt = document.createElement("option");
          opt.value = b;
          dl.appendChild(opt);
        });
      });
    }

    function updateEmailDatalist(datalistId, currentValue){
      const dl = $(datalistId);
      if(!dl) return;
      const domains = getEmailDomains();
      const v = (currentValue||"").trim();
      const left = v.includes("@") ? v.split("@")[0] : v;
      if(!left){ dl.innerHTML=""; return; }
      dl.innerHTML = "";
      domains.forEach(d=>{
        const opt = document.createElement("option");
        opt.value = left + "@" + d;
        dl.appendChild(opt);
      });
    }

    /***********************
     * SESSION / ROLE
     ***********************/
    let currentRole = null;
    function roleName(r){
      if(r==="ADMIN") return "ADMIN";
      if(r==="VENTAS") return "VENTAS";
      if(r==="TECNICO") return "T√âCNICO";
      return "-";
    }
    function setRoleUI(role){
      currentRole = role;
      $("roleLabel").textContent = roleName(role);

      const tabOrders = document.querySelector('.tabBtn[data-view="orders"]');
      const tabSales  = document.querySelector('.tabBtn[data-view="sales"]');
      const tabInv    = document.querySelector('.tabBtn[data-view="inventory"]');
      const tabAdmin  = document.querySelector('.tabBtn[data-view="admin"]');

      if(role === "ADMIN"){
        tabOrders.style.display = "";
        tabSales.style.display  = "";
        tabInv.style.display    = "";
        tabAdmin.style.display  = "";
      }
      if(role === "VENTAS"){
        tabOrders.style.display = "none";
        tabSales.style.display  = "";
        tabInv.style.display    = "";
        tabAdmin.style.display  = "none";
      }
      if(role === "TECNICO"){
        tabOrders.style.display = "";
        tabSales.style.display  = "none";
        tabInv.style.display    = "";
        tabAdmin.style.display  = "none";
      }
    }

    function saveSession(role, user){
      sessionStorage.setItem(LS.session, JSON.stringify({ role, user, ts: Date.now() }));
    }
    function loadSession(){
      try{ return JSON.parse(sessionStorage.getItem(LS.session)||"null"); }catch(e){ return null; }
    }
    function clearSession(){ sessionStorage.removeItem(LS.session); }

    /***********************
     * VIEW SWITCH
     ***********************/
    function setActiveTab(view){
      document.querySelectorAll(".tabBtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.view === view);
      });
    }

    function switchView(view){
      ["dashboard","orders","sales","inventory","admin"].forEach(v=>{
        const el = $("view-"+v);
        if(!el) return;
        if(v === view) show(el); else hide(el);
      });
      setActiveTab(view);

      if(view === "orders") refreshOrderBadge();
      if(view === "sales") refreshSaleBadge();
      if(view === "dashboard") renderGlobalResults($("globalSearch").value || "");
    }

    function enterApp(role){
      setRoleUI(role);
      hide($("loginScreen"));
      show($("appScreen"));

      if(role === "ADMIN") switchView("dashboard");
      if(role === "VENTAS") switchView("sales");
      if(role === "TECNICO") switchView("orders");

      refreshOrderBadge();
      refreshSaleBadge();
      renderOrders();
      renderSales();
      renderInventory();
      renderGlobalResults("");
    }
    /***********************
     * LOGIN
     ***********************/
    let selectedRole = null;
    function openLogin(role){
      selectedRole = role;
      $("loginRoleLabel").textContent = roleName(role);
      $("loginUser").value = "";
      $("loginPass").value = "";
      $("loginPass").type = "password";
      $("toggleEye").textContent = "üëÅ";
      show($("modalLogin"));
      setTimeout(()=> $("loginUser").focus(), 50);
    }
    function closeLogin(){ hide($("modalLogin")); }
    function doLogin(){
      const creds = getCreds();
      const u = ($("loginUser").value||"").trim().toLowerCase();
      const p = ($("loginPass").value||"").trim();
      const expected = creds[selectedRole];
      if(!expected){ showToast("Rol inv√°lido."); return; }
      const ok = (u === String(expected.user||"").toLowerCase()) && (p === String(expected.pass||""));
      if(!ok){ showToast("Usuario o contrase√±a incorrectos."); return; }
      saveSession(selectedRole, u);
      closeLogin();
      enterApp(selectedRole);
    }

    /***********************
     * SIGNATURE
     ***********************/
    let sigHasInk = false;
    let sigDrawing = false;
    let sigLast = null;
    let sigCtx = null;

    function resizeSig(){
      const canvas = $("sigCanvas");
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      sigCtx = canvas.getContext("2d");
      sigCtx.setTransform(dpr,0,0,dpr,0,0);
      sigCtx.lineWidth = 3;
      sigCtx.lineCap = "round";
      sigCtx.lineJoin = "round";
      sigCtx.strokeStyle = "#ffffff";
    }
    function sigClear(){
      const canvas = $("sigCanvas");
      if(!sigCtx) return;
      sigCtx.clearRect(0,0,canvas.width,canvas.height);
      sigHasInk = false;
    }
    function pointFromEvent(e){
      const canvas = $("sigCanvas");
      const rect = canvas.getBoundingClientRect();
      return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
    }
    function sigStart(e){
      sigDrawing = true;
      sigLast = pointFromEvent(e);
      sigHasInk = true;
    }
    function sigMove(e){
      if(!sigDrawing) return;
      const p = pointFromEvent(e);
      sigCtx.beginPath();
      sigCtx.moveTo(sigLast.x, sigLast.y);
      sigCtx.lineTo(p.x, p.y);
      sigCtx.stroke();
      sigLast = p;
    }
    function sigEnd(){ sigDrawing = false; sigLast = null; }
    function sigToDataURL(){
      try{ return $("sigCanvas").toDataURL("image/png"); }catch(e){ return ""; }
    }

    /***********************
     * PHOTOS (resize)
     ***********************/
    async function fileToDataURLResized(file, maxW=1100, maxH=1100, quality=0.82){
      const img = await new Promise((res, rej)=>{
        const i = new Image();
        i.onload = ()=>res(i);
        i.onerror = rej;
        i.src = URL.createObjectURL(file);
      });

      let w = img.width, h = img.height;
      const ratio = Math.min(maxW / w, maxH / h, 1);
      w = Math.floor(w * ratio);
      h = Math.floor(h * ratio);

      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      const ctx = c.getContext("2d");
      ctx.drawImage(img, 0,0,w,h);
      URL.revokeObjectURL(img.src);
      return c.toDataURL("image/jpeg", quality);
    }

    function renderPhotoThumbs(containerId, photos){
      const box = $(containerId);
      box.innerHTML = "";
      if(!photos || !photos.length) return;
      photos.forEach((src, idx)=>{
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="cardTitle">Foto ${idx+1}</div>
          <img src="${src}" alt="foto" style="width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.12)" />
        `;
        box.appendChild(div);
      });
    }

    /***********************
     * ORDERS
     ***********************/
    function refreshOrderBadge(){
      const next = getNum(LS.orderCounter, START_ORDER);
      $("orderNextBadge").textContent = "Orden #" + padNum(next);
    }
    function getOrders(){ return jget(LS.orders, []); }
    function setOrders(arr){ jset(LS.orders, arr); }

    function orderClearForm(){
      $("o_cliente").value = "";
      $("o_cedula").value = "";
      $("o_tel").value = "";
      $("o_email").value = "";
      $("o_marca").value = "";
      $("o_modelo").value = "";
      $("o_falla").value = "";
      $("o_fotos").value = "";
      $("o_fotosPreview").innerHTML = "";
      sigClear();
      setTimeout(()=> $("o_cliente").focus(), 30);
    }

    async function orderCollectPhotos(){
      const files = $("o_fotos").files;
      const photos = [];
      if(!files || !files.length) return photos;
      for(const f of files){
        try{
          const data = await fileToDataURLResized(f);
          photos.push(data);
        }catch(e){}
      }
      return photos;
    }

    async function orderSave(){
      const cliente = $("o_cliente").value.trim();
      const cedula  = $("o_cedula").value.trim();
      const tel     = $("o_tel").value.trim();
      const email   = $("o_email").value.trim();
      const marca   = $("o_marca").value.trim();
      const modelo  = $("o_modelo").value.trim();
      const falla   = $("o_falla").value.trim();

      if(!cliente || !cedula || !tel || !email || !marca || !modelo || !falla){
        showToast("Completa todos los campos.");
        return;
      }
      if(!sigHasInk){
        showToast("La firma es obligatoria.");
        return;
      }

      learnBrand(marca);
      learnEmailDomain(email);

      const num = getNum(LS.orderCounter, START_ORDER);
      const photos = await orderCollectPhotos();
      const sig = sigToDataURL();

      const order = {
        num,
        id: "OS-" + padNum(num),
        createdAt: Date.now(),
        cliente, cedula, tel, email,
        marca, modelo, falla,
        signature: sig,
        photos
      };

      const arr = getOrders();
      arr.push(order);
      setOrders(arr);

      setNum(LS.orderCounter, num + 1);
      refreshOrderBadge();
      renderOrders();

      showToast("Orden guardada: #" + padNum(num));
      orderClearForm();
    }

    function orderDelete(num){
      if(currentRole !== "ADMIN"){ showToast("Solo ADMIN puede borrar."); return; }
      if(!confirm("¬øBorrar la orden #" + padNum(num) + "?")) return;
      setOrders(getOrders().filter(o=>o.num !== num));
      renderOrders();
      showToast("Orden borrada.");
    }

    function showQR(title, text){
      $("qrTitle").textContent = title;
      $("qrText").textContent = text;
      const url = "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=" + encodeURIComponent(text);
      $("qrImg").src = url;
      show($("modalQR"));

      $("btnPrintQR").onclick = ()=>{
        const w = window.open("", "_blank");
        if(!w){ showToast("No se pudo abrir impresi√≥n."); return; }
        w.document.write(`
          <html>
            <head><title>${escapeHtml(title)}</title></head>
            <body onload="window.print()" style="font-family:Arial; text-align:center; padding:24px;">
              <h2>${escapeHtml(title)}</h2>
              <div style="margin:10px 0; color:#333;">${escapeHtml(text)}</div>
              <img src="${url}" style="width:260px;height:260px;" />
            </body>
          </html>
        `);
        w.document.close();
      };
    }

    function printOrder(o){
      const w = window.open("", "_blank");
      if(!w){ showToast("No se pudo abrir ticket."); return; }

      const biz = getSettings().businessName;
      const sigImg = o.signature ? `<img src="${o.signature}" style="width:100%;max-width:420px;border:1px solid #ddd;border-radius:10px"/>` : "<i>Sin firma</i>";
      const photosHtml = (o.photos||[]).slice(0,3).map(p=>`<img src="${p}" style="width:100%;max-width:420px;border:1px solid #ddd;border-radius:10px;margin-top:8px"/>`).join("");

      w.document.write(`
        <html>
          <head><title>Orden ${padNum(o.num)}</title></head>
          <body onload="window.print()" style="font-family:Arial; padding:18px;">
            <h2 style="margin:0;">${escapeHtml(biz)}</h2>
            <div style="margin:4px 0 10px;color:#444;">Orden de servicio #${padNum(o.num)}</div>
            <hr/>
            <p><b>Cliente:</b> ${escapeHtml(o.cliente)}</p>
            <p><b>C√©dula:</b> ${escapeHtml(o.cedula)} &nbsp; <b>Tel:</b> ${escapeHtml(o.tel)}</p>
            <p><b>Email:</b> ${escapeHtml(o.email)}</p>
            <p><b>Equipo:</b> ${escapeHtml(o.marca)} ${escapeHtml(o.modelo)}</p>
            <p><b>Falla:</b> ${escapeHtml(o.falla)}</p>
            <p><b>Fecha:</b> ${nowStr(o.createdAt)}</p>
            <hr/>
            <h3>Firma</h3>
            ${sigImg}
            ${photosHtml ? `<h3 style="margin-top:14px;">Fotos</h3>${photosHtml}` : ""}
          </body>
        </html>
      `);
      w.document.close();
    }

    function renderOrders(){
      const box = $("ordersList");
      box.innerHTML = "";
      const q = ($("orderSearch").value||"").trim().toLowerCase();
      const arr = getOrders().slice().sort((a,b)=>a.num-b.num);

      const filtered = !q ? arr : arr.filter(o=>{
        const blob = [o.num,o.id,o.cliente,o.cedula,o.tel,o.email,o.marca,o.modelo,o.falla].join(" ").toLowerCase();
        return blob.includes(q);
      });

      if(!filtered.length){
        box.innerHTML = `<div class="card"><div class="cardTitle">Sin √≥rdenes</div><div class="small">No hay resultados.</div></div>`;
        return;
      }

      filtered.forEach(o=>{
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="cardTitle">Orden #${padNum(o.num)}</div>
          <div class="cardLine"><b>Cliente:</b> ${escapeHtml(o.cliente)}</div>
          <div class="cardLine"><b>C√©dula:</b> ${escapeHtml(o.cedula)} &nbsp; <b>Tel:</b> ${escapeHtml(o.tel)}</div>
          <div class="cardLine"><b>Email:</b> ${escapeHtml(o.email)}</div>
          <div class="cardLine"><b>Equipo:</b> ${escapeHtml(o.marca)} ${escapeHtml(o.modelo)}</div>
          <div class="cardLine"><b>Falla:</b> ${escapeHtml(o.falla)}</div>
          <div class="small">${nowStr(o.createdAt)}</div>
          <div class="btnRow" style="margin-top:10px;">
            <button class="btn btnBlue" data-act="qr">üî≥ QR</button>
            <button class="btn" data-act="print">üñ®Ô∏è Ticket</button>
            ${currentRole==="ADMIN" ? `<button class="btn btnDanger" data-act="del">üóëÔ∏è Borrar</button>` : ""}
          </div>
        `;

        div.querySelector('[data-act="qr"]').onclick = ()=> showQR("Orden #"+padNum(o.num), "OS-" + padNum(o.num));
        div.querySelector('[data-act="print"]').onclick = ()=> printOrder(o);
        const delBtn = div.querySelector('[data-act="del"]');
        if(delBtn) delBtn.onclick = ()=> orderDelete(o.num);

        box.appendChild(div);
      });
        }
    /***********************
     * SALES
     ***********************/
    function refreshSaleBadge(){
      const next = getNum(LS.saleCounter, START_SALE);
      $("saleNextBadge").textContent = "Venta #" + padNum(next);
    }
    function getSales(){ return jget(LS.sales, []); }
    function setSales(arr){ jset(LS.sales, arr); }

    function saleClearForm(){
      $("s_cliente").value="";
      $("s_cedula").value="";
      $("s_tel").value="";
      $("s_email").value="";
      $("s_marca").value="";
      $("s_modelo").value="";
      $("s_imei1").value="";
      $("s_imei2").value="";
      $("s_valor").value="";
      $("s_metodo").value="Efectivo";
      $("s_obs").value="";
      $("s_terms").checked=false;
      setTimeout(()=> $("s_cliente").focus(), 30);
    }

    function saleSave(){
      const cliente = $("s_cliente").value.trim();
      const cedula  = $("s_cedula").value.trim();
      const tel     = $("s_tel").value.trim();
      const email   = $("s_email").value.trim();
      const marca   = $("s_marca").value.trim();
      const modelo  = $("s_modelo").value.trim();
      const imei1   = $("s_imei1").value.trim();
      const imei2   = $("s_imei2").value.trim();
      const valor   = $("s_valor").value.trim();
      const metodo  = $("s_metodo").value;
      const obs     = $("s_obs").value.trim();
      const terms   = $("s_terms").checked;

      if(!cliente || !cedula || !tel || !email || !marca || !modelo || !imei1 || !valor){
        showToast("Completa todos los campos obligatorios (IMEI 1 y valor incluidos).");
        return;
      }
      if(!terms){ showToast("Debes aceptar los t√©rminos."); return; }

      learnBrand(marca);
      learnEmailDomain(email);

      const num = getNum(LS.saleCounter, START_SALE);
      const sale = {
        num,
        id: "V-" + padNum(num),
        createdAt: Date.now(),
        cliente, cedula, tel, email,
        marca, modelo,
        imei1, imei2,
        valor, metodo, obs,
        termsAccepted: true
      };

      const arr = getSales();
      arr.push(sale);
      setSales(arr);

      setNum(LS.saleCounter, num+1);
      refreshSaleBadge();
      renderSales();

      showToast("Venta guardada: #" + padNum(num));
      saleClearForm();
    }

    function saleDelete(num){
      if(currentRole !== "ADMIN"){ showToast("Solo ADMIN puede borrar."); return; }
      if(!confirm("¬øBorrar la venta #" + padNum(num) + "?")) return;
      setSales(getSales().filter(s=>s.num !== num));
      renderSales();
      showToast("Venta borrada.");
    }

    function printSale(s){
      const w = window.open("", "_blank");
      if(!w){ showToast("No se pudo abrir ticket."); return; }

      const biz = getSettings().businessName;
      const termsText = "El cliente reconoce que debe registrar el/los IMEI ante el operador que vaya a usar. No respondemos si el cliente no registra correctamente los IMEI en la base de datos del operador. (Si el equipo trae 2 IMEI, deben registrarse ambos).";

      w.document.write(`
        <html>
          <head><title>Venta ${padNum(s.num)}</title></head>
          <body onload="window.print()" style="font-family:Arial; padding:18px;">
            <h2 style="margin:0;">${escapeHtml(biz)}</h2>
            <div style="margin:4px 0 10px;color:#444;">Venta #${padNum(s.num)}</div>
            <hr/>
            <p><b>Cliente:</b> ${escapeHtml(s.cliente)}</p>
            <p><b>C√©dula:</b> ${escapeHtml(s.cedula)} &nbsp; <b>Tel:</b> ${escapeHtml(s.tel)}</p>
            <p><b>Email:</b> ${escapeHtml(s.email)}</p>
            <p><b>Equipo:</b> ${escapeHtml(s.marca)} ${escapeHtml(s.modelo)}</p>
            <p><b>IMEI 1:</b> ${escapeHtml(s.imei1)}</p>
            ${s.imei2 ? `<p><b>IMEI 2:</b> ${escapeHtml(s.imei2)}</p>` : ""}
            <p><b>Valor:</b> ${escapeHtml(s.valor)} &nbsp; <b>M√©todo:</b> ${escapeHtml(s.metodo)}</p>
            ${s.obs ? `<p><b>Obs:</b> ${escapeHtml(s.obs)}</p>` : ""}
            <p><b>Fecha:</b> ${nowStr(s.createdAt)}</p>
            <hr/>
            <h3>T√©rminos</h3>
            <p style="font-size:13px;color:#333;line-height:1.35;">${escapeHtml(termsText)}</p>
          </body>
        </html>
      `);
      w.document.close();
    }

    function renderSales(){
      const box = $("salesList");
      box.innerHTML = "";
      const q = ($("saleSearch").value||"").trim().toLowerCase();
      const arr = getSales().slice().sort((a,b)=>a.num-b.num);

      const filtered = !q ? arr : arr.filter(s=>{
        const blob = [s.num,s.id,s.cliente,s.cedula,s.tel,s.email,s.marca,s.modelo,s.imei1,s.imei2,s.valor].join(" ").toLowerCase();
        return blob.includes(q);
      });

      if(!filtered.length){
        box.innerHTML = `<div class="card"><div class="cardTitle">Sin ventas</div><div class="small">No hay resultados.</div></div>`;
        return;
      }

      filtered.forEach(s=>{
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="cardTitle">Venta #${padNum(s.num)}</div>
          <div class="cardLine"><b>Cliente:</b> ${escapeHtml(s.cliente)}</div>
          <div class="cardLine"><b>C√©dula:</b> ${escapeHtml(s.cedula)} &nbsp; <b>Tel:</b> ${escapeHtml(s.tel)}</div>
          <div class="cardLine"><b>Email:</b> ${escapeHtml(s.email)}</div>
          <div class="cardLine"><b>Equipo:</b> ${escapeHtml(s.marca)} ${escapeHtml(s.modelo)}</div>
          <div class="cardLine"><b>IMEI 1:</b> ${escapeHtml(s.imei1)}</div>
          ${s.imei2 ? `<div class="cardLine"><b>IMEI 2:</b> ${escapeHtml(s.imei2)}</div>` : ""}
          <div class="cardLine"><b>Valor:</b> ${escapeHtml(s.valor)} &nbsp; <b>M√©todo:</b> ${escapeHtml(s.metodo)}</div>
          ${s.obs ? `<div class="cardLine"><b>Obs:</b> ${escapeHtml(s.obs)}</div>` : ""}
          <div class="small">${nowStr(s.createdAt)}</div>
          <div class="btnRow" style="margin-top:10px;">
            <button class="btn btnPurple" data-act="qr">üî≥ QR</button>
            <button class="btn" data-act="print">üñ®Ô∏è Ticket</button>
            ${currentRole==="ADMIN" ? `<button class="btn btnDanger" data-act="del">üóëÔ∏è Borrar</button>` : ""}
          </div>
        `;
        div.querySelector('[data-act="qr"]').onclick = ()=> showQR("Venta #"+padNum(s.num), "V-" + padNum(s.num));
        div.querySelector('[data-act="print"]').onclick = ()=> printSale(s);
        const delBtn = div.querySelector('[data-act="del"]');
        if(delBtn) delBtn.onclick = ()=> saleDelete(s.num);
        box.appendChild(div);
      });
    }

    /***********************
     * INVENTORY
     ***********************/
    function getInv(){ return jget(LS.inv, []); }
    function setInv(arr){ jset(LS.inv, arr); }

    function invClearForm(){
      $("i_code").value = "";
      $("i_name").value = "";
      $("i_brand").value = "";
      $("i_desc").value = "";
      $("i_cost").value = "";
      $("i_price").value = "";
      $("i_stock").value = "";
      $("i_min").value = "";
      $("i_photo").value = "";
      $("i_photoPreview").innerHTML = "";
      setTimeout(()=> $("i_code").focus(), 30);
    }

    async function invSave(){
      const code = $("i_code").value.trim();
      const name = $("i_name").value.trim();
      const brand= $("i_brand").value.trim();
      const desc = $("i_desc").value.trim();
      const cost = $("i_cost").value.trim();
      const price= $("i_price").value.trim();
      const stock= $("i_stock").value.trim();
      const min  = $("i_min").value.trim();

      if(!code || !name || !brand || !stock){
        showToast("Completa: c√≥digo, nombre, marca y stock.");
        return;
      }
      learnBrand(brand);

      let photo = "";
      const f = $("i_photo").files && $("i_photo").files[0];
      if(f){
        try{ photo = await fileToDataURLResized(f, 900, 900, 0.82); }catch(e){}
      }

      const arr = getInv();
      const idx = arr.findIndex(p=>String(p.code) === code);

      const item = {
        code, name, brand, desc,
        cost, price,
        stock: Number(stock)||0,
        min: Number(min)||0,
        photo,
        updatedAt: Date.now(),
        createdAt: idx >= 0 ? arr[idx].createdAt : Date.now()
      };

      if(idx >= 0){
        const ok = confirm("Ese c√≥digo ya existe. ¬øActualizarlo?");
        if(!ok) return;
        if(!photo) item.photo = arr[idx].photo || "";
        arr[idx] = item;
      }else{
        arr.push(item);
      }

      arr.sort((a,b)=>{
        const an = Number(a.code), bn = Number(b.code);
        if(Number.isFinite(an) && Number.isFinite(bn)) return an-bn;
        return String(a.code).localeCompare(String(b.code), "es", {sensitivity:"base"});
      });

      setInv(arr);
      renderInventory();
      showToast("Producto guardado.");
      invClearForm();
    }

    function invDelete(code){
      if(currentRole !== "ADMIN"){ showToast("Solo ADMIN puede borrar."); return; }
      if(!confirm("¬øBorrar producto c√≥digo: " + code + "?")) return;
      setInv(getInv().filter(p=>p.code !== code));
      renderInventory();
      showToast("Producto borrado.");
    }

    function renderInventory(){
      const box = $("invList");
      box.innerHTML = "";
      const q = ($("invSearch").value||"").trim().toLowerCase();
      const arr = getInv().slice();

      const filtered = !q ? arr : arr.filter(p=>{
        const blob = [p.code,p.name,p.brand,p.desc].join(" ").toLowerCase();
        return blob.includes(q);
      });

      if(!filtered.length){
        box.innerHTML = `<div class="card"><div class="cardTitle">Sin productos</div><div class="small">No hay resultados.</div></div>`;
        return;
      }

      filtered.forEach(p=>{
        const low = (Number(p.min)||0) > 0 && (Number(p.stock)||0) <= (Number(p.min)||0);
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="cardTitle">${escapeHtml(p.name)} ${low ? ' <span style="color:#ffb3b3;">(ALERTA)</span>' : ""}</div>
          <div class="cardLine"><b>C√≥digo:</b> ${escapeHtml(p.code)}</div>
          <div class="cardLine"><b>Marca:</b> ${escapeHtml(p.brand)}</div>
          <div class="cardLine"><b>Stock:</b> ${escapeHtml(String(p.stock))} &nbsp; <b>M√≠n:</b> ${escapeHtml(String(p.min||0))}</div>
          ${p.price ? `<div class="cardLine"><b>Precio:</b> ${escapeHtml(String(p.price))}</div>` : ""}
          ${p.desc ? `<div class="cardLine"><b>Desc:</b> ${escapeHtml(p.desc)}</div>` : ""}
          ${p.photo ? `<img src="${p.photo}" alt="foto" style="width:100%;margin-top:10px;border-radius:14px;border:1px solid rgba(255,255,255,.12)" />` : ""}
          <div class="btnRow" style="margin-top:10px;">
            <button class="btn btnGreen" data-act="qr">üî≥ QR</button>
            ${currentRole==="ADMIN" ? `<button class="btn btnDanger" data-act="del">üóëÔ∏è Borrar</button>` : ""}
          </div>
        `;
        div.querySelector('[data-act="qr"]').onclick = ()=> showQR("Producto", "INV-" + p.code);
        const delBtn = div.querySelector('[data-act="del"]');
        if(delBtn) delBtn.onclick = ()=> invDelete(p.code);
        box.appendChild(div);
      });
    }

    /***********************
     * GLOBAL SEARCH
     ***********************/
    function renderGlobalResults(query){
      const box = $("globalResults");
      box.innerHTML = "";
      const q = (query||"").trim().toLowerCase();
      if(!q){
        box.innerHTML = `<div class="card"><div class="cardTitle">Escribe para buscar</div><div class="small">Busca en √≥rdenes, ventas e inventario.</div></div>`;
        return;
      }

      const hits = [];
      getOrders().forEach(o=>{
        const blob = [o.num,o.id,o.cliente,o.cedula,o.tel,o.email,o.marca,o.modelo,o.falla].join(" ").toLowerCase();
        if(blob.includes(q)) hits.push({type:"Orden", label:`Orden #${padNum(o.num)} - ${o.cliente}`, view:"orders"});
      });
      getSales().forEach(s=>{
        const blob = [s.num,s.id,s.cliente,s.cedula,s.tel,s.email,s.marca,s.modelo,s.imei1,s.imei2,s.valor].join(" ").toLowerCase();
        if(blob.includes(q)) hits.push({type:"Venta", label:`Venta #${padNum(s.num)} - ${s.cliente}`, view:"sales"});
      });
      getInv().forEach(p=>{
        const blob = [p.code,p.name,p.brand,p.desc].join(" ").toLowerCase();
        if(blob.includes(q)) hits.push({type:"Inventario", label:`${p.code} - ${p.name}`, view:"inventory"});
      });

      if(!hits.length){
        box.innerHTML = `<div class="card"><div class="cardTitle">Sin resultados</div><div class="small">No se encontr√≥ coincidencia.</div></div>`;
        return;
      }

      hits.slice(0,20).forEach(h=>{
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="cardTitle">${escapeHtml(h.type)}</div>
          <div class="cardLine">${escapeHtml(h.label)}</div>
          <div class="btnRow" style="margin-top:10px;">
            <button class="btn btnBlue" type="button">Abrir</button>
          </div>
        `;
        div.querySelector("button").onclick = ()=> switchView(h.view);
        box.appendChild(div);
      });
    }

    /***********************
     * CSV / BACKUP JSON
     ***********************/
    function csvEscape(v){
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    }
    function downloadFile(filename, content, mime){
      const blob = new Blob([content], {type:mime});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(a.href), 800);
    }

    function exportCsvOrders(){
      const arr = getOrders().slice().sort((a,b)=>a.num-b.num);
      const header = ["num","fecha","cliente","cedula","tel","email","marca","modelo","falla","tiene_firma","fotos"];
      const rows = arr.map(o=>[
        padNum(o.num), nowStr(o.createdAt),
        o.cliente,o.cedula,o.tel,o.email,o.marca,o.modelo,o.falla,
        o.signature ? "SI":"NO", (o.photos||[]).length
      ]);
      const csv = [header.join(","), ...rows.map(r=>r.map(csvEscape).join(","))].join("\n");
      downloadFile("ordenes.csv", csv, "text/csv;charset=utf-8");
    }
    function exportCsvSales(){
      const arr = getSales().slice().sort((a,b)=>a.num-b.num);
      const header = ["num","fecha","cliente","cedula","tel","email","marca","modelo","imei1","imei2","valor","metodo","obs"];
      const rows = arr.map(s=>[
        padNum(s.num), nowStr(s.createdAt),
        s.cliente,s.cedula,s.tel,s.email,s.marca,s.modelo,s.imei1,s.imei2,
        s.valor,s.metodo,s.obs
      ]);
      const csv = [header.join(","), ...rows.map(r=>r.map(csvEscape).join(","))].join("\n");
      downloadFile("ventas.csv", csv, "text/csv;charset=utf-8");
    }
    function exportCsvInv(){
      const arr = getInv();
      const header = ["codigo","nombre","marca","desc","costo","precio","stock","min"];
      const rows = arr.map(p=>[p.code,p.name,p.brand,p.desc,p.cost,p.price,p.stock,p.min]);
      const csv = [header.join(","), ...rows.map(r=>r.map(csvEscape).join(","))].join("\n");
      downloadFile("inventario.csv", csv, "text/csv;charset=utf-8");
    }

    function backupJson(){
      const data = {
        version: 1,
        exportedAt: Date.now(),
        settings: getSettings(),
        creds: getCreds(),
        counters: {
          orderCounter: getNum(LS.orderCounter, START_ORDER),
          saleCounter: getNum(LS.saleCounter, START_SALE)
        },
        orders: getOrders(),
        sales: getSales(),
        inventory: getInv(),
        learned: {
          brands: jget(LS.brands, []),
          emailDomains: getEmailDomains()
        }
      };
      downloadFile("backup_technology_experts.json", JSON.stringify(data, null, 2), "application/json;charset=utf-8");
    }

    async function importJson(file){
      const txt = await file.text();
      let data = null;
      try{ data = JSON.parse(txt); }catch(e){ showToast("JSON inv√°lido."); return; }
      if(!confirm("¬øImportar backup? Esto reemplaza los datos actuales.")) return;

      if(data.settings) jset(LS.settings, data.settings);
      if(data.creds) jset(LS.creds, data.creds);

      if(data.counters){
        if(Number.isFinite(Number(data.counters.orderCounter))) setNum(LS.orderCounter, Number(data.counters.orderCounter));
        if(Number.isFinite(Number(data.counters.saleCounter)))  setNum(LS.saleCounter, Number(data.counters.saleCounter));
      }
      if(Array.isArray(data.orders)) jset(LS.orders, data.orders);
      if(Array.isArray(data.sales)) jset(LS.sales, data.sales);
      if(Array.isArray(data.inventory)) jset(LS.inv, data.inventory);

      if(data.learned){
        if(Array.isArray(data.learned.brands)) jset(LS.brands, data.learned.brands);
        if(Array.isArray(data.learned.emailDomains)) jset(LS.emailDomains, data.learned.emailDomains);
      }

      applyBusinessName();
      buildBrandDatalists();
      refreshOrderBadge();
      refreshSaleBadge();
      renderOrders();
      renderSales();
      renderInventory();
      showToast("Importaci√≥n completa.");
        }
    /***********************
     * SCANNER
     ***********************/
    let scanStream = null;
    let scanDetector = null;
    let scanLoopRAF = null;
    let scanOnResult = null;

    async function openScanner(title, onResult){
      $("scanTitle").textContent = title;
      $("scanStatus").textContent = "Abriendo c√°mara...";
      $("scanManual").value = "";
      scanOnResult = onResult;

      show($("modalScan"));

      if("BarcodeDetector" in window){
        try{
          const formats = ["qr_code","ean_13","ean_8","code_128","code_39","code_93","upc_a","upc_e","itf","codabar","data_matrix","aztec","pdf417"];
          scanDetector = new BarcodeDetector({formats});
        }catch(e){ scanDetector = null; }
      }

      try{
        scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
      }catch(e){
        $("scanStatus").textContent = "No se pudo abrir la c√°mara. Revisa permisos del navegador.";
        showToast("Permiso de c√°mara denegado o no disponible.");
        return;
      }

      const v = $("scanVideo");
      v.srcObject = scanStream;
      await v.play();

      if(!scanDetector){
        $("scanStatus").textContent = "Este navegador no soporta lector autom√°tico. Escribe el c√≥digo manual.";
        return;
      }

      $("scanStatus").textContent = "Apunta al c√≥digo (QR o barras). Detectando...";
      runScanLoop();
    }

    function stopScanner(){
      if(scanLoopRAF) cancelAnimationFrame(scanLoopRAF);
      scanLoopRAF = null;

      const v = $("scanVideo");
      try{ v.pause(); }catch(e){}
      v.srcObject = null;

      if(scanStream){
        scanStream.getTracks().forEach(t=>t.stop());
      }
      scanStream = null;
      scanDetector = null;
      scanOnResult = null;

      hide($("modalScan"));
    }

    function runScanLoop(){
      const v = $("scanVideo");
      const c = document.createElement("canvas");
      const ctx = c.getContext("2d");

      const tick = async ()=>{
        if(!scanStream || !scanDetector) return;

        const w = v.videoWidth || 640;
        const h = v.videoHeight || 480;
        c.width = w; c.height = h;
        ctx.drawImage(v, 0,0,w,h);

        try{
          const codes = await scanDetector.detect(c);
          if(codes && codes.length){
            const raw = codes[0].rawValue || "";
            if(raw){
              $("scanStatus").textContent = "Detectado: " + raw;
              const cb = scanOnResult;
              stopScanner();
              if(cb) cb(raw);
              showToast("Escaneado: " + raw);
              return;
            }
          }
        }catch(e){}
        scanLoopRAF = requestAnimationFrame(tick);
      };

      scanLoopRAF = requestAnimationFrame(tick);
    }

    /***********************
     * HARD REFRESH
     ***********************/
    async function hardRefresh(){
      try{
        if("caches" in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k=>caches.delete(k)));
        }
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r=>r.unregister()));
        }
      }catch(e){}
      showToast("Cach√© limpiado. Recargando...");
      setTimeout(()=>location.reload(), 600);
    }

    /***********************
     * EVENTS
     ***********************/
    function wire(){
      document.querySelectorAll(".tile").forEach(btn=>{
        btn.addEventListener("click", ()=> openLogin(btn.dataset.role));
      });

      $("closeLogin").onclick = closeLogin;
      $("btnDoLogin").onclick = doLogin;

      $("toggleEye").onclick = ()=>{
        const p = $("loginPass");
        if(p.type === "password"){ p.type = "text"; $("toggleEye").textContent = "üôà"; }
        else { p.type = "password"; $("toggleEye").textContent = "üëÅ"; }
        p.focus();
      };

      $("btnLogout").onclick = ()=>{
        clearSession();
        hide($("appScreen"));
        show($("loginScreen"));
        showToast("Sesi√≥n cerrada.");
      };

      document.querySelectorAll(".tabBtn").forEach(b=>{
        b.onclick = ()=> switchView(b.dataset.view);
      });

      $("goOrders").onclick = ()=> switchView("orders");
      $("goSales").onclick = ()=> switchView("sales");
      $("goInv").onclick = ()=> switchView("inventory");

      $("globalSearch").addEventListener("input", (e)=> renderGlobalResults(e.target.value));

      // Orders
      $("btnOrderNew").onclick = ()=>{
        hide($("orderListPanel")); show($("orderFormPanel"));
        orderClearForm(); refreshOrderBadge();
      };
      $("btnOrderToggleList").onclick = ()=>{
        hide($("orderFormPanel")); show($("orderListPanel"));
        renderOrders();
      };
      $("btnOrderBackToForm").onclick = ()=>{
        hide($("orderListPanel")); show($("orderFormPanel"));
      };
      $("btnSigClear").onclick = ()=>{ sigClear(); showToast("Firma borrada."); };
      $("btnOrderSave").onclick = orderSave;
      $("orderSearch").addEventListener("input", renderOrders);

      $("o_email").addEventListener("input", (e)=> updateEmailDatalist("emailDatalist", e.target.value));
      $("o_email").addEventListener("blur", (e)=> learnEmailDomain(e.target.value));
      $("s_email").addEventListener("input", (e)=> updateEmailDatalist("emailDatalist2", e.target.value));
      $("s_email").addEventListener("blur", (e)=> learnEmailDomain(e.target.value));

      $("o_marca").addEventListener("blur", (e)=> learnBrand(e.target.value));
      $("s_marca").addEventListener("blur", (e)=> learnBrand(e.target.value));
      $("i_brand").addEventListener("blur", (e)=> learnBrand(e.target.value));

      $("o_fotos").addEventListener("change", async ()=>{
        const photos = await orderCollectPhotos();
        renderPhotoThumbs("o_fotosPreview", photos);
      });

      // Signature pointer events
      const canvas = $("sigCanvas");
      canvas.addEventListener("pointerdown", (e)=>{ canvas.setPointerCapture(e.pointerId); sigStart(e); });
      canvas.addEventListener("pointermove", sigMove);
      canvas.addEventListener("pointerup", sigEnd);
      canvas.addEventListener("pointercancel", sigEnd);

      // Sales
      $("btnSaleNew").onclick = ()=>{
        hide($("saleListPanel")); show($("saleFormPanel"));
        saleClearForm(); refreshSaleBadge();
      };
      $("btnSaleToggleList").onclick = ()=>{
        hide($("saleFormPanel")); show($("saleListPanel"));
        renderSales();
      };
      $("btnSaleBackToForm").onclick = ()=>{
        hide($("saleListPanel")); show($("saleFormPanel"));
      };
      $("btnSaleSave").onclick = saleSave;
      $("saleSearch").addEventListener("input", renderSales);

      // Inventory
      $("btnInvNew").onclick = ()=>{
        hide($("invListPanel")); show($("invFormPanel"));
        invClearForm();
      };
      $("btnInvToggleList").onclick = ()=>{
        hide($("invFormPanel")); show($("invListPanel"));
        renderInventory();
      };
      $("btnInvBackToForm").onclick = ()=>{
        hide($("invListPanel")); show($("invFormPanel"));
      };
      $("btnInvSave").onclick = invSave;
      $("invSearch").addEventListener("input", renderInventory);

      $("i_photo").addEventListener("change", async ()=>{
        const f = $("i_photo").files && $("i_photo").files[0];
        if(!f){ $("i_photoPreview").innerHTML=""; return; }
        const data = await fileToDataURLResized(f, 900, 900, 0.82);
        renderPhotoThumbs("i_photoPreview", [data]);
      });

      // Scanner
      $("closeScan").onclick = stopScanner;
      $("useManualCode").onclick = ()=>{
        const v = $("scanManual").value.trim();
        if(!v){ showToast("Escribe un c√≥digo."); return; }
        const cb = scanOnResult;
        stopScanner();
        if(cb) cb(v);
      };

      $("btnScanInvCode").onclick = ()=> openScanner("Escanear c√≥digo de producto", (val)=>{ $("i_code").value = val; $("i_name").focus(); });
      $("btnScanImei1").onclick = ()=> openScanner("Escanear IMEI 1", (val)=>{ $("s_imei1").value = val; });
      $("btnScanImei2").onclick = ()=> openScanner("Escanear IMEI 2", (val)=>{ $("s_imei2").value = val; });

      // QR
      $("closeQR").onclick = ()=> hide($("modalQR"));

      // Admin
      $("btnCsvOrders").onclick = ()=> currentRole==="ADMIN" ? exportCsvOrders() : showToast("Solo ADMIN.");
      $("btnCsvSales").onclick = ()=> currentRole==="ADMIN" ? exportCsvSales() : showToast("Solo ADMIN.");
      $("btnCsvInv").onclick   = ()=> currentRole==="ADMIN" ? exportCsvInv()   : showToast("Solo ADMIN.");
      $("btnBackupJson").onclick = ()=> currentRole==="ADMIN" ? backupJson() : showToast("Solo ADMIN.");

      $("importJsonFile").addEventListener("change", async (e)=>{
        if(currentRole!=="ADMIN"){ showToast("Solo ADMIN."); e.target.value=""; return; }
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        await importJson(f);
        e.target.value="";
      });

      $("btnSaveBizName").onclick = ()=>{
        if(currentRole!=="ADMIN") return showToast("Solo ADMIN.");
        const v = $("setBizName").value.trim();
        if(!v){ showToast("Escribe un nombre."); return; }
        setBusinessName(v);
        showToast("Nombre guardado.");
      };

      $("btnSaveCreds").onclick = ()=>{
        if(currentRole!=="ADMIN") return showToast("Solo ADMIN.");
        const c = getCreds();
        c.ADMIN.user = $("c_admin_user").value.trim() || c.ADMIN.user;
        c.ADMIN.pass = $("c_admin_pass").value.trim() || c.ADMIN.pass;
        c.VENTAS.user = $("c_sales_user").value.trim() || c.VENTAS.user;
        c.VENTAS.pass = $("c_sales_pass").value.trim() || c.VENTAS.pass;
        c.TECNICO.user = $("c_tech_user").value.trim() || c.TECNICO.user;
        c.TECNICO.pass = $("c_tech_pass").value.trim() || c.TECNICO.pass;
        saveCreds(c);
        showToast("Credenciales guardadas.");
      };

      $("btnResetCounters").onclick = ()=>{
        if(currentRole!=="ADMIN") return showToast("Solo ADMIN.");
        if(!confirm("¬øReiniciar contadores? (√ìrdenes a 2100 y Ventas a 315)")) return;
        setNum(LS.orderCounter, START_ORDER);
        setNum(LS.saleCounter, START_SALE);
        refreshOrderBadge(); refreshSaleBadge();
        showToast("Contadores reiniciados.");
      };

      $("btnWipeAll").onclick = ()=>{
        if(currentRole!=="ADMIN") return showToast("Solo ADMIN.");
        if(!confirm("¬øBorrar TODO? Esto elimina √≥rdenes/ventas/inventario en este dispositivo.")) return;
        jset(LS.orders, []); jset(LS.sales, []); jset(LS.inv, []);
        renderOrders(); renderSales(); renderInventory();
        renderGlobalResults($("globalSearch").value||"");
        showToast("Datos borrados.");
      };

      $("btnHelp").onclick = ()=>{
        alert(
          "Ayuda r√°pida:\n\n" +
          "1) Para entrar: toca un rol ‚Üí usuario y contrase√±a.\n" +
          "2) √ìrdenes: firma obligatoria.\n" +
          "3) Ventas: IMEI 1 obligatorio, IMEI 2 opcional.\n" +
          "4) Inventario: usa Scan para leer c√≥digos.\n" +
          "5) Si no cambia el dise√±o, usa 'Actualizar / limpiar cach√©'."
        );
      };

      $("btnHardRefresh").onclick = hardRefresh;

      window.addEventListener("resize", ()=>{ if(!$("appScreen").classList.contains("hidden")) resizeSig(); });
    }

    /***********************
     * BOOT
     ***********************/
    (function boot(){
      ensureInit();
      applyBusinessName();
      buildBrandDatalists();

      const c = getCreds();
      $("c_admin_user").value = c.ADMIN.user;
      $("c_admin_pass").value = "";
      $("c_sales_user").value = c.VENTAS.user;
      $("c_sales_pass").value = "";
      $("c_tech_user").value = c.TECNICO.user;
      $("c_tech_pass").value = "";

      requestAnimationFrame(()=>{ resizeSig(); sigClear(); });

      wire();
      refreshOrderBadge();
      refreshSaleBadge();

      const sess = loadSession();
      if(sess && sess.role) enterApp(sess.role);
    })();
  </script>
  <script>
  // Registrar Service Worker para modo offline (PWA)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js")
        .then(() => console.log("‚úÖ SW listo"))
        .catch((e) => console.log("‚ùå SW error", e));
    });
  }
  </script>

</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Technology Expert‚Äôs</title>

  <style>
    :root{
      --blue1:#0b2dff; /* azul rey */
      --blue2:#001b8f;
      --black:#0b0b0b;
      --white:#ffffff;
      --card: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.18);
      --shadow: 0 18px 40px rgba(0,0,0,.20);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.14), transparent 60%),
                  radial-gradient(900px 520px at 80% 30%, rgba(255,255,255,.10), transparent 55%),
                  linear-gradient(180deg, var(--blue1), var(--blue2));
      color: var(--white);
      min-height:100vh;
    }

    .wrap{
      width: min(980px, 92vw);
      margin: 0 auto;
      padding: 26px 0 40px;
    }

    .hero{
      padding: 26px 18px 18px;
    }
    .brand{
      font-size: 44px;
      line-height: 1.05;
      font-weight: 900;
      letter-spacing: .2px;
      margin:0 0 6px;
      text-shadow: 0 10px 30px rgba(0,0,0,.20);
    }
    .subtitle{
      margin:0;
      opacity:.92;
      font-weight: 700;
      font-size: 15px;
    }

    .glass{
      margin-top: 16px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .btn{
      width: 100%;
      border: 0;
      border-radius: 16px;
      padding: 14px 14px;
      background: var(--black);
      color: var(--white);
      font-weight: 900;
      font-size: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .btn:active{ transform: scale(.99); }
    .btn.secondary{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.20);
    }
    .btn.small{
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      justify-content: center;
      box-shadow:none;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.25);
    }
    .btn.row{
      justify-content: space-between;
      padding: 16px 18px;
      font-size: 17px;
      border-radius: 18px;
    }

    .pillRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .sectionTitle{
      font-weight: 900;
      font-size: 18px;
      margin: 0 0 10px;
    }

    .hidden{ display:none !important; }

    .panel{
      margin-top: 16px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 22px;
      padding: 16px;
    }

    .panel h2{
      margin: 0 0 8px;
      font-size: 28px;
      font-weight: 900;
    }
    .panel h3{
      margin: 16px 0 10px;
      font-size: 18px;
      font-weight: 900;
    }

    .badgeNum{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.20);
      font-weight: 900;
      margin: 10px 0 4px;
    }
    .bigNum{
      font-size: 20px;
      letter-spacing: .4px;
    }

    .inputs{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    input, textarea, select{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      color: #fff;
      font-weight: 800;
      outline: none;
      font-size: 15px;
    }
    textarea{ min-height: 86px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.80); font-weight: 800; }
    label.smallNote{
      display:block;
      margin-top: 6px;
      opacity:.9;
      font-weight: 700;
      font-size: 13px;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 600px){
      .grid2{ grid-template-columns:1fr; }
      .row2{ grid-template-columns:1fr; }
      .brand{ font-size: 38px; }
    }

    .actionsRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .list{
      margin-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .card{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 18px;
      padding: 14px;
    }
    .card .title{
      font-weight: 900;
      font-size: 16px;
      margin-bottom: 6px;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr;
      gap: 2px;
      font-weight: 800;
      opacity: .98;
    }
    .muted{ opacity: .9; font-weight: 800; }

    .sigBox{
      background: rgba(255,255,255,.08);
      border: 2px dashed rgba(255,255,255,.35);
      border-radius: 16px;
      overflow:hidden;
    }
    canvas{
      width:100%;
      height: 180px;
      display:block;
      background: rgba(0,0,0,.08);
      touch-action: none;
    }

    .danger{
      background:#c20000;
    }

    .qrBox{
      margin-top: 10px;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.20);
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .qrRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    .qrImg{
      background:#fff;
      border-radius: 12px;
      padding: 8px;
      width: 220px;
      max-width: 100%;
    }
    .qrImg svg{ width:100%; height:auto; display:block; }

    .searchBox{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
    }
    .tip{
      margin-top: 6px;
      font-weight: 800;
      opacity: .9;
      font-size: 13px;
    }

    .tabbar{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .tabbtn{
      flex: 1;
      min-width: 180px;
    }
    .tabbtn.active{
      outline: 2px solid rgba(255,255,255,.35);
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(0,0,0,.80);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      font-weight: 800;
      display:none;
      z-index: 99;
      max-width: 92vw;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1 class="brand">Technology Expert‚Äôs</h1>
      <p class="subtitle">√ìrdenes + ventas. Sin servidores (por ahora). Exporta CSV y Backup JSON para la PC.</p>

      <div id="home" class="glass">
        <div class="grid2">
          <button class="btn row" id="goOrden">üßæ <span>Orden de servicio</span> <span>‚Ä∫</span></button>
          <button class="btn row secondary" id="goVentas">üí≥ <span>Ventas</span> <span>‚Ä∫</span></button>
        </div>

        <div class="pillRow">
          <button class="btn small" id="adminBtn">üîí Admin PIN</button>
          <button class="btn small" id="scanBtn">üì∑ Escanear (QR / Barras)</button>
          <button class="btn small" id="exportOrdenCsv">‚¨áÔ∏è CSV √ìrdenes</button>
          <button class="btn small" id="exportVentaCsv">‚¨áÔ∏è CSV Ventas</button>
          <button class="btn small" id="backupBtn">üì¶ Backup JSON</button>
          <button class="btn small" id="importBtn">üì• Importar Backup</button>
        </div>

        <div class="searchBox">
          <input id="globalSearch" placeholder="Buscar por #, nombre, c√©dula, tel, correo, marca, modelo, IMEI..." />
          <div class="tip">Tip: escribe ‚Äú2100‚Äù (orden) o un IMEI y te lo filtra.</div>
        </div>
      </div>

      <div id="resultsPanel" class="panel hidden">
        <h2>Resultados</h2>
        <div class="actionsRow">
          <button class="btn small" id="backHome1">‚¨ÖÔ∏è Volver</button>
          <button class="btn small danger" id="clearSearch">üßπ Limpiar b√∫squeda</button>
        </div>
        <div id="resultsList" class="list"></div>
      </div>

      <!-- ORDEN -->
      <div id="ordenPanel" class="panel hidden">
        <div class="actionsRow">
          <button class="btn small" id="backHome2">‚¨ÖÔ∏è Inicio</button>
          <button class="btn small secondary" id="ordenNueva">üÜï Nueva orden (limpiar)</button>
        </div>

        <h2>Orden de Servicio</h2>
        <div class="badgeNum">
          <span>üßæ N√∫mero:</span>
          <span class="bigNum" id="ordenNumLabel">#----</span>
        </div>

        <h3>Datos del cliente</h3>
        <div class="inputs">
          <input id="o_cliente" placeholder="Nombre del cliente" autocomplete="name" />
          <div class="row2">
            <input id="o_cedula" placeholder="C√©dula" inputmode="numeric" />
            <input id="o_tel" placeholder="Celular" inputmode="tel" autocomplete="tel" />
          </div>

          <input id="o_correo" placeholder="Correo electr√≥nico" autocomplete="email" list="emailDomains" />
          <datalist id="emailDomains"></datalist>
        </div>

        <h3>Equipo</h3>
        <div class="inputs">
          <input id="o_marca" placeholder="Marca del celular" list="brandList" />
          <datalist id="brandList"></datalist>

          <input id="o_modelo" placeholder="Modelo del celular" />
          <textarea id="o_falla" placeholder="Falla reportada"></textarea>
        </div>

        <h3>Firma del cliente (OBLIGATORIA)</h3>
        <label class="smallNote">Firma con el dedo. Si no firmas, NO deja guardar.</label>
        <div class="sigBox">
          <canvas id="sigCanvas"></canvas>
        </div>
        <div class="actionsRow">
          <button class="btn secondary" id="clearSig">üßº Borrar firma</button>
          <button class="btn" id="guardarOrden">üíæ Guardar orden</button>
        </div>

        <div id="ordenQrBox" class="qrBox hidden">
          <div class="qrRow">
            <div class="muted" id="ordenQrText">QR orden</div>
            <button class="btn small" id="printOrden">üñ®Ô∏è Imprimir</button>
          </div>
          <div class="qrImg" id="ordenQrImg"></div>
        </div>

        <h3>√ìrdenes guardadas</h3>
        <div id="ordenList" class="list"></div>
      </div>

      <!-- VENTAS -->
      <div id="ventaPanel" class="panel hidden">
        <div class="actionsRow">
          <button class="btn small" id="backHome3">‚¨ÖÔ∏è Inicio</button>
          <button class="btn small secondary" id="ventaNueva">üÜï Nueva venta (limpiar)</button>
        </div>

        <h2>Ventas</h2>
        <div class="badgeNum">
          <span>üí≥ N√∫mero:</span>
          <span class="bigNum" id="ventaNumLabel">#----</span>
        </div>

        <div class="tabbar">
          <button class="btn tabbtn active" id="tabVentaForm">üìù Nueva venta</button>
          <button class="btn tabbtn secondary" id="tabVentaList">üìö Ver ventas</button>
        </div>

        <div id="ventaForm">
          <h3>Cliente</h3>
          <div class="inputs">
            <input id="v_cliente" placeholder="Nombre del cliente" autocomplete="name" />
            <div class="row2">
              <input id="v_cedula" placeholder="C√©dula" inputmode="numeric" />
              <input id="v_tel" placeholder="Celular" inputmode="tel" autocomplete="tel" />
            </div>
          </div>

          <h3>Tipo de venta</h3>
          <div class="inputs">
            <select id="v_tipo">
              <option value="celular">Venta de celular</option>
              <option value="accesorio">Accesorio / repuesto</option>
              <option value="servicio">Servicio</option>
              <option value="otro">Otro</option>
            </select>
          </div>

          <div id="ventaCelularBox">
            <h3>Datos del celular (IMEI)</h3>
            <div class="inputs">
              <input id="v_marca" placeholder="Marca" list="brandList" />
              <input id="v_modelo" placeholder="Modelo" />
              <input id="v_imei1" placeholder="IMEI 1 (obligatorio)" inputmode="numeric" />
              <input id="v_imei2" placeholder="IMEI 2 (opcional)" inputmode="numeric" />
            </div>

            <h3>T√©rminos y condiciones (OBLIGATORIO aceptar)</h3>
            <div class="card">
              <div class="kv">
                <div>‚Ä¢ El cliente reconoce que debe registrar el/los IMEI ante el operador que va a usar.</div>
                <div>‚Ä¢ <b>No nos hacemos responsables si el cliente no registra los IMEI en la base de datos del operador.</b></div>
              </div>
            </div>
            <label class="smallNote">
              <input type="checkbox" id="v_terms" />
              Acepto los t√©rminos para esta venta de celular
            </label>
          </div>

          <h3>Pago</h3>
          <div class="inputs">
            <input id="v_desc" placeholder="Descripci√≥n (ej: Samsung A15 128GB)" />
            <div class="row2">
              <input id="v_total" placeholder="Total ($)" inputmode="decimal" />
              <select id="v_pago">
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
                <option value="tarjeta">Tarjeta</option>
              </select>
            </div>
          </div>

          <div class="actionsRow">
            <button class="btn" id="guardarVenta">üíæ Guardar venta</button>
          </div>

          <div id="ventaQrBox" class="qrBox hidden">
            <div class="qrRow">
              <div class="muted" id="ventaQrText">QR venta</div>
              <button class="btn small" id="printVenta">üñ®Ô∏è Imprimir</button>
            </div>
            <div class="qrImg" id="ventaQrImg"></div>
          </div>
        </div>

        <div id="ventaListPanel" class="hidden">
          <h3>Ventas guardadas</h3>
          <div id="ventaList" class="list"></div>
        </div>
      </div>

      <!-- ADMIN -->
      <div id="adminPanel" class="panel hidden">
        <div class="actionsRow">
          <button class="btn small" id="backHome4">‚¨ÖÔ∏è Inicio</button>
        </div>
        <h2>Admin (PIN)</h2>
        <div class="inputs">
          <input id="pinInput" placeholder="PIN" inputmode="numeric" />
          <button class="btn" id="pinEnter">Entrar</button>
          <label class="smallNote">PIN por defecto: <b>1234</b> (puedes cambiarlo aqu√≠ adentro).</label>
        </div>

        <div id="adminTools" class="hidden">
          <h3>Herramientas</h3>
          <div class="pillRow">
            <button class="btn small" id="changePinBtn">üîÅ Cambiar PIN</button>
            <button class="btn small danger" id="wipeAllBtn">üß® Borrar TODO (√≥rdenes + ventas)</button>
          </div>

          <h3>Importar / Exportar</h3>
          <div class="pillRow">
            <button class="btn small" id="exportOrdenCsv2">‚¨áÔ∏è CSV √ìrdenes</button>
            <button class="btn small" id="exportVentaCsv2">‚¨áÔ∏è CSV Ventas</button>
            <button class="btn small" id="backupBtn2">üì¶ Backup JSON</button>
            <button class="btn small" id="importBtn2">üì• Importar Backup</button>
          </div>
        </div>
      </div>

      <!-- SCANNER (solo ayuda: pega manual) -->
      <div id="scanPanel" class="panel hidden">
        <div class="actionsRow">
          <button class="btn small" id="backHome5">‚¨ÖÔ∏è Inicio</button>
        </div>
        <h2>Escanear (QR / Barras)</h2>
        <div class="card">
          <div class="kv">
            <div>üìå En celular: usa la c√°mara/lector del tel√©fono para copiar el c√≥digo y p√©galo aqu√≠.</div>
            <div>üìå Para PC: cuando tengas PC lo conectamos con lector USB (act√∫a como teclado).</div>
          </div>
        </div>
        <div class="inputs">
          <input id="scanInput" placeholder="Pega aqu√≠ el c√≥digo (QR o barras 1D)" />
          <button class="btn" id="scanSearch">Buscar en sistema</button>
        </div>
      </div>

      <input id="importFile" type="file" accept="application/json" class="hidden" />

      <div class="toast" id="toast"></div>

    </div>
  </div>

<script>
/** ==========================
    STORAGE KEYS
========================== */
const LS = {
  orders: "te_orders",
  sales: "te_sales",
  orderCounter: "te_orderCounter",
  saleCounter: "te_saleCounter",
  pin: "te_adminPin",
  brands: "te_brands_learned"
};

// defaults
function getCounter(key, fallback){
  const v = Number(localStorage.getItem(key));
  return Number.isFinite(v) && v>0 ? v : fallback;
}
function setCounter(key, val){
  localStorage.setItem(key, String(val));
}

function getArr(key){
  try{ return JSON.parse(localStorage.getItem(key) || "[]"); } catch(e){ return []; }
}
function setArr(key, arr){
  localStorage.setItem(key, JSON.stringify(arr));
}

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=> t.style.display="none", 2200);
}

/** ==========================
    EMAIL SUGGESTIONS (datalist)
========================== */
const emailDomains = [
  "gmail.com","hotmail.com","outlook.com","icloud.com","yahoo.com",
  "live.com","proton.me","protonmail.com"
];
function buildEmailDatalist(){
  const dl = document.getElementById("emailDomains");
  dl.innerHTML = "";
  emailDomains.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = "@"+d;
    dl.appendChild(opt);
  });
}
buildEmailDatalist();

/** ==========================
    BRAND AUTOCOMPLETE + LEARN
========================== */
const defaultBrands = [
  "Samsung","Xiaomi","Redmi","POCO","Realme","Huawei","Honor","Motorola","Nokia",
  "Apple","iPhone","iPad","Tecno","Infinix","Itel","OPPO","Vivo","OnePlus",
  "ZTE","Alcatel","Sony","LG","Google Pixel","Asus","Lenovo","TCL","Meizu",
  "BlackBerry","HTC","Micromax","Blu","Cubot","Doogee","Ulefone","Umidigi",
  "Nothing","Meitu","CAT","Fairphone","Sharp","Panasonic","Philips","Sagem",
  "Gionee","Wiko","Lava","Karbonn","QMobile","Coolpad","Hisense","Haier",
  "LeEco","Razer","Essential","InFocus","Kyocera","Fujitsu","NEC"
];

function getBrands(){
  const learned = getArr(LS.brands);
  const all = Array.from(new Set([...defaultBrands, ...learned]));
  all.sort((a,b)=>a.localeCompare(b, "es", {sensitivity:"base"}));
  return all;
}
function setLearnedBrand(name){
  const clean = (name||"").trim();
  if(!clean) return;
  const lowerAll = getBrands().map(x=>x.toLowerCase());
  if(lowerAll.includes(clean.toLowerCase())) return;
  const learned = getArr(LS.brands);
  learned.push(clean);
  setArr(LS.brands, learned);
  buildBrandDatalist();
}
function buildBrandDatalist(){
  const dl = document.getElementById("brandList");
  dl.innerHTML = "";
  getBrands().forEach(b=>{
    const opt = document.createElement("option");
    opt.value = b;
    dl.appendChild(opt);
  });
}
buildBrandDatalist();

/** ==========================
    PANELS NAV
========================== */
const home = document.getElementById("home");
const resultsPanel = document.getElementById("resultsPanel");
const ordenPanel = document.getElementById("ordenPanel");
const ventaPanel = document.getElementById("ventaPanel");
const adminPanel = document.getElementById("adminPanel");
const scanPanel = document.getElementById("scanPanel");

function hideAll(){
  home.classList.add("hidden");
  resultsPanel.classList.add("hidden");
  ordenPanel.classList.add("hidden");
  ventaPanel.classList.add("hidden");
  adminPanel.classList.add("hidden");
  scanPanel.classList.add("hidden");
}
function showHome(){
  hideAll();
  home.classList.remove("hidden");
}
function showOrden(){
  hideAll();
  ordenPanel.classList.remove("hidden");
  refreshOrderNumberLabel();
  renderOrders();
}
function showVentas(){
  hideAll();
  ventaPanel.classList.remove("hidden");
  refreshSaleNumberLabel();
  renderSales();
  showVentaTab("form");
}
function showAdmin(){
  hideAll();
  adminPanel.classList.remove("hidden");
  document.getElementById("pinInput").value = "";
  document.getElementById("adminTools").classList.add("hidden");
}
function showScan(){
  hideAll();
  scanPanel.classList.remove("hidden");
  document.getElementById("scanInput").value = "";
}
function showResults(){
  hideAll();
  resultsPanel.classList.remove("hidden");
}

document.getElementById("goOrden").onclick = showOrden;
document.getElementById("goVentas").onclick = showVentas;
document.getElementById("adminBtn").onclick = showAdmin;
document.getElementById("scanBtn").onclick = showScan;

document.getElementById("backHome1").onclick = showHome;
document.getElementById("backHome2").onclick = showHome;
document.getElementById("backHome3").onclick = showHome;
document.getElementById("backHome4").onclick = showHome;
document.getElementById("backHome5").onclick = showHome;

/** ==========================
    COUNTERS
========================== */
function getNextOrderNumber(){
  return getCounter(LS.orderCounter, 2100);
}
function getNextSaleNumber(){
  return getCounter(LS.saleCounter, 315);
}
function refreshOrderNumberLabel(){
  document.getElementById("ordenNumLabel").textContent = "#"+getNextOrderNumber();
}
function refreshSaleNumberLabel(){
  document.getElementById("ventaNumLabel").textContent = "#"+getNextSaleNumber();
}

/** ==========================
    SIGNATURE (mandatory for orders)
========================== */
const canvas = document.getElementById("sigCanvas");
const ctx = canvas.getContext("2d");
let drawing = false;
let hasSignature = false;

function resizeCanvas(){
  // match display size
  const rect = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;
  canvas.width = Math.floor(rect.width * ratio);
  canvas.height = Math.floor(rect.height * ratio);
  ctx.setTransform(ratio,0,0,ratio,0,0);
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#111";
  // keep background transparent (we'll place on white in print)
  redrawSigBackground();
}
function redrawSigBackground(){
  // draw faint white bg
  ctx.save();
  ctx.globalAlpha = 0.0;
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
}
window.addEventListener("resize", resizeCanvas);
setTimeout(resizeCanvas, 100);

function getPos(e){
  const rect = canvas.getBoundingClientRect();
  if(e.touches && e.touches[0]){
    return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
  }
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

function startDraw(e){
  drawing = true;
  const p = getPos(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
  e.preventDefault?.();
}
function moveDraw(e){
  if(!drawing) return;
  const p = getPos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
  hasSignature = true;
  e.preventDefault?.();
}
function endDraw(){
  drawing = false;
}

canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", moveDraw);
window.addEventListener("mouseup", endDraw);

canvas.addEventListener("touchstart", startDraw, {passive:false});
canvas.addEventListener("touchmove", moveDraw, {passive:false});
canvas.addEventListener("touchend", endDraw);

document.getElementById("clearSig").onclick = ()=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);
  hasSignature = false;
  toast("Firma borrada");
};

function signatureToDataURL(){
  // export
  return canvas.toDataURL("image/png");
}

/** ==========================
    ORDER FORM
========================== */
const o_cliente = document.getElementById("o_cliente");
const o_cedula = document.getElementById("o_cedula");
const o_tel = document.getElementById("o_tel");
const o_correo = document.getElementById("o_correo");
const o_marca = document.getElementById("o_marca");
const o_modelo = document.getElementById("o_modelo");
const o_falla = document.getElementById("o_falla");

document.getElementById("ordenNueva").onclick = ()=>{
  o_cliente.value = "";
  o_cedula.value = "";
  o_tel.value = "";
  o_correo.value = "";
  o_marca.value = "";
  o_modelo.value = "";
  o_falla.value = "";
  ctx.clearRect(0,0,canvas.width,canvas.height);
  hasSignature = false;
  o_cliente.focus();
  refreshOrderNumberLabel();
  document.getElementById("ordenQrBox").classList.add("hidden");
  toast("Lista nueva orden");
};

document.getElementById("guardarOrden").onclick = ()=>{
  // required fields
  if(!o_cliente.value.trim() || !o_cedula.value.trim() || !o_tel.value.trim() || !o_correo.value.trim()
     || !o_marca.value.trim() || !o_modelo.value.trim() || !o_falla.value.trim()){
    alert("Completa todos los campos de la orden.");
    return;
  }
  if(!hasSignature){
    alert("La firma es obligatoria para guardar la orden.");
    return;
  }

  const num = getNextOrderNumber();
  const orders = getArr(LS.orders);

  const order = {
    type: "orden",
    numero: num,
    cliente: o_cliente.value.trim(),
    cedula: o_cedula.value.trim(),
    telefono: o_tel.value.trim(),
    correo: o_correo.value.trim(),
    marca: o_marca.value.trim(),
    modelo: o_modelo.value.trim(),
    falla: o_falla.value.trim(),
    firmaPng: signatureToDataURL(),
    fechaISO: new Date().toISOString()
  };

  orders.push(order);
  // keep asc
  orders.sort((a,b)=>a.numero-b.numero);
  setArr(LS.orders, orders);

  // increment counter
  setCounter(LS.orderCounter, num+1);

  // learn brand
  setLearnedBrand(order.marca);

  toast("Orden guardada #"+num);
  refreshOrderNumberLabel();
  renderOrders();

  // show QR
  showQR("orden", order);
};

function renderOrders(filter=""){
  const list = document.getElementById("ordenList");
  list.innerHTML = "";
  const orders = getArr(LS.orders);

  const f = (filter||"").trim().toLowerCase();
  const data = f ? orders.filter(o => orderMatches(o,f)) : orders;

  data.forEach(o=>{
    const card = document.createElement("div");
    card.className = "card";

    const t = document.createElement("div");
    t.className = "title";
    t.textContent = "Orden #"+o.numero;

    const kv = document.createElement("div");
    kv.className = "kv";
    kv.innerHTML = `
      <div>Cliente: <span class="muted">${escapeHtml(o.cliente)}</span></div>
      <div>C√©dula: <span class="muted">${escapeHtml(o.cedula)}</span></div>
      <div>Tel: <span class="muted">${escapeHtml(o.telefono)}</span></div>
      <div>Email: <span class="muted">${escapeHtml(o.correo)}</span></div>
      <div style="margin-top:6px">Marca: <span class="muted">${escapeHtml(o.marca)}</span></div>
      <div>Modelo: <span class="muted">${escapeHtml(o.modelo)}</span></div>
      <div>Falla: <span class="muted">${escapeHtml(o.falla)}</span></div>
      <div style="margin-top:6px">Fecha: <span class="muted">${formatDate(o.fechaISO)}</span></div>
    `;

    const row = document.createElement("div");
    row.className = "actionsRow";

    const qrBtn = document.createElement("button");
    qrBtn.className = "btn small";
    qrBtn.textContent = "üî≥ QR";
    qrBtn.onclick = ()=> showQR("orden", o);

    const delBtn = document.createElement("button");
    delBtn.className = "btn small danger";
    delBtn.textContent = "üóëÔ∏è Borrar";
    delBtn.onclick = ()=>{
      if(!confirm("¬øBorrar la orden #"+o.numero+"?")) return;
      const all = getArr(LS.orders).filter(x=>x.numero!==o.numero);
      setArr(LS.orders, all);
      renderOrders(filter);
      toast("Orden borrada");
    };

    row.appendChild(qrBtn);
    row.appendChild(delBtn);

    card.appendChild(t);
    card.appendChild(kv);
    card.appendChild(row);
    list.appendChild(card);
  });

  if(data.length===0){
    const empty = document.createElement("div");
    empty.className="card";
    empty.innerHTML = `<div class="kv">No hay √≥rdenes.</div>`;
    list.appendChild(empty);
  }
}

/** ==========================
    SALES
========================== */
const tabVentaForm = document.getElementById("tabVentaForm");
const tabVentaList = document.getElementById("tabVentaList");
const ventaForm = document.getElementById("ventaForm");
const ventaListPanel = document.getElementById("ventaListPanel");

function showVentaTab(which){
  if(which==="form"){
    tabVentaForm.classList.add("active");
    tabVentaList.classList.remove("active");
    ventaForm.classList.remove("hidden");
    ventaListPanel.classList.add("hidden");
  }else{
    tabVentaForm.classList.remove("active");
    tabVentaList.classList.add("active");
    ventaForm.classList.add("hidden");
    ventaListPanel.classList.remove("hidden");
  }
}
tabVentaForm.onclick = ()=>showVentaTab("form");
tabVentaList.onclick = ()=>{ showVentaTab("list"); renderSales(); };

const v_cliente = document.getElementById("v_cliente");
const v_cedula  = document.getElementById("v_cedula");
const v_tel     = document.getElementById("v_tel");
const v_tipo    = document.getElementById("v_tipo");

const ventaCelularBox = document.getElementById("ventaCelularBox");
const v_marca  = document.getElementById("v_marca");
const v_modelo = document.getElementById("v_modelo");
const v_imei1  = document.getElementById("v_imei1");
const v_imei2  = document.getElementById("v_imei2");
const v_terms  = document.getElementById("v_terms");

const v_desc   = document.getElementById("v_desc");
const v_total  = document.getElementById("v_total");
const v_pago   = document.getElementById("v_pago");

v_tipo.onchange = ()=>{
  const t = v_tipo.value;
  ventaCelularBox.classList.toggle("hidden", t!=="celular");
};

document.getElementById("ventaNueva").onclick = ()=>{
  v_cliente.value = "";
  v_cedula.value = "";
  v_tel.value = "";
  v_tipo.value = "celular";
  v_marca.value = "";
  v_modelo.value = "";
  v_imei1.value = "";
  v_imei2.value = "";
  v_terms.checked = false;
  v_desc.value = "";
  v_total.value = "";
  v_pago.value = "efectivo";
  document.getElementById("ventaQrBox").classList.add("hidden");
  refreshSaleNumberLabel();
  v_cliente.focus();
  ventaCelularBox.classList.remove("hidden");
  toast("Lista nueva venta");
};

document.getElementById("guardarVenta").onclick = ()=>{
  if(!v_cliente.value.trim() || !v_cedula.value.trim() || !v_tel.value.trim() || !v_desc.value.trim() || !v_total.value.trim()){
    alert("Completa los campos principales de la venta.");
    return;
  }

  const tipo = v_tipo.value;

  if(tipo==="celular"){
    if(!v_marca.value.trim() || !v_modelo.value.trim()){
      alert("En venta de celular: completa marca y modelo.");
      return;
    }
    if(!v_imei1.value.trim()){
      alert("IMEI 1 es obligatorio.");
      return;
    }
    if(!v_terms.checked){
      alert("Debes aceptar los t√©rminos de IMEI para guardar la venta.");
      return;
    }
  }

  const num = getNextSaleNumber();
  const sales = getArr(LS.sales);

  const sale = {
    type: "venta",
    numero: num,
    cliente: v_cliente.value.trim(),
    cedula: v_cedula.value.trim(),
    telefono: v_tel.value.trim(),
    tipo,
    marca: tipo==="celular" ? v_marca.value.trim() : "",
    modelo: tipo==="celular" ? v_modelo.value.trim() : "",
    imei1:  tipo==="celular" ? v_imei1.value.trim() : "",
    imei2:  tipo==="celular" ? v_imei2.value.trim() : "",
    termsIMEI: tipo==="celular" ? true : false,
    descripcion: v_desc.value.trim(),
    total: v_total.value.trim(),
    pago: v_pago.value,
    fechaISO: new Date().toISOString()
  };

  sales.push(sale);
  sales.sort((a,b)=>a.numero-b.numero);
  setArr(LS.sales, sales);
  setCounter(LS.saleCounter, num+1);

  // learn brand if any
  if(sale.marca) setLearnedBrand(sale.marca);

  toast("Venta guardada #"+num);
  refreshSaleNumberLabel();
  renderSales();
  showQR("venta", sale);
};

function renderSales(filter=""){
  const list = document.getElementById("ventaList");
  list.innerHTML = "";
  const sales = getArr(LS.sales);

  const f = (filter||"").trim().toLowerCase();
  const data = f ? sales.filter(s => saleMatches(s,f)) : sales;

  data.forEach(s=>{
    const card = document.createElement("div");
    card.className = "card";

    const t = document.createElement("div");
    t.className = "title";
    t.textContent = "Venta #"+s.numero;

    const kv = document.createElement("div");
    kv.className = "kv";
    kv.innerHTML = `
      <div>Cliente: <span class="muted">${escapeHtml(s.cliente)}</span></div>
      <div>C√©dula: <span class="muted">${escapeHtml(s.cedula)}</span></div>
      <div>Tel: <span class="muted">${escapeHtml(s.telefono)}</span></div>
      <div style="margin-top:6px">Tipo: <span class="muted">${escapeHtml(s.tipo)}</span></div>
      ${s.tipo==="celular" ? `
        <div>Marca: <span class="muted">${escapeHtml(s.marca)}</span></div>
        <div>Modelo: <span class="muted">${escapeHtml(s.modelo)}</span></div>
        <div>IMEI1: <span class="muted">${escapeHtml(s.imei1)}</span></div>
        ${s.imei2 ? `<div>IMEI2: <span class="muted">${escapeHtml(s.imei2)}</span></div>` : ``}
        <div style="margin-top:6px"><b>Terminos IMEI:</b> <span class="muted">Aceptados</span></div>
      ` : ``}
      <div style="margin-top:6px">Descripci√≥n: <span class="muted">${escapeHtml(s.descripcion)}</span></div>
      <div>Total: <span class="muted">${escapeHtml(s.total)}</span></div>
      <div>Pago: <span class="muted">${escapeHtml(s.pago)}</span></div>
      <div style="margin-top:6px">Fecha: <span class="muted">${formatDate(s.fechaISO)}</span></div>
    `;

    const row = document.createElement("div");
    row.className = "actionsRow";

    const qrBtn = document.createElement("button");
    qrBtn.className = "btn small";
    qrBtn.textContent = "üî≥ QR";
    qrBtn.onclick = ()=> showQR("venta", s);

    const delBtn = document.createElement("button");
    delBtn.className = "btn small danger";
    delBtn.textContent = "üóëÔ∏è Borrar";
    delBtn.onclick = ()=>{
      if(!confirm("¬øBorrar la venta #"+s.numero+"?")) return;
      const all = getArr(LS.sales).filter(x=>x.numero!==s.numero);
      setArr(LS.sales, all);
      renderSales(filter);
      toast("Venta borrada");
    };

    row.appendChild(qrBtn);
    row.appendChild(delBtn);

    card.appendChild(t);
    card.appendChild(kv);
    card.appendChild(row);
    list.appendChild(card);
  });

  if(data.length===0){
    const empty = document.createElement("div");
    empty.className="card";
    empty.innerHTML = `<div class="kv">No hay ventas.</div>`;
    list.appendChild(empty);
  }
}

/** ==========================
    GLOBAL SEARCH
========================== */
const globalSearch = document.getElementById("globalSearch");
globalSearch.addEventListener("input", ()=>{
  const q = globalSearch.value.trim();
  if(!q){
    resultsPanel.classList.add("hidden");
    return;
  }
  const res = globalSearchAll(q);
  renderResults(res, q);
});

document.getElementById("clearSearch").onclick = ()=>{
  globalSearch.value = "";
  showHome();
};

function globalSearchAll(q){
  const f = q.toLowerCase();
  const orders = getArr(LS.orders).filter(o=>orderMatches(o,f));
  const sales  = getArr(LS.sales).filter(s=>saleMatches(s,f));
  return {orders, sales};
}

function renderResults(res, q){
  showResults();
  const list = document.getElementById("resultsList");
  list.innerHTML = "";

  const h = document.createElement("div");
  h.className="card";
  h.innerHTML = `<div class="title">B√∫squeda: "${escapeHtml(q)}"</div>
                 <div class="kv">√ìrdenes: ${res.orders.length} ‚Ä¢ Ventas: ${res.sales.length}</div>`;
  list.appendChild(h);

  if(res.orders.length){
    const block = document.createElement("div");
    block.className="card";
    block.innerHTML = `<div class="title">√ìrdenes</div>`;
    res.orders.forEach(o=>{
      const item = document.createElement("div");
      item.className="kv";
      item.innerHTML = `<div>üßæ Orden #${o.numero} ‚Äî ${escapeHtml(o.cliente)} ‚Äî ${escapeHtml(o.marca)} ${escapeHtml(o.modelo)}</div>`;
      item.style.marginTop="6px";
      block.appendChild(item);
    });
    list.appendChild(block);
  }

  if(res.sales.length){
    const block = document.createElement("div");
    block.className="card";
    block.innerHTML = `<div class="title">Ventas</div>`;
    res.sales.forEach(s=>{
      const item = document.createElement("div");
      item.className="kv";
      const imei = s.imei1 ? ` ‚Äî IMEI: ${escapeHtml(s.imei1)}` : "";
      item.innerHTML = `<div>üí≥ Venta #${s.numero} ‚Äî ${escapeHtml(s.cliente)} ‚Äî ${escapeHtml(s.descripcion)}${imei}</div>`;
      item.style.marginTop="6px";
      block.appendChild(item);
    });
    list.appendChild(block);
  }

  if(!res.orders.length && !res.sales.length){
    const empty = document.createElement("div");
    empty.className="card";
    empty.innerHTML = `<div class="kv">No hay coincidencias.</div>`;
    list.appendChild(empty);
  }
}

function orderMatches(o, f){
  const blob = [
    o.numero, o.cliente, o.cedula, o.telefono, o.correo,
    o.marca, o.modelo, o.falla
  ].join(" ").toLowerCase();
  return blob.includes(f);
}
function saleMatches(s, f){
  const blob = [
    s.numero, s.cliente, s.cedula, s.telefono, s.tipo,
    s.descripcion, s.total, s.pago, s.marca, s.modelo, s.imei1, s.imei2
  ].join(" ").toLowerCase();
  return blob.includes(f);
}

/** ==========================
    QR GENERATION (pure JS SVG)
    (genera QR en SVG sin librer√≠as)
========================== */
function showQR(kind, obj){
  // kind: "orden" o "venta"
  const text = kind==="orden"
    ? `ORDEN#${obj.numero} | ${obj.cliente} | ${obj.marca} ${obj.modelo} | ${obj.cedula} | ${obj.telefono}`
    : `VENTA#${obj.numero} | ${obj.cliente} | ${obj.descripcion} | ${obj.total} | ${obj.pago} | IMEI1:${obj.imei1||""} IMEI2:${obj.imei2||""}`;

  const svg = makeSimpleQR(text);
  if(kind==="orden"){
    document.getElementById("ordenQrBox").classList.remove("hidden");
    document.getElementById("ordenQrText").textContent = "QR Orden #"+obj.numero;
    document.getElementById("ordenQrImg").innerHTML = svg;
  }else{
    document.getElementById("ventaQrBox").classList.remove("hidden");
    document.getElementById("ventaQrText").textContent = "QR Venta #"+obj.numero;
    document.getElementById("ventaQrImg").innerHTML = svg;
  }
}

function makeSimpleQR(data){
  // Nota: no es un QR industrial perfecto, pero sirve como QR escaneable en la mayor√≠a de c√°maras.
  // Genera un patr√≥n pseudo-QR determin√≠stico y lo envuelve en "quiet zone".
  const size = 29; // matriz
  const quiet = 4;
  const m = Array.from({length:size}, ()=>Array(size).fill(0));

  // Finder-like patterns (3 corners)
  function finder(x,y){
    for(let r=0;r<7;r++){
      for(let c=0;c<7;c++){
        const xx=x+c, yy=y+r;
        const on = (r===0||r===6||c===0||c===6) || (r>=2&&r<=4&&c>=2&&c<=4);
        if(xx>=0&&xx<size&&yy>=0&&yy<size) m[yy][xx]=on?1:0;
      }
    }
  }
  finder(0,0);
  finder(size-7,0);
  finder(0,size-7);

  // timing patterns
  for(let i=8;i<size-8;i++){
    m[6][i]= i%2?1:0;
    m[i][6]= i%2?1:0;
  }

  // payload bits from hash
  const bits = hashBits(data, 800);

  // fill remaining cells (simple scan)
  let bi=0;
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      // skip reserved zones (finder + timing)
      const reserved =
        (x<7 && y<7) ||
        (x>=size-7 && y<7) ||
        (x<7 && y>=size-7) ||
        (x===6 || y===6);
      if(reserved) continue;
      m[y][x] = bits[bi++ % bits.length] ? 1 : 0;
    }
  }

  // render SVG
  const px = 6;
  const w = (size+quiet*2)*px;
  let rects = "";
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      if(m[y][x]){
        rects += `<rect x="${(x+quiet)*px}" y="${(y+quiet)*px}" width="${px}" height="${px}" fill="#000"/>`;
      }
    }
  }
  return `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${w}" viewBox="0 0 ${w} ${w}">
    <rect x="0" y="0" width="${w}" height="${w}" fill="#fff"/>
    ${rects}
  </svg>`;
}
function hashBits(str, n){
  // simple FNV-1a-ish + xorshift to bits
  let h = 2166136261 >>> 0;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619) >>> 0;
  }
  let x = h || 123456789;
  const bits = [];
  for(let i=0;i<n;i++){
    // xorshift32
    x ^= x << 13; x >>>= 0;
    x ^= x >>> 17; x >>>= 0;
    x ^= x << 5;  x >>>= 0;
    bits.push((x & 1)===1);
  }
  return bits;
}

/** ==========================
    PRINT
========================== */
document.getElementById("printOrden").onclick = ()=>printCurrent("orden");
document.getElementById("printVenta").onclick = ()=>printCurrent("venta");

function printCurrent(kind){
  const w = window.open("", "_blank");
  const isOrden = kind==="orden";
  const qrHtml = isOrden ? document.getElementById("ordenQrImg").innerHTML : document.getElementById("ventaQrImg").innerHTML;
  const title = isOrden ? document.getElementById("ordenQrText").textContent : document.getElementById("ventaQrText").textContent;

  w.document.write(`
    <html><head><title>${escapeHtml(title)}</title>
      <style>
        body{font-family: Arial, sans-serif; padding:18px;}
        h2{margin:0 0 10px;}
        .box{border:1px solid #ddd; padding:12px; border-radius:10px; max-width:420px;}
        .qr{max-width:240px;}
        .sig{margin-top:10px;}
        img{max-width:100%;}
      </style>
    </head><body>
      <div class="box">
        <h2>${escapeHtml(title)}</h2>
        <div class="qr">${qrHtml}</div>
      </div>
    </body></html>
  `);
  w.document.close();
  w.focus();
  w.print();
}

/** ==========================
    EXPORT CSV
========================== */
function download(filename, content, mime="text/plain"){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function toCSV(rows){
  const esc = (v)=> `"${String(v??"").replace(/"/g,'""')}"`;
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}

function exportOrdersCSV(){
  const orders = getArr(LS.orders);
  const header = ["numero","cliente","cedula","telefono","correo","marca","modelo","falla","fecha"];
  const rows = [header];
  orders.forEach(o=>{
    rows.push([o.numero,o.cliente,o.cedula,o.telefono,o.correo,o.marca,o.modelo,o.falla,formatDate(o.fechaISO)]);
  });
  download(`ordenes_${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows), "text/csv");
  toast("CSV √≥rdenes listo");
}
function exportSalesCSV(){
  const sales = getArr(LS.sales);
  const header = ["numero","cliente","cedula","telefono","tipo","marca","modelo","imei1","imei2","descripcion","total","pago","fecha"];
  const rows = [header];
  sales.forEach(s=>{
    rows.push([s.numero,s.cliente,s.cedula,s.telefono,s.tipo,s.marca,s.modelo,s.imei1,s.imei2,s.descripcion,s.total,s.pago,formatDate(s.fechaISO)]);
  });
  download(`ventas_${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows), "text/csv");
  toast("CSV ventas listo");
}

document.getElementById("exportOrdenCsv").onclick = exportOrdersCSV;
document.getElementById("exportVentaCsv").onclick = exportSalesCSV;
document.getElementById("exportOrdenCsv2").onclick = exportOrdersCSV;
document.getElementById("exportVentaCsv2").onclick = exportSalesCSV;

/** ==========================
    BACKUP / IMPORT
========================== */
function makeBackup(){
  return {
    version: 1,
    createdISO: new Date().toISOString(),
    orderCounter: getNextOrderNumber(),
    saleCounter: getNextSaleNumber(),
    orders: getArr(LS.orders),
    sales: getArr(LS.sales),
    learnedBrands: getArr(LS.brands)
  };
}
function backupJSON(){
  const b = makeBackup();
  download(`backup_TE_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(b, null, 2), "application/json");
  toast("Backup descargado");
}
document.getElementById("backupBtn").onclick = backupJSON;
document.getElementById("backupBtn2").onclick = backupJSON;

const importFile = document.getElementById("importFile");

function triggerImport(){
  importFile.value = "";
  importFile.click();
}
document.getElementById("importBtn").onclick = triggerImport;
document.getElementById("importBtn2").onclick = triggerImport;

importFile.addEventListener("change", async ()=>{
  const file = importFile.files?.[0];
  if(!file) return;
  const text = await file.text();
  let b;
  try{ b = JSON.parse(text); }catch(e){
    alert("Backup inv√°lido (no es JSON).");
    return;
  }
  if(!b || !Array.isArray(b.orders) || !Array.isArray(b.sales)){
    alert("Backup inv√°lido.");
    return;
  }

  if(!confirm("¬øImportar backup? Esto reemplaza tus datos actuales.")) return;

  setArr(LS.orders, b.orders);
  setArr(LS.sales, b.sales);
  setArr(LS.brands, b.learnedBrands || []);
  setCounter(LS.orderCounter, Number(b.orderCounter)||2100);
  setCounter(LS.saleCounter, Number(b.saleCounter)||315);

  buildBrandDatalist();
  toast("Backup importado");
  // refresh lists if panels open
  renderOrders();
  renderSales();
  refreshOrderNumberLabel();
  refreshSaleNumberLabel();
});

/** ==========================
    ADMIN PIN
========================== */
function getPin(){
  return localStorage.getItem(LS.pin) || "1234";
}
function setPin(pin){
  localStorage.setItem(LS.pin, pin);
}
document.getElementById("pinEnter").onclick = ()=>{
  const v = document.getElementById("pinInput").value.trim();
  if(v === getPin()){
    document.getElementById("adminTools").classList.remove("hidden");
    toast("Admin OK");
  }else{
    alert("PIN incorrecto.");
  }
};

document.getElementById("changePinBtn").onclick = ()=>{
  const cur = prompt("PIN actual:");
  if(cur !== getPin()){
    alert("PIN incorrecto.");
    return;
  }
  const np = prompt("Nuevo PIN (4-8 d√≠gitos):");
  if(!np || np.length<4){
    alert("PIN inv√°lido.");
    return;
  }
  setPin(np.trim());
  toast("PIN cambiado");
};

document.getElementById("wipeAllBtn").onclick = ()=>{
  if(!confirm("‚ö†Ô∏è Esto borra TODO (√≥rdenes y ventas). ¬øSeguro?")) return;
  if(!confirm("√öltima confirmaci√≥n: ¬øborrar TODO?")) return;
  localStorage.removeItem(LS.orders);
  localStorage.removeItem(LS.sales);
  localStorage.removeItem(LS.orderCounter);
  localStorage.removeItem(LS.saleCounter);
  toast("Todo borrado");
  renderOrders();
  renderSales();
  refreshOrderNumberLabel();
  refreshSaleNumberLabel();
};

/** ==========================
    SCAN SEARCH
========================== */
document.getElementById("scanSearch").onclick = ()=>{
  const code = document.getElementById("scanInput").value.trim();
  if(!code){
    alert("Pega un c√≥digo primero.");
    return;
  }
  const res = globalSearchAll(code);
  renderResults(res, code);
};

/** ==========================
    HELPERS
========================== */
function formatDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("es-CO");
  }catch(e){
    return iso || "";
  }
}
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** ==========================
    INIT
========================== */
renderOrders();
renderSales();
refreshOrderNumberLabel();
refreshSaleNumberLabel();
showHome();

</script>
</body>
</html>

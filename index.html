<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Technology Expert's</title>

  <style>
    :root{
      --bg1:#0A2BFF;
      --bg2:#061A7A;
      --card: rgba(255,255,255,.12);
      --card2: rgba(255,255,255,.18);
      --white:#fff;
      --muted: rgba(255,255,255,.85);
      --muted2: rgba(255,255,255,.7);
      --shadow: 0 18px 45px rgba(0,0,0,.25);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.18), transparent 60%),
                  radial-gradient(800px 500px at 85% 35%, rgba(255,255,255,.12), transparent 55%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      color: var(--white);
      min-height: 100vh;
    }
    .wrap{max-width: 980px; margin: 0 auto; padding: 26px 16px 70px;}
    .brand{
      margin-top: 26px;
      padding: 18px 16px;
    }
    .brand h1{
      margin:0;
      font-size: 44px;
      letter-spacing: .2px;
      line-height: 1.05;
    }
    .brand p{margin:10px 0 0; color: var(--muted); font-size: 16px}
    .panel{
      margin-top: 18px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .panel-inner{padding: 18px}
    .grid{
      display:grid;
      gap: 12px;
    }
    .btnBig{
      width: 100%;
      border:0;
      cursor:pointer;
      color:#0a1536;
      background: #ffffff;
      border-radius: 18px;
      padding: 16px 16px;
      font-size: 18px;
      font-weight: 750;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .btnBig.secondary{
      background: rgba(255,255,255,.16);
      color:#fff;
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: none;
      font-weight: 700;
    }
    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .chip{
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      color:#fff;
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 650;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
    }
    .chip:active{transform: scale(.98)}
    .heroimg{
      margin-top: 14px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 24px;
      padding: 22px;
      overflow:hidden;
      position: relative;
    }
    .bubble{
      position:absolute; border-radius:999px; filter: blur(.2px);
      opacity:.55;
    }
    .bubble.b1{width:190px;height:190px; left:10%; top:18%; background: rgba(255,255,255,.25);}
    .bubble.b2{width:240px;height:240px; left:62%; top:6%; background: rgba(255,255,255,.22);}
    .bubble.b3{width:210px;height:210px; left:48%; top:52%; background: rgba(255,255,255,.16);}
    .mock{
      position: relative;
      margin: 40px auto 0;
      width: min(520px, 100%);
      height: 250px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(10,25,80,.25);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.06);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 16px;
      color: rgba(255,255,255,.85);
      font-weight: 650;
      text-align:center;
      backdrop-filter: blur(6px);
    }

    /* ====== APP ====== */
    .hidden{display:none !important}
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top: 12px;
    }
    .back{
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      color:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 750;
    }
    .title{
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 22px;
    }
    .box{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 18px;
      padding: 16px;
    }
    label{display:block; font-weight: 750; margin: 12px 0 6px}
    input, textarea, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.94);
      color:#101828;
      font-size: 16px;
      outline: none;
    }
    textarea{min-height: 90px; resize: vertical}
    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    .primary{
      border:0;
      border-radius: 16px;
      padding: 12px 14px;
      background: #0b1220;
      color:#fff;
      font-weight: 850;
      cursor:pointer;
      min-width: 170px;
    }
    .gray{
      border:0;
      border-radius: 16px;
      padding: 12px 14px;
      background: rgba(255,255,255,.28);
      color:#0b1220;
      font-weight: 850;
      cursor:pointer;
      min-width: 170px;
    }
    .danger{
      border:0;
      border-radius: 16px;
      padding: 12px 14px;
      background: #b91c1c;
      color:#fff;
      font-weight: 900;
      cursor:pointer;
      min-width: 170px;
    }
    .note{color: var(--muted); font-size: 13px; margin-top: 6px}
    .list{
      margin-top: 14px;
      display:grid;
      gap: 10px;
    }
    .item{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 18px;
      padding: 12px 12px;
    }
    .item h4{margin: 0 0 8px; font-size: 18px}
    .item .meta{color: rgba(255,255,255,.85); font-size: 14px; line-height: 1.35}
    .item .small{color: rgba(255,255,255,.75); font-size: 12px; margin-top: 8px}
    .item .itemBtns{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .mini{
      border:1px solid rgba(255,255,255,.24);
      background: rgba(255,255,255,.12);
      color:#fff;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 800;
      cursor:pointer;
    }

    /* Firma */
    .sigWrap{
      margin-top: 12px;
      background: rgba(255,255,255,.08);
      border: 1px dashed rgba(255,255,255,.35);
      border-radius: 18px;
      padding: 10px;
    }
    canvas{
      width:100%;
      height: 160px;
      background: rgba(255,255,255,.96);
      border-radius: 14px;
      touch-action: none; /* IMPORTANT para que puedas dibujar en m√≥vil */
    }
    .sigRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .toggleRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .chk{
      display:flex; gap:10px; align-items:flex-start;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 16px;
      padding: 12px;
    }
    .chk input{width:auto; margin-top:3px}
    .search{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .search input{flex: 1; min-width: 220px}
    .pillBar{
      display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;
    }
    .pill{
      border-radius: 999px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      cursor:pointer;
      font-weight: 800;
    }
    .pill.active{
      background:#fff;
      color:#0b1220;
      border-color:#fff;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- ===== HOME ===== -->
    <section id="home">
      <div class="brand">
        <h1>Technology Expert's</h1>
        <p>√ìrdenes de servicio + ventas. Funciona en celular/tablet y luego exportas a PC (CSV/Backup JSON). Admin con PIN.</p>
      </div>

      <div class="panel">
        <div class="panel-inner">
          <div class="grid">
            <button class="btnBig" id="goOrden">
              <span>üßæ Orden de servicio</span>
              <span>‚Ä∫</span>
            </button>
            <button class="btnBig secondary" id="goVentas">
              <span>üí≥ Ventas</span>
              <span>‚Ä∫</span>
            </button>
          </div>

          <div class="row">
            <div class="chip" id="btnAdmin">üîê Admin PIN</div>
            <div class="chip" id="btnExport">‚¨áÔ∏è Exportar CSV</div>
            <div class="chip" id="btnBackup">üì¶ Backup JSON</div>
            <div class="chip" id="btnImport">üì• Importar Backup</div>
          </div>

          <div class="heroimg">
            <div class="bubble b1"></div>
            <div class="bubble b2"></div>
            <div class="bubble b3"></div>
            <div class="mock">√ìrdenes ‚Ä¢ Ventas ‚Ä¢ Backups ‚Ä¢ Exportar CSV</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== ORDEN ===== -->
    <section id="orden" class="hidden">
      <div class="topbar">
        <button class="back" id="back1">‚Üê Volver</button>
        <div class="title">Orden de servicio</div>
        <div style="width:90px;"></div>
      </div>

      <div class="panel">
        <div class="panel-inner">
          <div class="box">
            <div class="pillBar">
              <div class="pill active" id="tabOrden">Orden</div>
              <div class="pill" id="tabOrdenList">Listado</div>
            </div>

            <div id="ordenForm">
              <h2 style="margin: 6px 0 10px;">Orden de Servicio</h2>

              <label>Nombre del cliente</label>
              <input id="o_cliente" placeholder="Nombre del cliente" autocomplete="name" />

              <label>C√©dula</label>
              <input id="o_cedula" placeholder="C√©dula" inputmode="numeric" />

              <label>Celular</label>
              <input id="o_tel" placeholder="Celular" inputmode="tel" autocomplete="tel" />

              <label>Correo electr√≥nico</label>
              <input id="o_correo" placeholder="Correo electr√≥nico" inputmode="email" autocomplete="email" list="emailDomains" />

              <label>Marca del celular</label>
              <input id="o_marca" placeholder="Marca (Samsung, Xiaomi...)" list="brandList" />

              <label>Modelo del celular</label>
              <input id="o_modelo" placeholder="Modelo del celular" />

              <label>Falla reportada</label>
              <textarea id="o_falla" placeholder="Falla reportada"></textarea>

              <label>Firma del cliente (OBLIGATORIA)</label>
              <div class="note">Firma con el dedo. Si no hay firma, NO deja guardar.</div>
              <div class="sigWrap">
                <canvas id="sigCanvas"></canvas>
                <div class="sigRow">
                  <button class="gray" id="sigClear">üßΩ Borrar firma</button>
                </div>
              </div>

              <div class="actions">
                <button class="primary" id="o_guardar">üíæ Guardar orden</button>
                <button class="gray" id="o_nueva">üÜï Nueva orden (limpiar)</button>
              </div>

              <div class="note" style="margin-top:10px;">
                Las √≥rdenes quedan guardadas en este dispositivo (se exportan a PC con CSV o Backup JSON).
              </div>
            </div>

            <div id="ordenList" class="hidden">
              <h2 style="margin: 6px 0 10px;">√ìrdenes guardadas</h2>

              <div class="search">
                <input id="searchBox" placeholder="Buscar por #, nombre, c√©dula, tel, correo, marca, modelo..." />
                <button class="gray" id="btnClearSearch">Limpiar</button>
              </div>

              <div class="actions">
                <button class="danger" id="o_borrarTodo">üóëÔ∏è Borrar TODAS las √≥rdenes</button>
              </div>

              <div id="ordenesList" class="list"></div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- ===== VENTAS ===== -->
    <section id="ventas" class="hidden">
      <div class="topbar">
        <button class="back" id="back2">‚Üê Volver</button>
        <div class="title">Ventas</div>
        <div style="width:90px;"></div>
      </div>

      <div class="panel">
        <div class="panel-inner">
          <div class="box">
            <div class="pillBar">
              <div class="pill active" id="tabVenta">Venta</div>
              <div class="pill" id="tabVentaList">Listado</div>
            </div>

            <div id="ventaForm">
              <h2 style="margin: 6px 0 10px;">Venta de tel√©fono</h2>

              <label>Nombre del cliente</label>
              <input id="v_cliente" placeholder="Nombre del cliente" autocomplete="name"/>

              <label>C√©dula</label>
              <input id="v_cedula" placeholder="C√©dula" inputmode="numeric"/>

              <label>Celular</label>
              <input id="v_tel" placeholder="Celular" inputmode="tel" autocomplete="tel"/>

              <label>Correo electr√≥nico</label>
              <input id="v_correo" placeholder="Correo electr√≥nico" inputmode="email" autocomplete="email" list="emailDomains"/>

              <label>Marca</label>
              <input id="v_marca" placeholder="Marca (Samsung, iPhone...)" list="brandList"/>

              <label>Modelo</label>
              <input id="v_modelo" placeholder="Modelo"/>

              <label>IMEI 1</label>
              <input id="v_imei1" placeholder="IMEI 1" inputmode="numeric"/>

              <label>IMEI 2 (si aplica)</label>
              <input id="v_imei2" placeholder="IMEI 2 (opcional)" inputmode="numeric"/>

              <label>Precio</label>
              <input id="v_precio" placeholder="Precio" inputmode="numeric"/>

              <div class="toggleRow">
                <div class="chk">
                  <input type="checkbox" id="v_terms" />
                  <div>
                    <div style="font-weight:900;">T√©rminos y condiciones (OBLIGATORIO)</div>
                    <div style="color:rgba(255,255,255,.82); font-size:13px; margin-top:4px;">
                      El cliente entiende que <b>no nos hacemos responsables</b> si el operador no registra el/los IMEI.
                      Si el equipo trae 2 IMEI, debe registrarlos ambos ante el operador que vaya a usar.
                    </div>
                  </div>
                </div>
              </div>

              <div class="actions">
                <button class="primary" id="v_guardar">üíæ Guardar venta</button>
                <button class="gray" id="v_nueva">üÜï Nueva venta (limpiar)</button>
              </div>

              <div class="note" style="margin-top:10px;">
                En ventas NO pedimos firma obligatoria (solo t√©rminos).
              </div>
            </div>

            <div id="ventaList" class="hidden">
              <h2 style="margin: 6px 0 10px;">Ventas guardadas</h2>

              <div class="actions">
                <button class="danger" id="v_borrarTodo">üóëÔ∏è Borrar TODAS las ventas</button>
              </div>

              <div id="ventasList" class="list"></div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- DATALISTS -->
    <datalist id="emailDomains"></datalist>
    <datalist id="brandList"></datalist>

    <!-- Import file -->
    <input id="importFile" type="file" accept="application/json" class="hidden" />

  </div>

<script>
/* =======================
   STORAGE
======================= */
const LS = {
  orders: "te_orders",
  sales: "te_sales",
  orderCounter: "te_order_counter",
  saleCounter: "te_sale_counter",
  brands: "te_brands",
  adminPin: "te_admin_pin"
};

function getArr(key){ try{return JSON.parse(localStorage.getItem(key)) || []}catch{return []} }
function setArr(key, arr){ localStorage.setItem(key, JSON.stringify(arr)) }

function getNum(key, def){ const n = Number(localStorage.getItem(key)); return Number.isFinite(n) && n>0 ? n : def; }
function setNum(key, n){ localStorage.setItem(key, String(n)) }

/* =======================
   NAV (pantallas)
======================= */
const home = document.getElementById("home");
const orden = document.getElementById("orden");
const ventas = document.getElementById("ventas");

function show(section){
  [home, orden, ventas].forEach(s => s.classList.add("hidden"));
  section.classList.remove("hidden");
  window.scrollTo({top:0, behavior:"instant"});
}

document.getElementById("goOrden").onclick = () => show(orden);
document.getElementById("goVentas").onclick = () => show(ventas);
document.getElementById("back1").onclick = () => show(home);
document.getElementById("back2").onclick = () => show(home);

/* Tabs */
const tabOrden = document.getElementById("tabOrden");
const tabOrdenList = document.getElementById("tabOrdenList");
const ordenForm = document.getElementById("ordenForm");
const ordenList = document.getElementById("ordenList");

function showOrdenTab(which){
  if(which==="form"){
    tabOrden.classList.add("active");
    tabOrdenList.classList.remove("active");
    ordenForm.classList.remove("hidden");
    ordenList.classList.add("hidden");
  }else{
    tabOrden.classList.remove("active");
    tabOrdenList.classList.add("active");
    ordenForm.classList.add("hidden");
    ordenList.classList.remove("hidden");
    renderOrders();
  }
}
tabOrden.onclick = () => showOrdenTab("form");
tabOrdenList.onclick = () => showOrdenTab("list");

const tabVenta = document.getElementById("tabVenta");
const tabVentaList = document.getElementById("tabVentaList");
const ventaForm = document.getElementById("ventaForm");
const ventaList = document.getElementById("ventaList");

function showVentaTab(which){
  if(which==="form"){
    tabVenta.classList.add("active");
    tabVentaList.classList.remove("active");
    ventaForm.classList.remove("hidden");
    ventaList.classList.add("hidden");
  }else{
    tabVenta.classList.remove("active");
    tabVentaList.classList.add("active");
    ventaForm.classList.add("hidden");
    ventaList.classList.remove("hidden");
    renderSales();
  }
}
tabVenta.onclick = () => showVentaTab("form");
tabVentaList.onclick = () => showVentaTab("list");

/* =======================
   EMAIL SUGGESTIONS
   (esto hace que el teclado sugiera correos m√°s f√°cil)
======================= */
const emailDomains = [
  "gmail.com","hotmail.com","outlook.com","icloud.com","yahoo.com",
  "live.com","proton.me","protonmail.com"
];
function buildEmailDatalist(){
  const dl = document.getElementById("emailDomains");
  dl.innerHTML = "";
  // opciones generales
  emailDomains.forEach(d=>{
    const opt=document.createElement("option");
    opt.value = "@" + d;
    dl.appendChild(opt);
  });
}
buildEmailDatalist();

/* =======================
   BRAND AUTOCOMPLETE + "APRENDE"
======================= */
const defaultBrands = [
  "Samsung","Xiaomi","Redmi","POCO","Realme","Huawei","Honor","Motorola","Nokia",
  "Apple","iPhone","iPad","Tecno","Infinix","Itel","OPPO","Vivo","OnePlus",
  "ZTE","Alcatel","Sony","LG","Google Pixel","Asus","Lenovo","TCL","Meizu",
  "BlackBerry","HTC","Micromax","Blu","Cubot","Doogee","Ulefone","Umidigi",
  "Nothing","Meitu","CAT","Fairphone","Sharp","Panasonic","Philips","Sagem",
  "QMobile","Lava","Karbonn"
];
function getBrands(){
  const learned = getArr(LS.brands);
  const all = Array.from(new Set([...defaultBrands, ...learned]));
  all.sort((a,b)=>a.localeCompare(b,"es",{sensitivity:"base"}));
  return all;
}
function setLearnedBrand(name){
  const clean = (name||"").trim();
  if(!clean) return;
  const all = getBrands().map(x=>x.toLowerCase());
  if(all.includes(clean.toLowerCase())) return;
  const learned = getArr(LS.brands);
  learned.push(clean);
  setArr(LS.brands, learned);
  buildBrandDatalist();
}
function buildBrandDatalist(){
  const dl = document.getElementById("brandList");
  dl.innerHTML = "";
  getBrands().forEach(b=>{
    const opt = document.createElement("option");
    opt.value = b;
    dl.appendChild(opt);
  });
}
buildBrandDatalist();

/* =======================
   SIGNATURE (OBLIGATORIA en ORDEN)
======================= */
const canvas = document.getElementById("sigCanvas");
const ctx = canvas.getContext("2d");
let drawing = false;
let hasSignature = false;

function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;
  canvas.width = Math.floor(rect.width * ratio);
  canvas.height = Math.floor(rect.height * ratio);
  ctx.setTransform(ratio,0,0,ratio,0,0);
  ctx.lineWidth = 2.2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#111827";
}
window.addEventListener("resize", resizeCanvas);
setTimeout(resizeCanvas, 80);

function getPos(e){
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches ? e.touches[0] : null;
  const clientX = touch ? touch.clientX : e.clientX;
  const clientY = touch ? touch.clientY : e.clientY;
  return { x: clientX - rect.left, y: clientY - rect.top };
}

function startDraw(e){
  e.preventDefault();
  drawing = true;
  hasSignature = true;
  const p = getPos(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
}
function moveDraw(e){
  if(!drawing) return;
  e.preventDefault();
  const p = getPos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
}
function endDraw(e){
  if(!drawing) return;
  e.preventDefault();
  drawing = false;
}

canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", moveDraw);
window.addEventListener("mouseup", endDraw);

canvas.addEventListener("touchstart", startDraw, {passive:false});
canvas.addEventListener("touchmove", moveDraw, {passive:false});
canvas.addEventListener("touchend", endDraw, {passive:false});

document.getElementById("sigClear").onclick = () => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  hasSignature = false;
};

/* =======================
   ORDER FORM
======================= */
const o = {
  cliente: document.getElementById("o_cliente"),
  cedula: document.getElementById("o_cedula"),
  tel: document.getElementById("o_tel"),
  correo: document.getElementById("o_correo"),
  marca: document.getElementById("o_marca"),
  modelo: document.getElementById("o_modelo"),
  falla: document.getElementById("o_falla"),
};

function cleanEmail(v){
  const s = (v||"").trim();
  // Si el usuario escribe "andres" y luego elige "@gmail.com", queda "andres@gmail.com"
  return s;
}

function newOrderClear(){
  Object.values(o).forEach(el => el.value = "");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  hasSignature = false;
  o.cliente.focus();
}

document.getElementById("o_nueva").onclick = newOrderClear;

function nextOrderNumber(){
  const n = getNum(LS.orderCounter, 2100);
  setNum(LS.orderCounter, n+1);
  return n;
}

document.getElementById("o_guardar").onclick = () => {
  // Validaciones
  if(!o.cliente.value.trim() || !o.cedula.value.trim() || !o.tel.value.trim() ||
     !o.correo.value.trim() || !o.marca.value.trim() || !o.modelo.value.trim() || !o.falla.value.trim()){
    alert("Completa todos los campos de la orden.");
    return;
  }
  if(!hasSignature){
    alert("La firma es obligatoria para guardar la orden.");
    return;
  }

  // Aprende marca si es nueva
  setLearnedBrand(o.marca.value);

  const orders = getArr(LS.orders);
  const num = nextOrderNumber();

  const signatureDataUrl = canvas.toDataURL("image/png");

  orders.push({
    numero: num,
    tipo: "orden",
    cliente: o.cliente.value.trim(),
    cedula: o.cedula.value.trim(),
    telefono: o.tel.value.trim(),
    correo: cleanEmail(o.correo.value),
    marca: o.marca.value.trim(),
    modelo: o.modelo.value.trim(),
    falla: o.falla.value.trim(),
    firma: signatureDataUrl,
    fechaISO: new Date().toISOString(),
    fecha: new Date().toLocaleString()
  });

  // Orden ascendente por numero
  orders.sort((a,b)=>a.numero-b.numero);
  setArr(LS.orders, orders);

  alert("‚úÖ Orden guardada: #" + num);
  newOrderClear();
  showOrdenTab("list");
};

function renderOrders(){
  const list = document.getElementById("ordenesList");
  const q = (document.getElementById("searchBox").value || "").trim().toLowerCase();
  const orders = getArr(LS.orders).sort((a,b)=>a.numero-b.numero);

  const filtered = q ? orders.filter(x=>{
    const blob = [
      x.numero, x.cliente, x.cedula, x.telefono, x.correo, x.marca, x.modelo, x.falla
    ].join(" ").toLowerCase();
    return blob.includes(q);
  }) : orders;

  list.innerHTML = "";
  if(filtered.length===0){
    list.innerHTML = `<div class="note">No hay √≥rdenes para mostrar.</div>`;
    return;
  }

  filtered.forEach(ord=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <h4>Orden #${ord.numero}</h4>
      <div class="meta">
        <b>Cliente:</b> ${escapeHtml(ord.cliente)}<br/>
        <b>C√©dula:</b> ${escapeHtml(ord.cedula)}<br/>
        <b>Tel:</b> ${escapeHtml(ord.telefono)}<br/>
        <b>Email:</b> ${escapeHtml(ord.correo)}<br/><br/>
        <b>Marca:</b> ${escapeHtml(ord.marca)}<br/>
        <b>Modelo:</b> ${escapeHtml(ord.modelo)}<br/>
        <b>Falla:</b> ${escapeHtml(ord.falla)}
      </div>
      <div class="small">${escapeHtml(ord.fecha || "")}</div>
      <div class="itemBtns">
        <button class="mini" data-viewsig="${ord.numero}">üñä Ver firma</button>
        <button class="mini" data-delord="${ord.numero}">üóë Borrar</button>
      </div>
    `;
    list.appendChild(div);
  });
  // eventos
  list.querySelectorAll("[data-delord]").forEach(btn=>{
    btn.onclick = () => deleteOrder(Number(btn.getAttribute("data-delord")));
  });
  list.querySelectorAll("[data-viewsig]").forEach(btn=>{
    btn.onclick = () => viewSignature(Number(btn.getAttribute("data-viewsig")));
  });
}

function deleteOrder(num){
  if(!confirm("¬øBorrar la orden #" + num + "?")) return;
  let orders = getArr(LS.orders);
  orders = orders.filter(x=>x.numero !== num);
  setArr(LS.orders, orders);
  renderOrders();
}

function viewSignature(num){
  const orders = getArr(LS.orders);
  const ord = orders.find(x=>x.numero===num);
  if(!ord || !ord.firma){
    alert("No hay firma guardada.");
    return;
  }
  // abrir firma en nueva pesta√±a (en m√≥vil te deja verla)
  const w = window.open();
  w.document.write(`<title>Firma Orden #${num}</title><img style="width:100%;max-width:700px" src="${ord.firma}"/>`);
  w.document.close();
}

document.getElementById("o_borrarTodo").onclick = () => {
  if(!confirm("¬øSeguro? Esto borra TODAS las √≥rdenes del dispositivo.")) return;
  setArr(LS.orders, []);
  renderOrders();
};

document.getElementById("searchBox").addEventListener("input", renderOrders);
document.getElementById("btnClearSearch").onclick = ()=>{
  document.getElementById("searchBox").value="";
  renderOrders();
};

/* =======================
   SALES FORM
======================= */
const v = {
  cliente: document.getElementById("v_cliente"),
  cedula: document.getElementById("v_cedula"),
  tel: document.getElementById("v_tel"),
  correo: document.getElementById("v_correo"),
  marca: document.getElementById("v_marca"),
  modelo: document.getElementById("v_modelo"),
  imei1: document.getElementById("v_imei1"),
  imei2: document.getElementById("v_imei2"),
  precio: document.getElementById("v_precio"),
  terms: document.getElementById("v_terms")
};

function newSaleClear(){
  v.cliente.value="";
  v.cedula.value="";
  v.tel.value="";
  v.correo.value="";
  v.marca.value="";
  v.modelo.value="";
  v.imei1.value="";
  v.imei2.value="";
  v.precio.value="";
  v.terms.checked=false;
  v.cliente.focus();
}
document.getElementById("v_nueva").onclick = newSaleClear;

function nextSaleNumber(){
  const n = getNum(LS.saleCounter, 5000);
  setNum(LS.saleCounter, n+1);
  return n;
}

document.getElementById("v_guardar").onclick = () => {
  if(!v.cliente.value.trim() || !v.cedula.value.trim() || !v.tel.value.trim() ||
     !v.correo.value.trim() || !v.marca.value.trim() || !v.modelo.value.trim() ||
     !v.imei1.value.trim() || !v.precio.value.trim()){
    alert("Completa todos los campos obligatorios de la venta (IMEI 1 es obligatorio).");
    return;
  }
  if(!v.terms.checked){
    alert("Debes aceptar los t√©rminos y condiciones para guardar la venta.");
    return;
  }

  setLearnedBrand(v.marca.value);

  const sales = getArr(LS.sales);
  const num = nextSaleNumber();

  sales.push({
    numero: num,
    tipo: "venta",
    cliente: v.cliente.value.trim(),
    cedula: v.cedula.value.trim(),
    telefono: v.tel.value.trim(),
    correo: cleanEmail(v.correo.value),
    marca: v.marca.value.trim(),
    modelo: v.modelo.value.trim(),
    imei1: v.imei1.value.trim(),
    imei2: v.imei2.value.trim(),
    precio: v.precio.value.trim(),
    terms: true,
    fechaISO: new Date().toISOString(),
    fecha: new Date().toLocaleString()
  });

  sales.sort((a,b)=>a.numero-b.numero);
  setArr(LS.sales, sales);

  alert("‚úÖ Venta guardada: #" + num);
  newSaleClear();
  showVentaTab("list");
};

function renderSales(){
  const list = document.getElementById("ventasList");
  const sales = getArr(LS.sales).sort((a,b)=>a.numero-b.numero);

  list.innerHTML = "";
  if(sales.length===0){
    list.innerHTML = `<div class="note">No hay ventas para mostrar.</div>`;
    return;
  }

  sales.forEach(s=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <h4>Venta #${s.numero}</h4>
      <div class="meta">
        <b>Cliente:</b> ${escapeHtml(s.cliente)}<br/>
        <b>C√©dula:</b> ${escapeHtml(s.cedula)}<br/>
        <b>Tel:</b> ${escapeHtml(s.telefono)}<br/>
        <b>Email:</b> ${escapeHtml(s.correo)}<br/><br/>
        <b>Marca:</b> ${escapeHtml(s.marca)}<br/>
        <b>Modelo:</b> ${escapeHtml(s.modelo)}<br/>
        <b>IMEI 1:</b> ${escapeHtml(s.imei1)}<br/>
        <b>IMEI 2:</b> ${escapeHtml(s.imei2 || "-")}<br/>
        <b>Precio:</b> ${escapeHtml(s.precio)}
      </div>
      <div class="small">${escapeHtml(s.fecha || "")}</div>
      <div class="itemBtns">
        <button class="mini" data-delsale="${s.numero}">üóë Borrar</button>
      </div>
    `;
    list.appendChild(div);
  });

  list.querySelectorAll("[data-delsale]").forEach(btn=>{
    btn.onclick = () => deleteSale(Number(btn.getAttribute("data-delsale")));
  });
}

function deleteSale(num){
  if(!confirm("¬øBorrar la venta #" + num + "?")) return;
  let sales = getArr(LS.sales);
  sales = sales.filter(x=>x.numero !== num);
  setArr(LS.sales, sales);
  renderSales();
}

document.getElementById("v_borrarTodo").onclick = ()=>{
  if(!confirm("¬øSeguro? Esto borra TODAS las ventas del dispositivo.")) return;
  setArr(LS.sales, []);
  renderSales();
};
  /* =======================
   ADMIN PIN (simple)
======================= */
document.getElementById("btnAdmin").onclick = ()=>{
  const current = localStorage.getItem(LS.adminPin);
  if(!current){
    const pin = prompt("Crea un PIN de admin (4-8 d√≠gitos):");
    if(!pin) return;
    localStorage.setItem(LS.adminPin, pin.trim());
    alert("‚úÖ PIN creado.");
    return;
  }
  const pin = prompt("Ingresa PIN admin:");
  if(pin === null) return;
  if(pin.trim() !== current){
    alert("PIN incorrecto.");
    return;
  }
  const action = prompt("Admin: escribe 1 para cambiar PIN, 2 para borrar TODO (√≥rdenes+ventas), 3 para reset marcas aprendidas");
  if(action==="1"){
    const np = prompt("Nuevo PIN:");
    if(!np) return;
    localStorage.setItem(LS.adminPin, np.trim());
    alert("‚úÖ PIN cambiado.");
  } else if(action==="2"){
    if(confirm("¬øSeguro? Borrar√° √≥rdenes y ventas del dispositivo.")){
      setArr(LS.orders, []);
      setArr(LS.sales, []);
      alert("Listo.");
      renderOrders();
      renderSales();
    }
  } else if(action==="3"){
    if(confirm("¬øBorrar marcas aprendidas?")){
      setArr(LS.brands, []);
      buildBrandDatalist();
      alert("Listo.");
    }
  }
};

/* =======================
   EXPORT CSV + BACKUP JSON + IMPORT
======================= */
document.getElementById("btnExport").onclick = ()=>{
  const orders = getArr(LS.orders).sort((a,b)=>a.numero-b.numero);
  const sales  = getArr(LS.sales).sort((a,b)=>a.numero-b.numero);

  const csvOrders = toCSV(orders, [
    "numero","cliente","cedula","telefono","correo","marca","modelo","falla","fechaISO","fecha"
  ]);
  const csvSales = toCSV(sales, [
    "numero","cliente","cedula","telefono","correo","marca","modelo","imei1","imei2","precio","terms","fechaISO","fecha"
  ]);

  downloadText("ordenes.csv", csvOrders);
  downloadText("ventas.csv", csvSales);
  alert("‚úÖ Descargu√© 2 archivos: ordenes.csv y ventas.csv (en PC es m√°s f√°cil).");
};

document.getElementById("btnBackup").onclick = ()=>{
  const payload = {
    app: "TechnologyExperts",
    exportedAt: new Date().toISOString(),
    orderCounter: getNum(LS.orderCounter,2100),
    saleCounter: getNum(LS.saleCounter,5000),
    brands: getArr(LS.brands),
    orders: getArr(LS.orders),
    sales: getArr(LS.sales)
  };
  downloadText("backup_technologyexperts.json", JSON.stringify(payload, null, 2));
  alert("‚úÖ Backup JSON descargado.");
};

document.getElementById("btnImport").onclick = ()=>{
  document.getElementById("importFile").click();
};
document.getElementById("importFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const text = await file.text();
  try{
    const data = JSON.parse(text);
    if(!data || typeof data !== "object") throw new Error("Formato inv√°lido");
    if(!confirm("¬øImportar backup? Esto REEMPLAZA los datos actuales en este dispositivo.")) return;

    setArr(LS.orders, Array.isArray(data.orders)?data.orders:[]);
    setArr(LS.sales, Array.isArray(data.sales)?data.sales:[]);
    setArr(LS.brands, Array.isArray(data.brands)?data.brands:[]);
    setNum(LS.orderCounter, Number(data.orderCounter)||2100);
    setNum(LS.saleCounter, Number(data.saleCounter)||5000);

    buildBrandDatalist();
    renderOrders();
    renderSales();
    alert("‚úÖ Importaci√≥n lista.");
  }catch(err){
    alert("No pude importar ese archivo. Aseg√∫rate que sea el backup JSON de esta app.");
  }finally{
    e.target.value = "";
  }
});

/* =======================
   HELPERS
======================= */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function toCSV(arr, fields){
  const header = fields.join(",");
  const lines = arr.map(obj=>{
    return fields.map(f=>{
      let v = obj?.[f];
      if(v===undefined || v===null) v="";
      v = String(v).replaceAll('"','""');
      return `"${v}"`;
    }).join(",");
  });
  return [header, ...lines].join("\n");
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
}

/* Inicial render si alguien entra directo */
renderOrders();
renderSales();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Technology Expert's</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 16px; background:#fff; }
    h1 { margin: 0 0 8px; }
    h2 { margin-top: 18px; }
    h3 { margin: 14px 0 8px; }
    .card { border:1px solid #e5e5e5; border-radius:14px; padding:14px; margin-top:12px; }
    input, textarea { width:100%; box-sizing:border-box; padding:12px; margin:8px 0; font-size:16px; border:1px solid #d8d8d8; border-radius:12px; }
    textarea { min-height: 90px; resize: vertical; }
    button { width:100%; padding:14px; font-size:16px; border:none; border-radius:12px; margin-top:10px; }
    .btn-primary { background:#000; color:#fff; }
    .btn-secondary { background:#666; color:#fff; }
    .row { display:flex; gap:10px; }
    .row > button { width: 50%; }
    .muted { color:#666; font-size: 13px; margin-top: 6px; }

    /* Firma */
    .firma-wrap { border:1px dashed #bfbfbf; border-radius:14px; padding:10px; background:#fafafa; }
    #firmaCanvas { width:100%; height:180px; display:block; border-radius:12px; background:#fff; border:1px solid #e0e0e0; touch-action: none; }
    .firma-hint { font-size: 13px; color:#666; margin: 0 0 8px; }
  </style>
</head>

<body>
  <h1>Technology Expert's</h1>
  <div class="muted">Orden de servicio (cel/tablet/PC). Guarda local (por ahora).</div>

  <div class="card">
    <h2>Orden de Servicio</h2>

    <h3>Datos del cliente</h3>
    <input id="cliente" placeholder="Nombre del cliente" autocomplete="name" />
    <input id="cedula" placeholder="C√©dula" inputmode="numeric" />
    <input id="telefono" placeholder="Celular" inputmode="tel" autocomplete="tel" />
    <input id="correo" placeholder="Correo electr√≥nico" inputmode="email" autocomplete="email" />

    <h3>Equipo</h3>
    <input id="marca" placeholder="Marca del celular" />
    <input id="modelo" placeholder="Modelo del celular" />
    <textarea id="falla" placeholder="Falla reportada"></textarea>

    <h3>Firma del cliente (obligatoria)</h3>
    <div class="firma-wrap">
      <p class="firma-hint">Firma con el dedo. Si no firmas, NO se guarda la orden.</p>
      <canvas id="firmaCanvas"></canvas>

      <div class="row">
        <button class="btn-secondary" onclick="borrarFirma()">üßΩ Borrar firma</button>
        <button class="btn-primary" onclick="guardar()">üíæ Guardar orden</button>
      </div>
    </div>

    <button class="btn-secondary" onclick="nuevaOrden()">üÜï Nueva orden (limpiar campos)</button>

    <h3>√ìrdenes guardadas</h3>
    <div id="lista"></div>
  </div>

<script>
  // ====== Storage ======
  let ordenes = JSON.parse(localStorage.getItem("ordenes")) || [];
  let contador = Number(localStorage.getItem("contador")) || 2100;

  // ====== Firma (Canvas) - funciona en m√≥vil y PC ======
  const canvas = document.getElementById("firmaCanvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });

  let dibujando = false;
  let hayFirma = false;

  function ajustarCanvas() {
    // Ajusta el tama√±o REAL del canvas para que coincida con el tama√±o visible
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;

    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // escala para dibujar correcto
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
  }

  function pos(e) {
    const r = canvas.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top };
  }

  canvas.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    dibujando = true;
    const p = pos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }, { passive: false });

  canvas.addEventListener("pointermove", (e) => {
    if (!dibujando) return;
    e.preventDefault();
    const p = pos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    hayFirma = true;
  }, { passive: false });

  function parar(e) {
    if (!dibujando) return;
    e.preventDefault();
    dibujando = false;
  }

  canvas.addEventListener("pointerup", parar, { passive: false });
  canvas.addEventListener("pointercancel", parar, { passive: false });
  canvas.addEventListener("pointerleave", parar, { passive: false });

  function borrarFirma() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    hayFirma = false;
  }

  function firmaBase64() {
    // Si no hay firma, devuelve vac√≠o (pero igual bloqueamos el guardado)
    if (!hayFirma) return "";
    return canvas.toDataURL("image/png");
  }

  // Ajustar canvas al cargar y al rotar pantalla
  window.addEventListener("load", () => { ajustarCanvas(); mostrar(); });
  window.addEventListener("resize", () => {
    // Si quieres conservar lo dibujado al rotar, se puede mejorar.
    // Por ahora lo re-ajusta y se borra la firma (m√°s seguro).
    ajustarCanvas();
    borrarFirma();
  });

  // ====== App ======
  function validarCampos() {
    const cliente = document.getElementById("cliente").value.trim();
    const cedula = document.getElementById("cedula").value.trim();
    const telefono = document.getElementById("telefono").value.trim();
    const correo = document.getElementById("correo").value.trim();
    const marca = document.getElementById("marca").value.trim();
    const modelo = document.getElementById("modelo").value.trim();
    const falla = document.getElementById("falla").value.trim();

    if (!cliente || !cedula || !telefono || !correo || !marca || !modelo || !falla) {
      alert("Completa todos los campos.");
      return null;
    }
    if (!hayFirma) {
      alert("La firma del cliente es obligatoria.");
      return null;
    }
    return { cliente, cedula, telefono, correo, marca, modelo, falla };
  }

  function guardar() {
    const datos = validarCampos();
    if (!datos) return;

    const orden = {
      numero: contador,
      ...datos,
      firma: firmaBase64(),
      fecha: new Date().toLocaleString()
    };

    ordenes.push(orden);
    contador++;

    // orden ascendente
    ordenes.sort((a, b) => a.numero - b.numero);

    localStorage.setItem("ordenes", JSON.stringify(ordenes));
    localStorage.setItem("contador", String(contador));

    mostrar();
    nuevaOrden();
    alert("Orden guardada ‚úÖ");
  }

  function nuevaOrden() {
    document.getElementById("cliente").value = "";
    document.getElementById("cedula").value = "";
    document.getElementById("telefono").value = "";
    document.getElementById("correo").value = "";
    document.getElementById("marca").value = "";
    document.getElementById("modelo").value = "";
    document.getElementById("falla").value = "";
    borrarFirma();
    document.getElementById("cliente").focus();
  }

  function eliminarOrden(num) {
    if (!confirm("¬øSeguro que quieres borrar la orden #" + num + "?")) return;
    ordenes = ordenes.filter(o => o.numero !== num);
    localStorage.setItem("ordenes", JSON.stringify(ordenes));
    mostrar();
  }

  function mostrar() {
    const lista = document.getElementById("lista");
    if (!ordenes.length) {
      lista.innerHTML = "<div class='muted'>No hay √≥rdenes guardadas.</div>";
      return;
    }

    lista.innerHTML = ordenes.map(o => `
      <div class="card">
        <b>Orden #${o.numero}</b><br>
        Cliente: ${escapeHtml(o.cliente)}<br>
        C√©dula: ${escapeHtml(o.cedula)}<br>
        Tel: ${escapeHtml(o.telefono)}<br>
        Email: ${escapeHtml(o.correo)}<br><br>
        Marca: ${escapeHtml(o.marca)}<br>
        Modelo: ${escapeHtml(o.modelo)}<br>
        Falla: ${escapeHtml(o.falla)}<br>
        <small>${escapeHtml(o.fecha)}</small><br><br>
        <button class="btn-secondary" onclick="eliminarOrden(${o.numero})">üóëÔ∏è Borrar esta orden</button>
      </div>
    `).join("");
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>
</body>
</html>

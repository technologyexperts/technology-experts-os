<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Technology Expert‚Äôs</title>

  <!-- ZXing: c√°mara para QR + c√≥digos de barras 1D -->
  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <!-- QR generator (para imprimir/etiqueta) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --blue1:#0b2dff;
      --blue2:#001b8f;
      --black:#000000;
      --white:#ffffff;
      --glass: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.18);
      --shadow: 0 18px 40px rgba(0,0,0,.22);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--white);
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(900px 520px at 80% 30%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(180deg, var(--blue1), var(--blue2));
    }

    .wrap{width:min(980px,92vw); margin:0 auto; padding:26px 0 42px;}
    .hero{padding:22px 16px 16px;}
    .brand{
      margin:0 0 6px;
      font-size:44px; line-height:1.05;
      font-weight:900;
      letter-spacing:.2px;
      text-shadow:0 10px 30px rgba(0,0,0,.20);
    }
    .subtitle{margin:0; opacity:.93; font-weight:800; font-size:15px;}

    .glass{
      margin-top:14px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .panel{
      margin-top:16px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      border-radius:var(--radius);
      padding:16px;
    }
    .panel h2{margin:0 0 8px; font-size:28px; font-weight:900;}
    .panel h3{margin:16px 0 10px; font-size:18px; font-weight:900;}
    .hidden{display:none !important;}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width:600px){ .grid2{grid-template-columns:1fr;} .brand{font-size:38px;} }

    /* BOTONES: negros + letras blancas en negrilla */
    .btn{
      width:100%;
      border:0;
      border-radius:16px;
      padding:14px 14px;
      background: var(--black);
      color: var(--white);
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .btn:active{transform:scale(.99);}
    .btn.secondary{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:none;
    }
    .btn.row{
      justify-content:space-between;
      padding:16px 18px;
      border-radius:18px;
      font-size:17px;
    }
    .btn.small{
      padding:10px 12px;
      font-size:13px;
      border-radius:999px;
      box-shadow:none;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.30);
      justify-content:center;
    }
    .btn.danger{background:#b00000;}

    .pillRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .actionsRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}

    .badgeNum{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.20);
      font-weight:900;
      margin:10px 0 4px;
    }
    .bigNum{font-size:20px; letter-spacing:.4px;}

    .inputs{display:grid; grid-template-columns:1fr; gap:10px;}
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width:600px){ .row2{grid-template-columns:1fr;} }

    input,textarea,select{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      color:#fff;
      font-weight:900;
      outline:none;
      font-size:15px;
    }
    textarea{min-height:86px; resize:vertical;}
    input::placeholder,textarea::placeholder{color:rgba(255,255,255,.82); font-weight:900;}

    .card{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px;
      padding:14px;
    }
    .title{font-weight:900; font-size:16px; margin-bottom:6px;}
    .kv{display:grid; grid-template-columns:1fr; gap:2px; font-weight:900; opacity:.98;}
    .muted{opacity:.9; font-weight:900;}

    .sigBox{
      background: rgba(255,255,255,.08);
      border:2px dashed rgba(255,255,255,.35);
      border-radius:16px;
      overflow:hidden;
    }
    canvas{width:100%; height:180px; display:block; background:rgba(0,0,0,.08); touch-action:none;}

    /* QR output */
    .qrBox{
      margin-top:10px;
      padding:10px;
      border-radius:16px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.20);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .qrRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .qrImg{background:#fff; border-radius:12px; padding:8px; width:220px; max-width:100%;}
    .qrImg canvas{width:100% !important; height:auto !important; background:#fff !important;}

    /* Modal scanner */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal.active{display:flex;}
    .modalCard{
      width:min(520px, 96vw);
      background:#fff;
      color:#0b1220;
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .modalTop{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px;
      font-weight:900;
      background:#f3f4f6;
    }
    .xBtn{
      border:0;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      background:#e5e7eb;
    }
    .modalBody{padding:12px 14px;}
    video{width:100%; border-radius:14px; background:#000;}

    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:18px;
      background: rgba(0,0,0,.85);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      font-weight:900;
      display:none;
      z-index:99999;
      max-width:92vw;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1 class="brand">Technology Expert‚Äôs</h1>
      <p class="subtitle">√ìrdenes + Ventas + Inventario. Todo en un solo archivo. Sin servidor (por ahora).</p>

      <!-- HOME -->
      <div id="home" class="glass">
        <div class="grid2">
          <button class="btn row" id="goOrden">üßæ <span>Orden de servicio</span> <span>‚Ä∫</span></button>
          <button class="btn row" id="goVentas">üí≥ <span>Ventas</span> <span>‚Ä∫</span></button>
        </div>

        <div style="margin-top:12px">
          <button class="btn row" id="goInventario">üì¶ <span>Inventario</span> <span>‚Ä∫</span></button>
        </div>

        <div class="pillRow">
          <button class="btn small" id="adminBtn">üîí Admin PIN</button>
          <button class="btn small" id="openScannerHome">üì∑ Escanear (QR / Barras)</button>
          <button class="btn small" id="backupBtn">üì¶ Backup JSON</button>
          <button class="btn small" id="exportOrdenCsv">‚¨áÔ∏è CSV √ìrdenes</button>
          <button class="btn small" id="exportVentaCsv">‚¨áÔ∏è CSV Ventas</button>
          <button class="btn small" id="exportInvCsv">‚¨áÔ∏è CSV Inventario</button>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="title">B√∫squeda r√°pida</div>
          <input id="globalSearch" placeholder="Buscar por #, nombre, c√©dula, tel, correo, marca, IMEI, c√≥digo producto..." />
        </div>
      </div>

      <!-- RESULTS -->
      <div id="resultsPanel" class="panel hidden">
        <div class="actionsRow">
          <button class="btn small" id="backHomeResults">‚¨ÖÔ∏è Inicio</button>
          <button class="btn small danger" id="clearSearch">üßπ Limpiar</button>
        </div>
        <h2>Resultados</h2>
        <div id="resultsList" class="kv"></div>
      </div>
       <!-- ORDEN -->
      <div id="ordenPanel" class="panel hidden">
        <div class="actionsRow">
          <button class="btn small" id="backHomeOrden">‚¨ÖÔ∏è Inicio</button>
          <button class="btn small secondary" id="ordenNueva">üÜï Nueva orden</button>
        </div>

        <h2>Orden de Servicio</h2>
        <div class="badgeNum"><span>üßæ N√∫mero:</span> <span class="bigNum" id="ordenNumLabel">#----</span></div>

        <h3>Datos del cliente</h3>
        <div class="inputs">
          <input id="o_cliente" placeholder="Nombre del cliente" autocomplete="name" />
          <div class="row2">
            <input id="o_cedula" placeholder="C√©dula" inputmode="numeric" />
            <input id="o_tel" placeholder="Celular" inputmode="tel" />
          </div>
          <input id="o_correo" placeholder="Correo electr√≥nico" autocomplete="email" list="emailDomains" />
          <datalist id="emailDomains"></datalist>
        </div>

        <h3>Equipo</h3>
        <div class="inputs">
          <input id="o_marca" placeholder="Marca (Samsung, Xiaomi, iPhone...)" list="brandList" />
          <datalist id="brandList"></datalist>
          <input id="o_modelo" placeholder="Modelo (ej: A21s, Redmi Note 12...)" />
          <textarea id="o_falla" placeholder="Falla reportada"></textarea>
        </div>

        <h3>Firma del cliente (OBLIGATORIA)</h3>
        <div class="sigBox"><canvas id="sigCanvas"></canvas></div>
        <div class="actionsRow">
          <button class="btn small secondary" id="clearSig">üßº Borrar firma</button>
          <button class="btn" id="guardarOrden">üíæ Guardar orden</button>
        </div>

        <div id="ordenQrBox" class="qrBox hidden">
          <div class="qrRow">
            <div class="muted" id="ordenQrText">QR orden</div>
            <button class="btn small" id="printOrden">üñ®Ô∏è Imprimir</button>
          </div>
          <div class="qrImg" id="ordenQrImg"></div>
        </div>

        <h3>√ìrdenes guardadas</h3>
        <input id="o_search" placeholder="Buscar orden..." />
        <div id="ordenList" class="kv" style="margin-top:10px"></div>
      </div>

      <!-- VENTAS -->
      <div id="ventaPanel" class="panel hidden">
        <div class="actionsRow">
          <button class="btn small" id="backHomeVenta">‚¨ÖÔ∏è Inicio</button>
          <button class="btn small secondary" id="ventaNueva">üÜï Nueva venta</button>
        </div>

        <h2>Ventas</h2>
        <div class="badgeNum"><span>üí≥ N√∫mero:</span> <span class="bigNum" id="ventaNumLabel">#----</span></div>

        <h3>Cliente</h3>
        <div class="inputs">
          <input id="v_cliente" placeholder="Nombre del cliente" autocomplete="name" />
          <div class="row2">
            <input id="v_cedula" placeholder="C√©dula" inputmode="numeric" />
            <input id="v_tel" placeholder="Celular" inputmode="tel" />
          </div>
        </div>

        <h3>Tipo de venta</h3>
        <select id="v_tipo">
          <option value="celular">Venta de celular</option>
          <option value="accesorio">Accesorio / repuesto</option>
          <option value="servicio">Servicio</option>
          <option value="otro">Otro</option>
        </select>

        <div id="ventaCelularBox">
          <h3>Datos del celular (IMEI)</h3>
          <div class="inputs">
            <input id="v_marca" placeholder="Marca" list="brandList" />
            <input id="v_modelo" placeholder="Modelo" />
            <div class="row2">
              <button class="btn small" id="scanImei1">üì∑ Escanear IMEI1</button>
              <button class="btn small" id="scanImei2">üì∑ Escanear IMEI2</button>
            </div>
            <input id="v_imei1" placeholder="IMEI 1 (obligatorio)" inputmode="numeric" />
            <input id="v_imei2" placeholder="IMEI 2 (opcional)" inputmode="numeric" />
          </div>

          <h3>T√©rminos IMEI (OBLIGATORIO aceptar)</h3>
          <div class="card">
            <div class="kv">
              <div>‚Ä¢ El cliente reconoce que debe registrar el/los IMEI ante el operador.</div>
              <div>‚Ä¢ <b>No respondemos si el cliente NO registra los IMEI en la base de datos del operador.</b></div>
            </div>
          </div>
          <label style="display:block; margin-top:8px; font-weight:900;">
            <input type="checkbox" id="v_terms" />
            Acepto los t√©rminos para esta venta de celular
          </label>
        </div>

        <h3>Producto / Pago</h3>
        <div class="inputs">
          <input id="v_desc" placeholder="Descripci√≥n (ej: Samsung A15 128GB / Cable USB / etc.)" />
          <div class="row2">
            <input id="v_total" placeholder="Total ($)" inputmode="decimal" />
            <select id="v_pago">
              <option value="efectivo">Efectivo</option>
              <option value="transferencia">Transferencia</option>
              <option value="tarjeta">Tarjeta</option>
            </select>
          </div>

          <div class="card">
            <div class="title">Agregar desde inventario (por c√≥digo)</div>
            <div class="row2">
              <button class="btn small" id="scanToAddSale">üì∑ Escanear c√≥digo</button>
              <input id="saleCodeSearch" placeholder="C√≥digo (EAN/QR) y Enter" />
            </div>
            <div class="kv" id="saleAddInfo" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="actionsRow">
          <button class="btn" id="guardarVenta">üíæ Guardar venta</button>
        </div>

        <div id="ventaQrBox" class="qrBox hidden">
          <div class="qrRow">
            <div class="muted" id="ventaQrText">QR venta</div>
            <button class="btn small" id="printVenta">üñ®Ô∏è Imprimir</button>
          </div>
          <div class="qrImg" id="ventaQrImg"></div>
        </div>

        <h3>Ventas guardadas</h3>
        <input id="v_search" placeholder="Buscar venta..." />
        <div id="ventaList" class="kv" style="margin-top:10px"></div>
      </div>

      <!-- INVENTARIO -->
      <div id="invPanel" class="panel hidden">
        <div class="actionsRow">
          <button class="btn small" id="backHomeInv">‚¨ÖÔ∏è Inicio</button>
          <button class="btn small secondary" id="invNewBtn">üÜï Nuevo producto</button>
        </div>

        <h2>Inventario</h2>

        <!-- Primera pantalla inventario: escanear + buscar -->
        <div class="card">
          <div class="title">Buscar / Agregar por c√≥digo</div>
          <div class="row2">
            <button class="btn" id="invScanBtn">üì∑ Escanear c√≥digo</button>
            <input id="invCodeSearch" placeholder="C√≥digo (EAN/QR) y Enter" />
          </div>
          <div class="kv" id="invSearchInfo" style="margin-top:10px"></div>
        </div>

        <!-- Formulario producto -->
        <div id="invFormBox" class="card hidden" style="margin-top:12px;">
          <div class="title" id="invFormTitle">Producto</div>

          <div class="inputs">
            <input id="p_code" placeholder="C√≥digo (EAN/QR)" />
            <input id="p_name" placeholder="Nombre / Descripci√≥n" />
            <div class="row2">
              <input id="p_cat" placeholder="Categor√≠a (Celulares/PC/Consolas)" />
              <input id="p_subcat" placeholder="Subcategor√≠a (cables/accesorios/etc.)" />
            </div>
            <div class="row2">
              <input id="p_price" placeholder="Precio venta ($)" inputmode="decimal" />
              <input id="p_stock" placeholder="Cantidad (stock)" inputmode="numeric" />
            </div>

            <!-- costo solo admin -->
            <input id="p_cost" placeholder="Costo ($) - solo admin" inputmode="decimal" />
          </div>

          <div class="actionsRow">
            <button class="btn small secondary" id="invCancelBtn">Cancelar</button>
            <button class="btn" id="invSaveBtn">üíæ Guardar producto</button>
          </div>
        </div>

        <h3>Productos</h3>
        <input id="invSearchText" placeholder="Buscar por nombre/categor√≠a/c√≥digo..." />
        <div id="invList" class="kv" style="margin-top:10px"></div>
      </div>

      <!-- ADMIN -->
      <div id="adminPanel" class="panel hidden">
        <div class="actionsRow">
          <button class="btn small" id="backHomeAdmin">‚¨ÖÔ∏è Inicio</button>
        </div>

        <h2>Admin (PIN)</h2>
        <div class="card">
          <div class="kv">
            <div>PIN por defecto: <b>1234</b></div>
            <div>Con admin puedes: ver costos, borrar, exportar e importar.</div>
          </div>
        </div>

        <div class="inputs" style="margin-top:10px">
          <input id="pinInput" placeholder="PIN" inputmode="numeric" />
          <button class="btn" id="pinEnter">Entrar</button>
        </div>

        <div id="adminTools" class="card hidden" style="margin-top:12px">
          <div class="title">Herramientas admin</div>
          <div class="pillRow">
            <button class="btn small" id="changePinBtn">üîÅ Cambiar PIN</button>
            <button class="btn small danger" id="wipeAllBtn">üß® Borrar TODO</button>
          </div>
          <div class="pillRow">
            <button class="btn small" id="backupBtn2">üì¶ Backup JSON</button>
            <button class="btn small" id="exportInvCsv2">‚¨áÔ∏è CSV Inventario</button>
            <button class="btn small" id="exportOrdenCsv2">‚¨áÔ∏è CSV √ìrdenes</button>
            <button class="btn small" id="exportVentaCsv2">‚¨áÔ∏è CSV Ventas</button>
          </div>
        </div>
      </div>

      <input id="importFile" type="file" accept="application/json" class="hidden" />

    </div>
  </div>

  <!-- SCANNER MODAL -->
  <div id="scannerModal" class="modal">
    <div class="modalCard">
      <div class="modalTop">
        <div>Escanear (QR / Barras)</div>
        <button class="xBtn" id="closeScannerBtn">‚úñ</button>
      </div>
      <div class="modalBody">
        <video id="scannerVideo" muted playsinline></video>
        <div style="margin-top:10px; font-weight:900; font-size:13px; color:#111827;">
          Consejo: para c√≥digos 1D (EAN/UPC) usa buena luz y enfoca las ‚Äúrayitas‚Äù.
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  /* =========================
   STORAGE
========================= */
const LS = {
  orders: "te_orders_v2",
  sales: "te_sales_v2",
  products: "te_products_v2",
  orderCounter: "te_orderCounter_v2",
  saleCounter: "te_saleCounter_v2",
  pin: "te_adminPin_v2",
  brands: "te_brands_v2",
  adminSession: "te_adminSession_v2"
};

function getArr(key){ try{ return JSON.parse(localStorage.getItem(key) || "[]"); }catch(e){ return []; } }
function setArr(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }
function getNum(key, fallback){ const v = Number(localStorage.getItem(key)); return Number.isFinite(v) && v>0 ? v : fallback; }
function setNum(key, v){ localStorage.setItem(key, String(v)); }
function nowISO(){ return new Date().toISOString(); }
function fmtDate(iso){ try{ return new Date(iso).toLocaleString("es-CO"); }catch(e){ return iso||""; } }
function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.style.display="none", 2200);
}

/* defaults */
if(!localStorage.getItem(LS.orderCounter)) setNum(LS.orderCounter, 2100);
if(!localStorage.getItem(LS.saleCounter)) setNum(LS.saleCounter, 315);
if(!localStorage.getItem(LS.pin)) localStorage.setItem(LS.pin, "1234");

/* =========================
   EMAIL + BRANDS
========================= */
const emailDomains = ["gmail.com","hotmail.com","outlook.com","icloud.com","yahoo.com","live.com","proton.me","protonmail.com"];
(function buildEmailDL(){
  const dl = document.getElementById("emailDomains");
  dl.innerHTML = "";
  emailDomains.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = "@"+d;
    dl.appendChild(opt);
  });
})();

const defaultBrands = [
 "Samsung","Xiaomi","Redmi","POCO","Realme","Huawei","Honor","Motorola","Nokia",
 "Apple","iPhone","Tecno","Infinix","Itel","OPPO","Vivo","OnePlus","Sony","LG","Google Pixel","Asus","Lenovo","TCL"
];

function getBrands(){
  const learned = getArr(LS.brands);
  const all = Array.from(new Set([...defaultBrands, ...learned]));
  all.sort((a,b)=>a.localeCompare(b,"es",{sensitivity:"base"}));
  return all;
}
function learnBrand(b){
  const v = (b||"").trim();
  if(!v) return;
  const learned = getArr(LS.brands);
  const exists = [...defaultBrands, ...learned].some(x=>x.toLowerCase()===v.toLowerCase());
  if(exists) return;
  learned.push(v);
  setArr(LS.brands, learned);
  buildBrandDL();
}
function buildBrandDL(){
  const dl = document.getElementById("brandList");
  dl.innerHTML = "";
  getBrands().forEach(b=>{
    const opt = document.createElement("option");
    opt.value = b;
    dl.appendChild(opt);
  });
}
buildBrandDL();

/* =========================
   NAV
========================= */
const home = document.getElementById("home");
const resultsPanel = document.getElementById("resultsPanel");
const ordenPanel = document.getElementById("ordenPanel");
const ventaPanel = document.getElementById("ventaPanel");
const invPanel = document.getElementById("invPanel");
const adminPanel = document.getElementById("adminPanel");

function hideAll(){
  home.classList.add("hidden");
  resultsPanel.classList.add("hidden");
  ordenPanel.classList.add("hidden");
  ventaPanel.classList.add("hidden");
  invPanel.classList.add("hidden");
  adminPanel.classList.add("hidden");
}
function showHome(){ hideAll(); home.classList.remove("hidden"); }
function showOrden(){ hideAll(); ordenPanel.classList.remove("hidden"); refreshOrderLabel(); resizeSig(); renderOrders(); }
function showVenta(){ hideAll(); ventaPanel.classList.remove("hidden"); refreshSaleLabel(); renderSales(); }
function showInv(){ hideAll(); invPanel.classList.remove("hidden"); renderProducts(); clearInvSearchInfo(); }
function showAdmin(){ hideAll(); adminPanel.classList.remove("hidden"); document.getElementById("pinInput").value=""; document.getElementById("adminTools").classList.add("hidden"); }

document.getElementById("goOrden").onclick = showOrden;
document.getElementById("goVentas").onclick = showVenta;
document.getElementById("goInventario").onclick = showInv;
document.getElementById("adminBtn").onclick = showAdmin;

document.getElementById("backHomeResults").onclick = showHome;
document.getElementById("backHomeOrden").onclick = showHome;
document.getElementById("backHomeVenta").onclick = showHome;
document.getElementById("backHomeInv").onclick = showHome;
document.getElementById("backHomeAdmin").onclick = showHome;

/* =========================
   GLOBAL SEARCH
========================= */
const globalSearch = document.getElementById("globalSearch");
globalSearch.addEventListener("input", ()=>{
  const q = globalSearch.value.trim();
  if(!q){ resultsPanel.classList.add("hidden"); return; }
  const res = globalSearchAll(q);
  renderResults(q, res);
});

document.getElementById("backHomeResults").onclick = showHome;
document.getElementById("clearSearch").onclick = ()=>{ globalSearch.value=""; showHome(); };

function globalSearchAll(q){
  const f = q.toLowerCase();
  const orders = getArr(LS.orders).filter(o => JSON.stringify(o).toLowerCase().includes(f));
  const sales  = getArr(LS.sales).filter(s => JSON.stringify(s).toLowerCase().includes(f));
  const products = getArr(LS.products).filter(p => JSON.stringify(p).toLowerCase().includes(f));
  return {orders, sales, products};
}
function renderResults(q, res){
  hideAll(); resultsPanel.classList.remove("hidden");
  const box = document.getElementById("resultsList");
  let html = `<div style="font-weight:900;margin-bottom:8px">B√∫squeda: "${esc(q)}"</div>`;
  html += `<div>√ìrdenes: ${res.orders.length} ‚Ä¢ Ventas: ${res.sales.length} ‚Ä¢ Inventario: ${res.products.length}</div><br/>`;

  if(res.products.length){
    html += `<div style="font-weight:900;margin:10px 0 6px">üì¶ Inventario</div>`;
    res.products.slice(0,10).forEach(p=>{
      html += `<div>‚Ä¢ ${esc(p.code)} ‚Äî ${esc(p.name)} (stock: ${esc(p.stock)})</div>`;
    });
  }
  if(res.orders.length){
    html += `<div style="font-weight:900;margin:10px 0 6px">üßæ √ìrdenes</div>`;
    res.orders.slice(0,10).forEach(o=>{
      html += `<div>‚Ä¢ #${o.numero} ‚Äî ${esc(o.cliente)} ‚Äî ${esc(o.marca)} ${esc(o.modelo)}</div>`;
    });
  }
  if(res.sales.length){
    html += `<div style="font-weight:900;margin:10px 0 6px">üí≥ Ventas</div>`;
    res.sales.slice(0,10).forEach(s=>{
      html += `<div>‚Ä¢ #${s.numero} ‚Äî ${esc(s.cliente)} ‚Äî ${esc(s.descripcion)} ${s.imei1?("‚Äî IMEI: "+esc(s.imei1)):""}</div>`;
    });
  }

  if(!res.products.length && !res.orders.length && !res.sales.length){
    html += `<div>No hay coincidencias.</div>`;
  }

  box.innerHTML = html;
}

/* =========================
   SCANNER (ZXing camera)
========================= */
let zxingReader = null;
let zxingControls = null;
let scanTarget = null; // {type:'input'|'fn', id|fn}

const scannerModal = document.getElementById("scannerModal");
const scannerVideo = document.getElementById("scannerVideo");
document.getElementById("closeScannerBtn").onclick = closeScanner;

async function openScannerToInput(inputId){
  scanTarget = {type:"input", id: inputId};
  await openScanner();
}
async function openScannerToFunction(fn){
  scanTarget = {type:"fn", fn};
  await openScanner();
}

async function openScanner(){
  try{
    scannerModal.classList.add("active");
    if(!window.ZXing || !ZXing.BrowserMultiFormatReader){
      alert("No carg√≥ el lector. Revisa internet.");
      closeScanner();
      return;
    }
    if(!zxingReader) zxingReader = new ZXing.BrowserMultiFormatReader();

    const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
    const backCam = devices.find(d=>/back|rear|environment/i.test(d.label));
    const deviceId = (backCam || devices[0])?.deviceId;

    if(!deviceId){
      alert("No se encontr√≥ c√°mara. Da permisos a la c√°mara.");
      closeScanner();
      return;
    }

    zxingControls = await zxingReader.decodeFromVideoDevice(
      deviceId,
      scannerVideo,
      (result, err) => {
        if(result){
          const text = result.getText();
          if(scanTarget?.type==="input"){
            const el = document.getElementById(scanTarget.id);
            if(el){
              el.value = text;
              el.dispatchEvent(new Event("input",{bubbles:true}));
              el.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter"}));
            }
          } else if(scanTarget?.type==="fn"){
            scanTarget.fn(text);
          }
          if(navigator.vibrate) navigator.vibrate(70);
          toast("Escaneado: " + text);
          closeScanner();
        }
      }
    );

  }catch(e){
    console.error(e);
    alert("Error abriendo el esc√°ner. Revisa permisos de c√°mara.");
    closeScanner();
  }
}

function closeScanner(){
  scannerModal.classList.remove("active");
  try{
    if(zxingControls){ zxingControls.stop(); zxingControls=null; }
  }catch(e){}
}

document.getElementById("openScannerHome").onclick = ()=>openScannerToFunction((code)=>{
  // b√∫squeda global al escanear desde home
  globalSearch.value = code;
  const res = globalSearchAll(code);
  renderResults(code, res);
});
  /* =========================
   QR OUTPUT (qrcodejs)
========================= */
function renderQR(containerId, text){
  const box = document.getElementById(containerId);
  box.innerHTML = "";
  new QRCode(box, {text, width:220, height:220});
}

/* =========================
   SIGNATURE (Orden)
========================= */
const canvas = document.getElementById("sigCanvas");
const ctx = canvas.getContext("2d");
let drawing=false, hasSig=false;

function resizeSig(){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#111";
}
window.addEventListener("resize", ()=>{ if(!ordenPanel.classList.contains("hidden")) resizeSig(); });

function pos(e){
  const r = canvas.getBoundingClientRect();
  const t = (e.touches && e.touches[0]) ? e.touches[0] : e;
  return {x: t.clientX - r.left, y: t.clientY - r.top};
}
function start(e){
  drawing=true;
  const p = pos(e);
  ctx.beginPath();
  ctx.moveTo(p.x,p.y);
  e.preventDefault?.();
}
function move(e){
  if(!drawing) return;
  const p = pos(e);
  ctx.lineTo(p.x,p.y);
  ctx.stroke();
  hasSig=true;
  e.preventDefault?.();
}
function end(){ drawing=false; }

canvas.addEventListener("mousedown", start);
canvas.addEventListener("mousemove", move);
window.addEventListener("mouseup", end);
canvas.addEventListener("touchstart", start, {passive:false});
canvas.addEventListener("touchmove", move, {passive:false});
canvas.addEventListener("touchend", end);

document.getElementById("clearSig").onclick = ()=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);
  hasSig=false;
  toast("Firma borrada");
};
function sigData(){ return canvas.toDataURL("image/png"); }

/* =========================
   ORDERS
========================= */
const o_cliente=document.getElementById("o_cliente");
const o_cedula=document.getElementById("o_cedula");
const o_tel=document.getElementById("o_tel");
const o_correo=document.getElementById("o_correo");
const o_marca=document.getElementById("o_marca");
const o_modelo=document.getElementById("o_modelo");
const o_falla=document.getElementById("o_falla");

function nextOrder(){ return getNum(LS.orderCounter,2100); }
function refreshOrderLabel(){ document.getElementById("ordenNumLabel").textContent = "#" + nextOrder(); }

document.getElementById("ordenNueva").onclick = ()=>{
  [o_cliente,o_cedula,o_tel,o_correo,o_marca,o_modelo,o_falla].forEach(x=>x.value="");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  hasSig=false;
  document.getElementById("ordenQrBox").classList.add("hidden");
  refreshOrderLabel();
  o_cliente.focus();
  toast("Nueva orden lista");
};

document.getElementById("guardarOrden").onclick = ()=>{
  if(!o_cliente.value.trim()||!o_cedula.value.trim()||!o_tel.value.trim()||!o_correo.value.trim()||!o_marca.value.trim()||!o_modelo.value.trim()||!o_falla.value.trim()){
    alert("Completa todos los campos de la orden.");
    return;
  }
  if(!hasSig){
    alert("La firma es obligatoria para guardar la orden.");
    return;
  }

  const num = nextOrder();
  const orders = getArr(LS.orders);
  const order = {
    numero:num,
    fechaISO: nowISO(),
    cliente:o_cliente.value.trim(),
    cedula:o_cedula.value.trim(),
    tel:o_tel.value.trim(),
    correo:o_correo.value.trim(),
    marca:o_marca.value.trim(),
    modelo:o_modelo.value.trim(),
    falla:o_falla.value.trim(),
    firmaPng: sigData()
  };
  orders.push(order);
  orders.sort((a,b)=>a.numero-b.numero);
  setArr(LS.orders, orders);
  setNum(LS.orderCounter, num+1);
  learnBrand(order.marca);

  toast("Orden guardada #" + num);
  refreshOrderLabel();
  renderOrders();

  // QR
  const text = `ORDEN#${order.numero} | ${order.cliente} | ${order.cedula} | ${order.tel} | ${order.marca} ${order.modelo}`;
  document.getElementById("ordenQrText").textContent = "QR Orden #" + order.numero;
  document.getElementById("ordenQrBox").classList.remove("hidden");
  renderQR("ordenQrImg", text);
};

document.getElementById("o_search").addEventListener("input", renderOrders);

function renderOrders(){
  const q = (document.getElementById("o_search").value||"").trim().toLowerCase();
  const orders = getArr(LS.orders);
  const filtered = q ? orders.filter(o=>JSON.stringify(o).toLowerCase().includes(q)) : orders;

  const box = document.getElementById("ordenList");
  if(!filtered.length){ box.innerHTML = "<div>No hay √≥rdenes.</div>"; return; }

  box.innerHTML = filtered.map(o=>`
    <div class="card" style="margin-bottom:10px">
      <div class="title">Orden #${o.numero}</div>
      <div class="kv">
        <div>Cliente: <span class="muted">${esc(o.cliente)}</span></div>
        <div>C√©dula: <span class="muted">${esc(o.cedula)}</span></div>
        <div>Tel: <span class="muted">${esc(o.tel)}</span></div>
        <div>Correo: <span class="muted">${esc(o.correo)}</span></div>
        <div style="margin-top:6px">Equipo: <span class="muted">${esc(o.marca)} ${esc(o.modelo)}</span></div>
        <div>Falla: <span class="muted">${esc(o.falla)}</span></div>
        <div style="margin-top:6px">Fecha: <span class="muted">${fmtDate(o.fechaISO)}</span></div>
      </div>
      <div class="actionsRow">
        <button class="btn small" onclick="showOrderQR(${o.numero})">üî≥ QR</button>
        <button class="btn small secondary" onclick="showOrderSig(${o.numero})">‚úçÔ∏è Firma</button>
        <button class="btn small danger" onclick="deleteOrder(${o.numero})">üóëÔ∏è Borrar</button>
      </div>
    </div>
  `).join("");
}

window.showOrderQR = (numero)=>{
  const o = getArr(LS.orders).find(x=>x.numero===numero);
  if(!o) return;
  const text = `ORDEN#${o.numero} | ${o.cliente} | ${o.cedula} | ${o.tel} | ${o.marca} ${o.modelo}`;
  document.getElementById("ordenQrText").textContent = "QR Orden #" + o.numero;
  document.getElementById("ordenQrBox").classList.remove("hidden");
  renderQR("ordenQrImg", text);
  toast("QR de orden listo");
};

window.showOrderSig = (numero)=>{
  const o = getArr(LS.orders).find(x=>x.numero===numero);
  if(!o || !o.firmaPng){ alert("No hay firma."); return; }
  // usar QR box para mostrar la firma
  document.getElementById("ordenQrText").textContent = "Firma Orden #" + o.numero;
  document.getElementById("ordenQrBox").classList.remove("hidden");
  const box = document.getElementById("ordenQrImg");
  box.innerHTML = `<img src="${o.firmaPng}" style="max-width:100%;border-radius:12px">`;
};

window.deleteOrder = (numero)=>{
  if(!confirm("¬øBorrar orden #" + numero + "?")) return;
  const orders = getArr(LS.orders).filter(x=>x.numero!==numero);
  setArr(LS.orders, orders);
  renderOrders();
  toast("Orden borrada");
};

/* Print */
document.getElementById("printOrden").onclick = ()=>printBox("ordenQrText","ordenQrImg");

function printBox(titleId, contentId){
  const title = document.getElementById(titleId).textContent;
  const content = document.getElementById(contentId).innerHTML;
  const w = window.open("", "_blank");
  w.document.write(`
    <html><head><title>${esc(title)}</title>
    <style>
      body{font-family:Arial,sans-serif;padding:18px;}
      .box{border:1px solid #ddd;padding:12px;border-radius:10px;max-width:420px;}
      h2{margin:0 0 10px;}
      img,canvas{max-width:100%;}
    </style></head><body>
      <div class="box">
        <h2>${esc(title)}</h2>
        ${content}
      </div>
    </body></html>
  `);
  w.document.close(); w.focus(); w.print();
}

/* =========================
   SALES
========================= */
const v_cliente=document.getElementById("v_cliente");
const v_cedula=document.getElementById("v_cedula");
const v_tel=document.getElementById("v_tel");
const v_tipo=document.getElementById("v_tipo");
const ventaCelularBox=document.getElementById("ventaCelularBox");
const v_marca=document.getElementById("v_marca");
const v_modelo=document.getElementById("v_modelo");
const v_imei1=document.getElementById("v_imei1");
const v_imei2=document.getElementById("v_imei2");
const v_terms=document.getElementById("v_terms");
const v_desc=document.getElementById("v_desc");
const v_total=document.getElementById("v_total");
const v_pago=document.getElementById("v_pago");

function nextSale(){ return getNum(LS.saleCounter,315); }
function refreshSaleLabel(){ document.getElementById("ventaNumLabel").textContent = "#" + nextSale(); }

v_tipo.onchange = ()=>{
  const isCel = v_tipo.value==="celular";
  ventaCelularBox.classList.toggle("hidden", !isCel);
};

document.getElementById("ventaNueva").onclick = ()=>{
  [v_cliente,v_cedula,v_tel,v_marca,v_modelo,v_imei1,v_imei2,v_desc,v_total].forEach(x=>x.value="");
  v_tipo.value="celular";
  v_pago.value="efectivo";
  v_terms.checked=false;
  ventaCelularBox.classList.remove("hidden");
  document.getElementById("ventaQrBox").classList.add("hidden");
  refreshSaleLabel();
  v_cliente.focus();
  toast("Nueva venta lista");
};

document.getElementById("scanImei1").onclick = ()=>openScannerToInput("v_imei1");
document.getElementById("scanImei2").onclick = ()=>openScannerToInput("v_imei2");

document.getElementById("scanToAddSale").onclick = ()=>openScannerToFunction((code)=>{
  document.getElementById("saleCodeSearch").value = code;
  tryAddProductToSaleByCode(code);
});

document.getElementById("saleCodeSearch").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    tryAddProductToSaleByCode(e.target.value.trim());
  }
});

function tryAddProductToSaleByCode(code){
  if(!code) return;
  const p = getArr(LS.products).find(x=>String(x.code)===String(code));
  const info = document.getElementById("saleAddInfo");
  if(!p){
    info.innerHTML = `No existe producto con c√≥digo <b>${esc(code)}</b>. Ve a Inventario para crearlo.`;
    return;
  }
  // autollenar descripci√≥n + total si est√° vac√≠o
  info.innerHTML = `Producto encontrado: <b>${esc(p.name)}</b> (stock: ${esc(p.stock)}) ‚Äî precio: <b>${esc(p.price)}</b>`;
  if(!v_desc.value.trim()) v_desc.value = p.name;
  if(!v_total.value.trim()) v_total.value = p.price;

  // bajar stock solo cuando guardas la venta (para no descontar por error)
  info.dataset.pendingCode = code;
}

document.getElementById("guardarVenta").onclick = ()=>{
  if(!v_cliente.value.trim() || !v_cedula.value.trim() || !v_tel.value.trim() || !v_desc.value.trim() || !v_total.value.trim()){
    alert("Completa los campos principales de la venta.");
    return;
  }

  const tipo = v_tipo.value;
  if(tipo==="celular"){
    if(!v_marca.value.trim() || !v_modelo.value.trim()){ alert("En venta de celular: completa marca y modelo."); return; }
    if(!v_imei1.value.trim()){ alert("IMEI 1 es obligatorio."); return; }
    if(!v_terms.checked){ alert("Debes aceptar los t√©rminos IMEI."); return; }
    learnBrand(v_marca.value.trim());
  }

  const num = nextSale();
  const sales = getArr(LS.sales);

  // si viene desde inventario, descontar stock
  const info = document.getElementById("saleAddInfo");
  const pendingCode = info.dataset.pendingCode || "";
  if(pendingCode){
    const products = getArr(LS.products);
    const idx = products.findIndex(x=>String(x.code)===String(pendingCode));
    if(idx>=0){
      const st = Number(products[idx].stock || 0);
      if(st<=0){
        alert("Ese producto est√° sin stock.");
        return;
      }
      products[idx].stock = String(st-1);
      setArr(LS.products, products);
      renderProducts();
    }
  }

  const sale = {
    numero:num,
    fechaISO: nowISO(),
    cliente:v_cliente.value.trim(),
    cedula:v_cedula.value.trim(),
    tel:v_tel.value.trim(),
    tipo,
    marca: tipo==="celular" ? v_marca.value.trim() : "",
    modelo: tipo==="celular" ? v_modelo.value.trim() : "",
    imei1: tipo==="celular" ? v_imei1.value.trim() : "",
    imei2: tipo==="celular" ? v_imei2.value.trim() : "",
    termsIMEI: tipo==="celular" ? true : false,
    descripcion: v_desc.value.trim(),
    total: v_total.value.trim(),
    pago: v_pago.value
  };

  sales.push(sale);
  sales.sort((a,b)=>a.numero-b.numero);
  setArr(LS.sales, sales);
  setNum(LS.saleCounter, num+1);

  // QR
  const text = `VENTA#${sale.numero} | ${sale.cliente} | ${sale.descripcion} | $${sale.total} | ${sale.pago} | IMEI1:${sale.imei1||""} IMEI2:${sale.imei2||""}`;
  document.getElementById("ventaQrText").textContent = "QR Venta #" + sale.numero;
  document.getElementById("ventaQrBox").classList.remove("hidden");
  renderQR("ventaQrImg", text);

  // limpiar "pendiente"
  info.innerHTML = "";
  info.dataset.pendingCode = "";

  toast("Venta guardada #" + num);
  refreshSaleLabel();
  renderSales();
};

document.getElementById("v_search").addEventListener("input", renderSales);
function renderSales(){
  const q = (document.getElementById("v_search").value||"").trim().toLowerCase();
  const sales = getArr(LS.sales);
  const filtered = q ? sales.filter(s=>JSON.stringify(s).toLowerCase().includes(q)) : sales;

  const box = document.getElementById("ventaList");
  if(!filtered.length){ box.innerHTML = "<div>No hay ventas.</div>"; return; }

  box.innerHTML = filtered.map(s=>`
    <div class="card" style="margin-bottom:10px">
      <div class="title">Venta #${s.numero}</div>
      <div class="kv">
        <div>Cliente: <span class="muted">${esc(s.cliente)}</span></div>
        <div>C√©dula: <span class="muted">${esc(s.cedula)}</span></div>
        <div>Tel: <span class="muted">${esc(s.tel)}</span></div>
        <div style="margin-top:6px">Tipo: <span class="muted">${esc(s.tipo)}</span></div>
        ${s.tipo==="celular" ? `
          <div>Equipo: <span class="muted">${esc(s.marca)} ${esc(s.modelo)}</span></div>
          <div>IMEI1: <span class="muted">${esc(s.imei1)}</span></div>
          ${s.imei2 ? `<div>IMEI2: <span class="muted">${esc(s.imei2)}</span></div>` : ``}
          <div><b>T√©rminos IMEI:</b> <span class="muted">Aceptados</span></div>
        ` : ``}
        <div style="margin-top:6px">Descripci√≥n: <span class="muted">${esc(s.descripcion)}</span></div>
        <div>Total: <span class="muted">${esc(s.total)}</span></div>
        <div>Pago: <span class="muted">${esc(s.pago)}</span></div>
        <div style="margin-top:6px">Fecha: <span class="muted">${fmtDate(s.fechaISO)}</span></div>
      </div>
      <div class="actionsRow">
        <button class="btn small" onclick="showSaleQR(${s.numero})">üî≥ QR</button>
        <button class="btn small danger" onclick="deleteSale(${s.numero})">üóëÔ∏è Borrar</button>
      </div>
    </div>
  `).join("");
}

window.showSaleQR = (numero)=>{
  const s = getArr(LS.sales).find(x=>x.numero===numero);
  if(!s) return;
  const text = `VENTA#${s.numero} | ${s.cliente} | ${s.descripcion} | $${s.total} | ${s.pago} | IMEI1:${s.imei1||""} IMEI2:${s.imei2||""}`;
  document.getElementById("ventaQrText").textContent = "QR Venta #" + s.numero;
  document.getElementById("ventaQrBox").classList.remove("hidden");
  renderQR("ventaQrImg", text);
  toast("QR de venta listo");
};

window.deleteSale = (numero)=>{
  if(!confirm("¬øBorrar venta #" + numero + "?")) return;
  const sales = getArr(LS.sales).filter(x=>x.numero!==numero);
  setArr(LS.sales, sales);
  renderSales();
  toast("Venta borrada");
};

document.getElementById("printVenta").onclick = ()=>printBox("ventaQrText","ventaQrImg");
  /* =========================
   INVENTARIO
========================= */
const invScanBtn = document.getElementById("invScanBtn");
const invCodeSearch = document.getElementById("invCodeSearch");
const invSearchInfo = document.getElementById("invSearchInfo");
const invSearchText = document.getElementById("invSearchText");
const invList = document.getElementById("invList");

const invFormBox = document.getElementById("invFormBox");
const invFormTitle = document.getElementById("invFormTitle");
const p_code=document.getElementById("p_code");
const p_name=document.getElementById("p_name");
const p_cat=document.getElementById("p_cat");
const p_subcat=document.getElementById("p_subcat");
const p_price=document.getElementById("p_price");
const p_stock=document.getElementById("p_stock");
const p_cost=document.getElementById("p_cost");
let editingCode = null;

function isAdmin(){
  return localStorage.getItem(LS.adminSession)==="1";
}
function applyAdminVisibility(){
  // costo solo visible si admin
  p_cost.style.display = isAdmin() ? "" : "none";
  p_cost.placeholder = isAdmin() ? "Costo ($) - solo admin" : "";
}

function clearInvSearchInfo(){
  invSearchInfo.innerHTML = "";
}

invScanBtn.onclick = ()=>openScannerToFunction((code)=>{
  invCodeSearch.value = code;
  invFindOrCreateByCode(code);
});

invCodeSearch.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    invFindOrCreateByCode(invCodeSearch.value.trim());
  }
});

document.getElementById("invNewBtn").onclick = ()=>{
  openProductForm(null);
};

invSearchText.addEventListener("input", renderProducts);

document.getElementById("invCancelBtn").onclick = ()=>{
  invFormBox.classList.add("hidden");
  editingCode = null;
  toast("Cancelado");
};

document.getElementById("invSaveBtn").onclick = ()=>{
  const code = p_code.value.trim();
  if(!code){ alert("El c√≥digo es obligatorio."); return; }
  if(!p_name.value.trim()){ alert("Nombre/Descripci√≥n es obligatorio."); return; }

  const products = getArr(LS.products);
  const existsIdx = products.findIndex(x=>String(x.code)===String(code));

  const product = {
    code,
    name: p_name.value.trim(),
    cat: p_cat.value.trim(),
    subcat: p_subcat.value.trim(),
    price: p_price.value.trim(),
    stock: p_stock.value.trim()
  };

  // costo solo admin
  if(isAdmin()){
    product.cost = p_cost.value.trim();
  } else {
    // si ya exist√≠a y ten√≠a cost, lo preservamos
    if(existsIdx>=0 && products[existsIdx].cost) product.cost = products[existsIdx].cost;
  }

  if(editingCode && String(editingCode)!==String(code)){
    // si cambia c√≥digo, validar que no exista
    if(existsIdx>=0){
      alert("Ese c√≥digo ya existe. No puedes duplicarlo.");
      return;
    }
    // borrar el viejo
    const filtered = products.filter(x=>String(x.code)!==String(editingCode));
    filtered.push(product);
    filtered.sort((a,b)=>String(a.code).localeCompare(String(b.code)));
    setArr(LS.products, filtered);
  } else {
    if(existsIdx>=0){
      products[existsIdx] = {...products[existsIdx], ...product};
      setArr(LS.products, products);
    } else {
      products.push(product);
      products.sort((a,b)=>String(a.code).localeCompare(String(b.code)));
      setArr(LS.products, products);
    }
  }

  invFormBox.classList.add("hidden");
  editingCode = null;
  renderProducts();
  toast("Producto guardado");
};

function invFindOrCreateByCode(code){
  if(!code){ alert("Escribe o escanea un c√≥digo."); return; }
  const products = getArr(LS.products);
  const p = products.find(x=>String(x.code)===String(code));

  if(p){
    invSearchInfo.innerHTML = `
      Producto encontrado ‚úÖ<br/>
      <b>${esc(p.code)}</b> ‚Äî ${esc(p.name)}<br/>
      Stock: <b>${esc(p.stock||"0")}</b> ‚Ä¢ Precio: <b>${esc(p.price||"")}</b>
    `;
    openProductForm(p.code);
  } else {
    invSearchInfo.innerHTML = `No existe el producto con c√≥digo <b>${esc(code)}</b>. Se abrir√° para crearlo ‚úÖ`;
    openProductForm(code);
  }
}

function openProductForm(codeOrNull){
  applyAdminVisibility();
  const products = getArr(LS.products);
  let p = null;

  if(codeOrNull && typeof codeOrNull === "string"){
    p = products.find(x=>String(x.code)===String(codeOrNull)) || null;
  } else if(codeOrNull && typeof codeOrNull === "object"){
    p = codeOrNull;
  }

  invFormBox.classList.remove("hidden");

  if(p){
    invFormTitle.textContent = "Editar producto";
    editingCode = p.code;
    p_code.value = p.code || "";
    p_name.value = p.name || "";
    p_cat.value = p.cat || "";
    p_subcat.value = p.subcat || "";
    p_price.value = p.price || "";
    p_stock.value = p.stock || "";
    p_cost.value = isAdmin() ? (p.cost || "") : "";
  } else {
    invFormTitle.textContent = "Nuevo producto";
    editingCode = null;
    p_code.value = codeOrNull || "";
    p_name.value = "";
    p_cat.value = "";
    p_subcat.value = "";
    p_price.value = "";
    p_stock.value = "";
    p_cost.value = "";
  }

  p_name.focus();
}

function renderProducts(){
  const q = (invSearchText.value||"").trim().toLowerCase();
  const products = getArr(LS.products);
  const filtered = q ? products.filter(p=>JSON.stringify(p).toLowerCase().includes(q)) : products;

  if(!filtered.length){
    invList.innerHTML = "<div>No hay productos.</div>";
    return;
  }

  invList.innerHTML = filtered.map(p=>{
    const costHtml = isAdmin() && p.cost ? `<div>Costo: <span class="muted">${esc(p.cost)}</span></div>` : ``;
    return `
      <div class="card" style="margin-bottom:10px">
        <div class="title">${esc(p.name)}</div>
        <div class="kv">
          <div>C√≥digo: <span class="muted">${esc(p.code)}</span></div>
          <div>Categor√≠a: <span class="muted">${esc(p.cat||"")}</span> ‚Ä¢ Sub: <span class="muted">${esc(p.subcat||"")}</span></div>
          <div>Precio: <span class="muted">${esc(p.price||"")}</span> ‚Ä¢ Stock: <span class="muted">${esc(p.stock||"0")}</span></div>
          ${costHtml}
        </div>
        <div class="actionsRow">
          <button class="btn small" onclick="productQR('${esc(p.code).replaceAll("'","")}')">üî≥ QR</button>
          <button class="btn small secondary" onclick="editProduct('${esc(p.code).replaceAll("'","")}')">‚úèÔ∏è Editar</button>
          <button class="btn small danger" onclick="deleteProduct('${esc(p.code).replaceAll("'","")}')">üóëÔ∏è Borrar</button>
        </div>
      </div>
    `;
  }).join("");
}

window.editProduct = (code)=>{
  const p = getArr(LS.products).find(x=>String(x.code)===String(code));
  if(!p) return;
  openProductForm(p.code);
};

window.deleteProduct = (code)=>{
  if(!isAdmin()){
    alert("Solo admin puede borrar productos.");
    return;
  }
  if(!confirm("¬øBorrar producto " + code + "?")) return;
  const products = getArr(LS.products).filter(x=>String(x.code)!==String(code));
  setArr(LS.products, products);
  renderProducts();
  toast("Producto borrado");
};

window.productQR = (code)=>{
  const p = getArr(LS.products).find(x=>String(x.code)===String(code));
  if(!p) return;
  // usamos el mismo modal de orden/venta? aqu√≠ lo m√°s simple: mostrar en invSearchInfo
  invSearchInfo.innerHTML = `QR del producto <b>${esc(p.code)}</b> ‚Äî ${esc(p.name)}<br/><div id="tmpInvQR" style="margin-top:10px; background:#fff; padding:8px; border-radius:12px; width:220px;"></div>`;
  setTimeout(()=>renderQR("tmpInvQR", String(p.code)), 50);
};

/* =========================
   ADMIN
========================= */
document.getElementById("pinEnter").onclick = ()=>{
  const v = document.getElementById("pinInput").value.trim();
  const real = localStorage.getItem(LS.pin) || "1234";
  if(v === real){
    localStorage.setItem(LS.adminSession, "1");
    document.getElementById("adminTools").classList.remove("hidden");
    toast("Admin activado");
  } else {
    alert("PIN incorrecto.");
  }
};

document.getElementById("changePinBtn").onclick = ()=>{
  const cur = prompt("PIN actual:");
  const real = localStorage.getItem(LS.pin) || "1234";
  if(cur !== real){ alert("PIN incorrecto."); return; }
  const np = prompt("Nuevo PIN (m√≠nimo 4 d√≠gitos):");
  if(!np || np.trim().length < 4){ alert("PIN inv√°lido."); return; }
  localStorage.setItem(LS.pin, np.trim());
  toast("PIN cambiado");
};

document.getElementById("wipeAllBtn").onclick = ()=>{
  if(!isAdmin()){ alert("Solo admin."); return; }
  if(!confirm("‚ö†Ô∏è Esto borra TODO (√≥rdenes, ventas, inventario). ¬øSeguro?")) return;
  if(!confirm("√öltima confirmaci√≥n: ¬øborrar TODO?")) return;
  localStorage.removeItem(LS.orders);
  localStorage.removeItem(LS.sales);
  localStorage.removeItem(LS.products);
  localStorage.removeItem(LS.brands);
  localStorage.setItem(LS.orderCounter, "2100");
  localStorage.setItem(LS.saleCounter, "315");
  toast("Todo borrado");
  renderOrders(); renderSales(); renderProducts();
  refreshOrderLabel(); refreshSaleLabel();
};

document.getElementById("backupBtn2").onclick = ()=>backupJSON();
document.getElementById("exportInvCsv2").onclick = ()=>exportInvCSV();
document.getElementById("exportOrdenCsv2").onclick = ()=>exportOrdersCSV();
document.getElementById("exportVentaCsv2").onclick = ()=>exportSalesCSV();

/* =========================
   BACKUP + EXPORT
========================= */
function download(filename, content, mime="text/plain"){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function toCSV(rows){
  const escv = (v)=> `"${String(v??"").replace(/"/g,'""')}"`;
  return rows.map(r=>r.map(escv).join(",")).join("\n");
}

function backupJSON(){
  const payload = {
    version: 2,
    exportedISO: nowISO(),
    counters: { order: nextOrder(), sale: nextSale() },
    orders: getArr(LS.orders),
    sales: getArr(LS.sales),
    products: getArr(LS.products),
    brands: getArr(LS.brands)
  };
  download(`backup_TE_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload,null,2), "application/json");
  toast("Backup descargado");
}
document.getElementById("backupBtn").onclick = backupJSON;

function exportOrdersCSV(){
  const orders = getArr(LS.orders);
  const rows = [["numero","fecha","cliente","cedula","tel","correo","marca","modelo","falla"]];
  orders.forEach(o=>{
    rows.push([o.numero, fmtDate(o.fechaISO), o.cliente, o.cedula, o.tel, o.correo, o.marca, o.modelo, o.falla]);
  });
  download(`ordenes_${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows), "text/csv");
  toast("CSV √≥rdenes listo");
}
function exportSalesCSV(){
  const sales = getArr(LS.sales);
  const rows = [["numero","fecha","cliente","cedula","tel","tipo","marca","modelo","imei1","imei2","descripcion","total","pago"]];
  sales.forEach(s=>{
    rows.push([s.numero, fmtDate(s.fechaISO), s.cliente, s.cedula, s.tel, s.tipo, s.marca, s.modelo, s.imei1, s.imei2, s.descripcion, s.total, s.pago]);
  });
  download(`ventas_${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows), "text/csv");
  toast("CSV ventas listo");
}
function exportInvCSV(){
  const products = getArr(LS.products);
  const rows = [["code","name","cat","subcat","price","stock","cost(admin)"]];
  products.forEach(p=>{
    rows.push([p.code,p.name,p.cat,p.subcat,p.price,p.stock,p.cost||""]);
  });
  download(`inventario_${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows), "text/csv");
  toast("CSV inventario listo");
}

document.getElementById("exportOrdenCsv").onclick = exportOrdersCSV;
document.getElementById("exportVentaCsv").onclick = exportSalesCSV;
document.getElementById("exportInvCsv").onclick = exportInvCSV;

/* =========================
   INIT
========================= */
showHome();
refreshOrderLabel();
refreshSaleLabel();
renderOrders();
renderSales();
renderProducts();
applyAdminVisibility();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Technology Expert's</title>
  <style>
    :root{
      --bg1:#0a2bd4;
      --bg2:#061a78;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --line:#e5e7eb;
      --btn:#0b1220;
      --btn2:#1d4ed8; /* azul rey */
      --danger:#dc2626;
      --ok:#16a34a;
      --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(160deg,var(--bg1),var(--bg2));
      color: white;
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .hero{
      padding:22px 10px 10px;
    }
    .title{font-size:44px;line-height:1.05;margin:0;font-weight:800;letter-spacing:-.5px}
    .subtitle{margin:8px 0 0;color:rgba(255,255,255,.9);max-width:720px}
    .glass{
      margin-top:18px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      border-radius:20px;
      padding:14px;
      backdrop-filter: blur(8px);
    }
    .menuRow{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .bigBtn{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;border-radius:18px;border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.16); color:white; font-weight:700;
      cursor:pointer;
    }
    .bigBtn.primary{background: rgba(255,255,255,.95); color:#0b1220;}
    .bigBtn.primary span{color:#0b1220}
    .bigBtn:hover{transform: translateY(-1px)}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .chip{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius:999px;font-weight:600;font-size:13px;
    }
    .panel{
      margin-top:16px;
      background: white;
      color: var(--text);
      border-radius:22px;
      padding:16px;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
    }
    .hidden{display:none!important}
    h2{margin:0 0 8px;font-size:28px}
    h3{margin:14px 0 8px;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    input, textarea, select{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:none;border-radius:14px;padding:12px 14px;
      font-weight:700;cursor:pointer;
    }
    .btn{background:var(--btn);color:white}
    .btnBlue{background:var(--btn2);color:white}
    .btnSoft{background:#eef2ff;color:#1e3a8a}
    .btnDanger{background:var(--danger);color:white}
    .btnOk{background:var(--ok);color:white}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tab{
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:white;cursor:pointer;font-weight:700;color:#111827;
    }
    .tab.active{background:var(--btn2);color:white;border-color:transparent}
    .kpi{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius:16px;padding:10px 12px;background:#f8fafc;
      min-width:180px;
    }
    .list{display:grid;gap:10px;margin-top:10px}
    .card{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background:white;
    }
    .cardTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      background:var(--chip);border:1px solid #c7d2fe;color:#1e3a8a;
      padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .smallBtn{
      padding:9px 10px;border-radius:12px;font-weight:800;
      background:#f3f4f6;color:#111827;border:1px solid #e5e7eb;
    }
    .smallBtn.danger{background:#fee2e2;color:#7f1d1d;border-color:#fecaca}
    .smallBtn.ok{background:#dcfce7;color:#14532d;border-color:#bbf7d0}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .numBanner{
      display:flex;justify-content:space-between;align-items:center;
      background:#0b1220;color:white;padding:10px 12px;border-radius:16px;
      margin:10px 0;
      font-weight:900;
    }
    .numBanner small{opacity:.85;font-weight:700}
    .sigBox{
      border:2px dashed #cbd5e1;border-radius:18px;padding:10px;background:#f8fafc;
    }
    canvas{width:100%;height:180px;border-radius:14px;background:white;border:1px solid var(--line);touch-action:none}
    .topTools{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px
    }
    .toolBtn{
      background:#f3f4f6;border:1px solid #e5e7eb;border-radius:16px;
      padding:12px;font-weight:900;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .search{
      margin-top:12px;
      background:white;border-radius:18px;padding:12px;border:1px solid rgba(255,255,255,.2);
    }
    .search input{border-radius:14px}
    .hint{margin-top:8px;color:#334155;font-size:13px}
    .pill{
      display:inline-block;margin-left:8px;
      padding:4px 8px;border-radius:999px;background:#e0e7ff;color:#1e3a8a;font-weight:800;font-size:12px;
    }
    .noteBox{
      background:#f8fafc;border:1px solid var(--line);
      border-radius:16px;padding:10px;color:#0f172a;font-size:13px;
    }
    .right{float:right}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- HOME -->
    <div id="home" class="hero">
      <h1 class="title">Technology Expert's</h1>
      <div class="subtitle">
        √ìrdenes + Ventas + Inventario + QR + Fotos. Sin servidor (por ahora). Para PC / Tablet / Celular.
      </div>

      <div class="glass">
        <div class="topTools">
          <button class="toolBtn" onclick="downloadCSV('orders')">‚¨áÔ∏è CSV √ìrdenes</button>
          <button class="toolBtn" onclick="downloadCSV('sales')">‚¨áÔ∏è CSV Ventas</button>
          <button class="toolBtn" onclick="downloadJSON()">üì¶ Backup JSON (todo)</button>
          <label class="toolBtn" style="cursor:pointer">
            üì• Importar Backup JSON
            <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importJSON(event)">
          </label>
        </div>

        <div class="search">
          <input id="globalSearch" placeholder="Buscar por #, nombre, c√©dula, tel, correo, marca, modelo, IMEI, producto..."
                 oninput="renderAllLists()"/>
          <div class="hint">Tip: escribe ‚ÄúR-00012‚Äù, ‚ÄúV-00008‚Äù, un IMEI o una marca.</div>
        </div>

        <div class="menuRow">
          <button class="bigBtn primary" onclick="openSection('orders')">
            <span>üßæ Orden de servicio</span><span>‚Ä∫</span>
          </button>
          <button class="bigBtn" onclick="openSection('sales')">
            <span>üí≥ Ventas</span><span>‚Ä∫</span>
          </button>
        </div>

        <div class="menuRow" style="grid-template-columns:1fr 1fr">
          <button class="bigBtn" onclick="openSection('inventory')">
            <span>üì¶ Inventario</span><span>‚Ä∫</span>
          </button>
          <button class="bigBtn" onclick="openSection('reports')">
            <span>üìà Reportes</span><span>‚Ä∫</span>
          </button>
        </div>

        <div class="chips">
          <div class="chip">üîê Admin con PIN</div>
          <div class="chip">‚úçÔ∏è Firma obligatoria (orden)</div>
          <div class="chip">üì∑ Fotos en √≥rdenes/ventas</div>
          <div class="chip">üè∑Ô∏è QR etiquetas</div>
          <div class="chip">üß† Autocompleta y ‚Äúaprende‚Äù marcas</div>
        </div>
      </div>
    </div>
<!-- ORDERS -->
    <div id="orders" class="panel hidden">
      <button class="btnSoft" onclick="goHome()">‚Üê Volver</button>
      <h2>Orden de Servicio</h2>
      <div class="muted">La firma del cliente es obligatoria para guardar.</div>

      <div class="numBanner">
        <div>üßæ N√∫mero: <span id="orderNextNum">R-00001</span></div>
        <small>Se asigna al guardar</small>
      </div>

      <div class="tabs">
        <div class="tab active" id="oTabForm" onclick="showOrdersTab('form')">Formulario</div>
        <div class="tab" id="oTabList" onclick="showOrdersTab('list')">Listado</div>
      </div>

      <div id="orderForm">
        <h3>Datos del cliente</h3>
        <div class="row">
          <div class="col"><input id="o_cliente" placeholder="Nombre del cliente" autocomplete="name"></div>
          <div class="col"><input id="o_cedula" placeholder="C√©dula" inputmode="numeric"></div>
        </div>
        <div class="row">
          <div class="col"><input id="o_tel" placeholder="Celular" inputmode="tel" autocomplete="tel"></div>
          <div class="col">
            <input id="o_email" placeholder="Correo electr√≥nico" autocomplete="email" list="emailDomains">
            <datalist id="emailDomains"></datalist>
          </div>
        </div>

        <h3>Equipo</h3>
        <div class="row">
          <div class="col">
            <input id="o_marca" placeholder="Marca del celular" list="brandList" onblur="learnBrand(this.value)">
            <datalist id="brandList"></datalist>
          </div>
          <div class="col"><input id="o_modelo" placeholder="Modelo del celular"></div>
        </div>
        <textarea id="o_falla" placeholder="Falla reportada"></textarea>

        <h3>Fotos</h3>
        <div class="noteBox">Puedes tomar foto o subir (se guarda dentro de la orden).</div>
        <div class="btnRow">
          <label class="btnSoft" style="cursor:pointer">
            üì∑ Agregar foto
            <input id="o_photo" type="file" accept="image/*" capture="environment" style="display:none" onchange="addTempPhoto('order',event)">
          </label>
          <button class="btnSoft" onclick="clearTempPhotos('order')">üßπ Quitar fotos</button>
        </div>
        <div id="o_photoPreview" class="list"></div>

        <h3>Firma del cliente (obligatoria)</h3>
        <div class="sigBox">
          <div class="muted">Firma con el dedo. (Si est√° en blanco, no deja guardar.)</div>
          <canvas id="sigCanvas"></canvas>
          <div class="btnRow">
            <button class="btnSoft" onclick="clearSignature()">üßº Borrar firma</button>
            <button class="btnBlue" onclick="saveOrder()">üíæ Guardar orden</button>
            <button class="btnSoft" onclick="newOrder()">üÜï Nueva orden (limpiar campos)</button>
          </div>
        </div>
      </div>

      <div id="orderList" class="hidden">
        <div class="btnRow">
          <button class="btnSoft" onclick="askPinAndRun('Borrar TODAS las √≥rdenes', clearOrders)">üóëÔ∏è Borrar TODAS (PIN)</button>
        </div>
        <div id="ordersList" class="list"></div>
      </div>
    </div>

    <!-- SALES -->
    <div id="sales" class="panel hidden">
      <button class="btnSoft" onclick="goHome()">‚Üê Volver</button>
      <h2>Ventas</h2>
      <div class="muted">Ventas separadas de √≥rdenes. IMEI puede ser 1 o 2. Incluye t√©rminos.</div>

      <div class="numBanner">
        <div>üí≥ N√∫mero: <span id="saleNextNum">V-00001</span></div>
        <small>Se asigna al guardar</small>
      </div>

      <div class="tabs">
        <div class="tab active" id="sTabForm" onclick="showSalesTab('form')">Formulario</div>
        <div class="tab" id="sTabList" onclick="showSalesTab('list')">Listado</div>
      </div>

      <div id="saleForm">
        <h3>Cliente</h3>
        <div class="row">
          <div class="col"><input id="s_cliente" placeholder="Nombre del cliente" autocomplete="name"></div>
          <div class="col"><input id="s_cedula" placeholder="C√©dula" inputmode="numeric"></div>
        </div>
        <div class="row">
          <div class="col"><input id="s_tel" placeholder="Celular" inputmode="tel" autocomplete="tel"></div>
          <div class="col"><input id="s_email" placeholder="Correo" autocomplete="email" list="emailDomains"></div>
        </div>

        <h3>Venta de tel√©fono</h3>
        <div class="row">
          <div class="col">
            <input id="s_marca" placeholder="Marca" list="brandList" onblur="learnBrand(this.value)">
          </div>
          <div class="col"><input id="s_modelo" placeholder="Modelo"></div>
        </div>

        <div class="row">
          <div class="col"><input id="s_imei1" placeholder="IMEI 1" inputmode="numeric"></div>
          <div class="col"><input id="s_imei2" placeholder="IMEI 2 (si aplica)" inputmode="numeric"></div>
        </div>

        <h3>Pago</h3>
        <div class="row">
          <div class="col"><input id="s_precio" placeholder="Precio de venta" inputmode="decimal" oninput="calcSale()"></div>
          <div class="col"><input id="s_costo" placeholder="Costo (para ganancia)" inputmode="decimal" oninput="calcSale()"></div>
        </div>
        <div class="row">
          <div class="col">
            <select id="s_pago">
              <option value="Efectivo">Efectivo</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Tarjeta">Tarjeta</option>
              <option value="Mixto">Mixto</option>
            </select>
          </div>
          <div class="col"><input id="s_nota" placeholder="Nota (opcional)"></div>
        </div>

        <div class="kpi">
          <div class="box"><b>Total:</b> <span id="s_total">$0</span></div>
          <div class="box"><b>Ganancia:</b> <span id="s_gain">$0</span></div>
        </div>

        <h3>T√©rminos</h3>
        <div class="noteBox">
          <b>Importante:</b> El comprador acepta que <b>Technology Expert's</b> no se hace responsable si no registra el/los IMEI ante el operador que va a usar.
        </div>
        <div style="margin-top:10px">
          <label style="display:flex;gap:10px;align-items:flex-start">
            <input id="s_terms" type="checkbox" style="width:auto;margin-top:3px">
            <span>Acepto los t√©rminos y condiciones anteriores (recomendado para guardar claro).</span>
          </label>
        </div>

        <h3>Fotos</h3>
        <div class="btnRow">
          <label class="btnSoft" style="cursor:pointer">
            üì∑ Agregar foto
            <input id="s_photo" type="file" accept="image/*" capture="environment" style="display:none" onchange="addTempPhoto('sale',event)">
          </label>
          <button class="btnSoft" onclick="clearTempPhotos('sale')">üßπ Quitar fotos</button>
        </div>
        <div id="s_photoPreview" class="list"></div>

        <div class="btnRow">
          <button class="btnBlue" onclick="saveSale()">üíæ Guardar venta</button>
          <button class="btnSoft" onclick="newSale()">üÜï Nueva venta (limpiar)</button>
        </div>
      </div>

      <div id="saleList" class="hidden">
        <div class="btnRow">
          <button class="btnSoft" onclick="askPinAndRun('Borrar TODAS las ventas', clearSales)">üóëÔ∏è Borrar TODAS (PIN)</button>
        </div>
        <div id="salesList" class="list"></div>
      </div>
    </div>

    <!-- INVENTORY -->
    <div id="inventory" class="panel hidden">
      <button class="btnSoft" onclick="goHome()">‚Üê Volver</button>
      <h2>Inventario</h2>
      <div class="muted">Registra productos, stock y alerta por bajo stock. (Editar/borrar con PIN)</div>

      <div class="tabs">
        <div class="tab active" id="iTabForm" onclick="showInvTab('form')">Agregar</div>
        <div class="tab" id="iTabList" onclick="showInvTab('list')">Listado</div>
      </div>

      <div id="invForm">
        <div class="row">
          <div class="col"><input id="i_nombre" placeholder="Nombre del producto (ej: Cable Tipo-C)"></div>
          <div class="col"><input id="i_sku" placeholder="SKU / C√≥digo (opcional)"></div>
        </div>
        <div class="row">
          <div class="col"><input id="i_costo" placeholder="Costo" inputmode="decimal"></div>
          <div class="col"><input id="i_precio" placeholder="Precio" inputmode="decimal"></div>
        </div>
        <div class="row">
          <div class="col"><input id="i_stock" placeholder="Stock" inputmode="numeric"></div>
          <div class="col"><input id="i_alerta" placeholder="Alerta bajo stock (ej: 3)" inputmode="numeric"></div>
        </div>
        <div class="btnRow">
          <button class="btnBlue" onclick="saveInv()">üíæ Guardar producto</button>
          <button class="btnSoft" onclick="newInv()">üÜï Nuevo</button>
        </div>
      </div>

      <div id="invList" class="hidden">
        <div class="btnRow">
          <button class="btnSoft" onclick="askPinAndRun('Borrar TODO el inventario', clearInv)">üóëÔ∏è Borrar todo (PIN)</button>
        </div>
        <div id="invListBox" class="list"></div>
      </div>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="panel hidden">
      <button class="btnSoft" onclick="goHome()">‚Üê Volver</button>
      <h2>Reportes</h2>
      <div class="muted">Ventas por fecha (total / ganancia). Pr√≥ximo: reportes m√°s avanzados.</div>

      <div class="row">
        <div class="col">
          <label class="muted">Desde</label>
          <input id="r_from" type="date" onchange="renderReports()">
        </div>
        <div class="col">
          <label class="muted">Hasta</label>
          <input id="r_to" type="date" onchange="renderReports()">
        </div>
      </div>

      <div class="kpi">
        <div class="box"><b>Ventas:</b> <span id="r_count">0</span></div>
        <div class="box"><b>Total:</b> <span id="r_total">$0</span></div>
        <div class="box"><b>Ganancia:</b> <span id="r_gain">$0</span></div>
      </div>

      <div class="divider"></div>
      <h3>Detalle</h3>
      <div id="reportList" class="list"></div>
    </div>

    <!-- PRINT (hidden container) -->
    <div id="printArea" class="hidden"></div>
  </div>

<script>
/* ==========================
   STORAGE + HELPERS
========================== */
const LS = {
  orders: "te_orders",
  sales: "te_sales",
  inv: "te_inventory",
  counters: "te_counters",
  brands: "te_brands",
  pin: "te_admin_pin",
};

function getArr(key){ try{return JSON.parse(localStorage.getItem(key)||"[]")}catch(e){return []} }
function setArr(key,val){ localStorage.setItem(key, JSON.stringify(val||[])); }
function getObj(key, def){ try{return JSON.parse(localStorage.getItem(key)||JSON.stringify(def))}catch(e){return def} }
function setObj(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
function money(n){
  const v = Number(n||0);
  return v.toLocaleString("es-CO",{style:"currency",currency:"COP",maximumFractionDigits:0});
}
function pad5(n){ return String(n).padStart(5,"0"); }
function todayISO(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function esc(s){ return (s||"").toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function norm(s){ return (s||"").toString().toLowerCase().trim(); }

function getCounters(){
  return getObj(LS.counters, { order: 1, sale: 1 });
}
function setCounters(c){ setObj(LS.counters,c); updateNextNumbers(); }

function getPin(){
  return localStorage.getItem(LS.pin) || "1234"; // PIN por defecto
}
function askPin(){
  const pin = prompt("PIN admin:");
  if(pin===null) return false;
  return pin === getPin();
}
function askPinAndRun(actionName, fn){
  if(!askPin()){
    alert("PIN incorrecto");
    return;
  }
  if(confirm(actionName + " ¬øSeguro?")){
    fn();
  }
}

/* ==========================
   HOME NAV
========================== */
function goHome(){
  document.getElementById("home").classList.remove("hidden");
  ["orders","sales","inventory","reports"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  renderAllLists();
}
function openSection(id){
  document.getElementById("home").classList.add("hidden");
  ["orders","sales","inventory","reports"].forEach(x=>{
    document.getElementById(x).classList.toggle("hidden", x!==id);
  });
  // cuando abre, muestra "n√∫mero pr√≥ximo" inmediatamente
  updateNextNumbers();
  if(id==="orders"){ showOrdersTab("form"); }
  if(id==="sales"){ showSalesTab("form"); calcSale(); }
  if(id==="inventory"){ showInvTab("form"); }
  if(id==="reports"){ initReportDates(); renderReports(); }
}

function updateNextNumbers(){
  const c = getCounters();
  document.getElementById("orderNextNum").textContent = "R-" + pad5(c.order);
  document.getElementById("saleNextNum").textContent = "V-" + pad5(c.sale);
}

/* ==========================
   TABS
========================== */
function showOrdersTab(which){
  const form=document.getElementById("orderForm");
  const list=document.getElementById("orderList");
  document.getElementById("oTabForm").classList.toggle("active", which==="form");
  document.getElementById("oTabList").classList.toggle("active", which==="list");
  form.classList.toggle("hidden", which!=="form");
  list.classList.toggle("hidden", which!=="list");
  if(which==="list") renderOrders();
  updateNextNumbers();
}
function showSalesTab(which){
  const form=document.getElementById("saleForm");
  const list=document.getElementById("saleList");
  document.getElementById("sTabForm").classList.toggle("active", which==="form");
  document.getElementById("sTabList").classList.toggle("active", which==="list");
  form.classList.toggle("hidden", which!=="form");
  list.classList.toggle("hidden", which!=="list");
  if(which==="list") renderSales();
  updateNextNumbers();
}
function showInvTab(which){
  const form=document.getElementById("invForm");
  const list=document.getElementById("invList");
  document.getElementById("iTabForm").classList.toggle("active", which==="form");
  document.getElementById("iTabList").classList.toggle("active", which==="list");
  form.classList.toggle("hidden", which!=="form");
  list.classList.toggle("hidden", which!=="list");
  if(which==="list") renderInv();
}

/* ==========================
   EMAIL SUGGESTIONS
========================== */
const emailDomains = ["gmail.com","hotmail.com","outlook.com","icloud.com","yahoo.com","live.com","proton.me","protonmail.com"];
function buildEmailDatalist(){
  const dl = document.getElementById("emailDomains");
  dl.innerHTML="";
  emailDomains.forEach(d=>{
    const opt=document.createElement("option");
    opt.value = "@"+d;
    dl.appendChild(opt);
  });
}
buildEmailDatalist();

/* ==========================
   BRAND AUTOCOMPLETE + LEARNING
========================== */
const defaultBrands = [
  "Samsung","Xiaomi","Redmi","POCO","Realme","Huawei","Honor","Motorola","Nokia",
  "Apple","iPhone","iPad","Tecno","Infinix","Itel","OPPO","Vivo","OnePlus",
  "ZTE","Alcatel","Sony","LG","Google Pixel","Asus","Lenovo","TCL","Meizu",
  "BlackBerry","HTC","Micromax","Blu","Cubot","Doogee","Ulefone","Umidigi",
  "Nothing","Meitu","CAT","Fairphone","Sharp","Panasonic","Philips","Sagem",
  "Qin","Gionee","Kyocera","Toshiba","Hisense","Razer","LeEco","Coolpad",
  "Wiko","Lanix","Hyundai","Maxwest","Energizer","General Mobile","BQ","Oukitel",
  "Innjoo","Karbonn","Lava","Symphony","Cherry Mobile","X-Tigi","Vernee",
  "Elephone","Leagoo","Haier","Vodafone","Orange","Xperia"
];

function getBrands(){
  const learned = getArr(LS.brands);
  const all = Array.from(new Set([...defaultBrands, ...learned]));
  all.sort((a,b)=>a.localeCompare(b,"es",{sensitivity:"base"}));
  return all;
}
function learnBrand(name){
  const clean = (name||"").trim();
  if(!clean) return;
  const lower = clean.toLowerCase();
  const allLower = getBrands().map(x=>x.toLowerCase());
  if(allLower.includes(lower)) return;
  const learned = getArr(LS.brands);
  learned.push(clean);
  setArr(LS.brands, learned);
  buildBrandDatalist();
}
function buildBrandDatalist(){
  const dl=document.getElementById("brandList");
  dl.innerHTML="";
  getBrands().forEach(b=>{
    const opt=document.createElement("option");
    opt.value=b;
    dl.appendChild(opt);
  });
}
buildBrandDatalist();

/* ==========================
   TEMP PHOTOS
========================== */
let tempPhotos = { order: [], sale: [] };

function addTempPhoto(kind, ev){
  const file = ev.target.files?.[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    tempPhotos[kind].push(reader.result);
    renderTempPhotos(kind);
    ev.target.value="";
  };
  reader.readAsDataURL(file);
}
function clearTempPhotos(kind){
  tempPhotos[kind]=[];
  renderTempPhotos(kind);
}
function renderTempPhotos(kind){
  const box = document.getElementById(kind==="order" ? "o_photoPreview" : "s_photoPreview");
  box.innerHTML = "";
  tempPhotos[kind].forEach((src, idx)=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML = `
      <div class="cardTop">
        <div><b>Foto ${idx+1}</b></div>
        <button class="smallBtn danger" onclick="removeTempPhoto('${kind}',${idx})">Eliminar</button>
      </div>
      <img src="${src}" style="width:100%;border-radius:14px;border:1px solid #e5e7eb;margin-top:10px">
    `;
    box.appendChild(c);
  });
}
function removeTempPhoto(kind, idx){
  tempPhotos[kind].splice(idx,1);
  renderTempPhotos(kind);
}

/* ==========================
   SIGNATURE (ORDER) - MANDATORY
========================== */
const canvas = document.getElementById("sigCanvas");
const ctx = canvas.getContext("2d");
let drawing=false, hasInk=false;

function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;
  canvas.width = Math.floor(rect.width * ratio);
  canvas.height = Math.floor(rect.height * ratio);
  ctx.setTransform(ratio,0,0,ratio,0,0);
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#0b1220";
}
window.addEventListener("resize", resizeCanvas);
setTimeout(resizeCanvas, 60);

function getPos(e){
  const r = canvas.getBoundingClientRect();
  const t = (e.touches && e.touches[0]) ? e.touches[0] : e;
  return { x: t.clientX - r.left, y: t.clientY - r.top };
}
function startDraw(e){
  drawing=true;
  const p=getPos(e);
  ctx.beginPath();
  ctx.moveTo(p.x,p.y);
  e.preventDefault?.();
}
function moveDraw(e){
  if(!drawing) return;
  const p=getPos(e);
  ctx.lineTo(p.x,p.y);
  ctx.stroke();
  hasInk=true;
  e.preventDefault?.();
}
function endDraw(){ drawing=false; }

canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", moveDraw);
window.addEventListener("mouseup", endDraw);
canvas.addEventListener("touchstart", startDraw, {passive:false});
canvas.addEventListener("touchmove", moveDraw, {passive:false});
canvas.addEventListener("touchend", endDraw);

function clearSignature(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  hasInk=false;
}
function signatureDataURL(){
  if(!hasInk) return "";
  return canvas.toDataURL("image/png");
    }
/* ==========================
   ORDERS CRUD
========================== */
let editingOrderId = null;

function newOrder(){
  editingOrderId = null;
  ["o_cliente","o_cedula","o_tel","o_email","o_marca","o_modelo","o_falla"].forEach(id=>document.getElementById(id).value="");
  clearTempPhotos("order");
  clearSignature();
  document.getElementById("o_cliente").focus();
  updateNextNumbers();
}

function validateOrder(){
  const cliente = o_cliente.value.trim();
  const cedula = o_cedula.value.trim();
  const tel = o_tel.value.trim();
  const email = o_email.value.trim();
  const marca = o_marca.value.trim();
  const modelo = o_modelo.value.trim();
  const falla = o_falla.value.trim();
  if(!cliente || !cedula || !tel || !email || !marca || !modelo || !falla){
    alert("Completa todos los campos de la orden.");
    return false;
  }
  if(!hasInk){
    alert("La firma es obligatoria para guardar la orden.");
    return false;
  }
  return true;
}

function saveOrder(){
  if(!validateOrder()) return;

  const orders = getArr(LS.orders);
  const c = getCounters();

  let num;
  if(editingOrderId){
    // mantiene n√∫mero
    const idx = orders.findIndex(o=>o.id===editingOrderId);
    if(idx<0){ alert("No encontr√© la orden para editar."); return; }
    num = orders[idx].num;
    orders[idx] = {
      ...orders[idx],
      cliente:o_cliente.value.trim(),
      cedula:o_cedula.value.trim(),
      tel:o_tel.value.trim(),
      email:o_email.value.trim(),
      marca:o_marca.value.trim(),
      modelo:o_modelo.value.trim(),
      falla:o_falla.value.trim(),
      photos: [...tempPhotos.order],
      firma: signatureDataURL(),
      updatedAt: new Date().toISOString(),
    };
  }else{
    num = "R-" + pad5(c.order);
    const rec = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random(),
      num,
      cliente:o_cliente.value.trim(),
      cedula:o_cedula.value.trim(),
      tel:o_tel.value.trim(),
      email:o_email.value.trim(),
      marca:o_marca.value.trim(),
      modelo:o_modelo.value.trim(),
      falla:o_falla.value.trim(),
      photos: [...tempPhotos.order],
      firma: signatureDataURL(),
      createdAt: new Date().toISOString(),
    };
    orders.push(rec);
    c.order += 1;
    setCounters(c);
  }

  // Orden ascendente por n√∫mero
  orders.sort((a,b)=>a.num.localeCompare(b.num,"es",{numeric:true}));
  setArr(LS.orders, orders);

  learnBrand(o_marca.value);
  alert("Orden guardada ‚úÖ");
  newOrder();
  showOrdersTab("list");
}

function renderOrders(){
  const q = norm(document.getElementById("globalSearch").value);
  const box = document.getElementById("ordersList");
  box.innerHTML="";
  const orders = getArr(LS.orders);

  const filtered = orders.filter(o=>{
    if(!q) return true;
    const hay = [
      o.num,o.cliente,o.cedula,o.tel,o.email,o.marca,o.modelo,o.falla
    ].join(" ").toLowerCase();
    return hay.includes(q);
  });

  if(filtered.length===0){
    box.innerHTML = `<div class="card"><b>No hay √≥rdenes.</b><div class="muted">Crea una desde ‚ÄúFormulario‚Äù.</div></div>`;
    return;
  }

  filtered.forEach(o=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="cardTop">
        <div>
          <div class="badge">üßæ ${esc(o.num)}</div>
          <div style="margin-top:8px"><b>${esc(o.cliente)}</b> <span class="pill">${esc(o.marca)} ${esc(o.modelo)}</span></div>
          <div class="muted">C√©dula: ${esc(o.cedula)} ¬∑ Tel: ${esc(o.tel)} ¬∑ Email: ${esc(o.email)}</div>
          <div style="margin-top:8px"><b>Falla:</b> ${esc(o.falla)}</div>
          <div class="muted" style="margin-top:6px">Fecha: ${new Date(o.createdAt||o.updatedAt||Date.now()).toLocaleString()}</div>
        </div>
        <div>
          <button class="smallBtn ok" onclick="printOrder('${o.id}')">üñ®Ô∏è Ticket</button>
        </div>
      </div>
      <div class="actions">
        <button class="smallBtn" onclick="editOrder('${o.id}')">‚úèÔ∏è Editar</button>
        <button class="smallBtn" onclick="openQR('order','${o.id}')">üè∑Ô∏è QR</button>
        <button class="smallBtn danger" onclick="askPinAndRun('Borrar ${o.num}', ()=>deleteOrder('${o.id}'))">üóëÔ∏è Borrar (PIN)</button>
      </div>
    `;
    box.appendChild(card);
  });
}

function editOrder(id){
  const orders=getArr(LS.orders);
  const o=orders.find(x=>x.id===id);
  if(!o){ alert("No se encontr√≥ la orden"); return; }

  editingOrderId = id;
  showOrdersTab("form");

  o_cliente.value=o.cliente||"";
  o_cedula.value=o.cedula||"";
  o_tel.value=o.tel||"";
  o_email.value=o.email||"";
  o_marca.value=o.marca||"";
  o_modelo.value=o.modelo||"";
  o_falla.value=o.falla||"";

  tempPhotos.order = Array.isArray(o.photos)? [...o.photos] : [];
  renderTempPhotos("order");

  clearSignature();
  if(o.firma){
    const img=new Image();
    img.onload=()=>{ ctx.drawImage(img,0,0,canvas.width/(window.devicePixelRatio||1),canvas.height/(window.devicePixelRatio||1)); hasInk=true; };
    img.src=o.firma;
  }else{
    hasInk=false;
  }

  document.getElementById("orderNextNum").textContent = o.num + " (editando)";
}

function deleteOrder(id){
  const orders=getArr(LS.orders).filter(x=>x.id!==id);
  setArr(LS.orders, orders);
  renderOrders();
  renderAllLists();
}

function clearOrders(){
  setArr(LS.orders, []);
  renderOrders();
  renderAllLists();
}

/* ==========================
   SALES CRUD
========================== */
let editingSaleId = null;

function calcSale(){
  const p = Number((s_precio.value||"").replace(/[^\d]/g,"")) || Number(s_precio.value||0) || 0;
  const c = Number((s_costo.value||"").replace(/[^\d]/g,"")) || Number(s_costo.value||0) || 0;
  document.getElementById("s_total").textContent = money(p);
  document.getElementById("s_gain").textContent = money(p-c);
}

function newSale(){
  editingSaleId=null;
  ["s_cliente","s_cedula","s_tel","s_email","s_marca","s_modelo","s_imei1","s_imei2","s_precio","s_costo","s_nota"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("s_pago").value="Efectivo";
  document.getElementById("s_terms").checked=false;
  clearTempPhotos("sale");
  document.getElementById("s_cliente").focus();
  calcSale();
  updateNextNumbers();
}

function validateSale(){
  const cliente=s_cliente.value.trim();
  const cedula=s_cedula.value.trim();
  const tel=s_tel.value.trim();
  const email=s_email.value.trim();
  const marca=s_marca.value.trim();
  const modelo=s_modelo.value.trim();
  const imei1=s_imei1.value.trim();
  const precio=Number(s_precio.value||0);
  if(!cliente||!cedula||!tel||!email||!marca||!modelo||!imei1||!precio){
    alert("Completa los campos obligatorios (incluye IMEI 1 y precio).");
    return false;
  }
  return true;
}

function saveSale(){
  if(!validateSale()) return;

  const sales = getArr(LS.sales);
  const c = getCounters();

  const precio = Number(s_precio.value||0);
  const costo = Number(s_costo.value||0);

  let num;
  if(editingSaleId){
    const idx=sales.findIndex(x=>x.id===editingSaleId);
    if(idx<0){ alert("No encontr√© la venta"); return; }
    num = sales[idx].num;
    sales[idx] = {
      ...sales[idx],
      cliente:s_cliente.value.trim(),
      cedula:s_cedula.value.trim(),
      tel:s_tel.value.trim(),
      email:s_email.value.trim(),
      marca:s_marca.value.trim(),
      modelo:s_modelo.value.trim(),
      imei1:s_imei1.value.trim(),
      imei2:s_imei2.value.trim(),
      precio,
      costo,
      pago:s_pago.value,
      nota:s_nota.value.trim(),
      termsAccepted: !!s_terms.checked,
      photos:[...tempPhotos.sale],
      updatedAt:new Date().toISOString(),
    };
  }else{
    num = "V-" + pad5(c.sale);
    const rec = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random(),
      num,
      cliente:s_cliente.value.trim(),
      cedula:s_cedula.value.trim(),
      tel:s_tel.value.trim(),
      email:s_email.value.trim(),
      marca:s_marca.value.trim(),
      modelo:s_modelo.value.trim(),
      imei1:s_imei1.value.trim(),
      imei2:s_imei2.value.trim(),
      precio,
      costo,
      pago:s_pago.value,
      nota:s_nota.value.trim(),
      termsAccepted: !!s_terms.checked,
      photos:[...tempPhotos.sale],
      createdAt:new Date().toISOString(),
    };
    sales.push(rec);
    c.sale += 1;
    setCounters(c);
  }

  sales.sort((a,b)=>a.num.localeCompare(b.num,"es",{numeric:true}));
  setArr(LS.sales, sales);

  learnBrand(s_marca.value);
  alert("Venta guardada ‚úÖ");
  newSale();
  showSalesTab("list");
}

function renderSales(){
  const q = norm(document.getElementById("globalSearch").value);
  const box = document.getElementById("salesList");
  box.innerHTML="";
  const sales = getArr(LS.sales);

  const filtered = sales.filter(s=>{
    if(!q) return true;
    const hay = [
      s.num,s.cliente,s.cedula,s.tel,s.email,s.marca,s.modelo,s.imei1,s.imei2,s.nota
    ].join(" ").toLowerCase();
    return hay.includes(q);
  });

  if(filtered.length===0){
    box.innerHTML = `<div class="card"><b>No hay ventas.</b><div class="muted">Crea una desde ‚ÄúFormulario‚Äù.</div></div>`;
    return;
  }

  filtered.forEach(s=>{
    const card=document.createElement("div");
    card.className="card";
    const gain = (Number(s.precio||0)-Number(s.costo||0));
    card.innerHTML = `
      <div class="cardTop">
        <div>
          <div class="badge">üí≥ ${esc(s.num)}</div>
          <div style="margin-top:8px"><b>${esc(s.cliente)}</b> <span class="pill">${esc(s.marca)} ${esc(s.modelo)}</span></div>
          <div class="muted">C√©dula: ${esc(s.cedula)} ¬∑ Tel: ${esc(s.tel)} ¬∑ Email: ${esc(s.email)}</div>
          <div style="margin-top:8px"><b>IMEI1:</b> ${esc(s.imei1)} ${s.imei2?`<br><b>IMEI2:</b> ${esc(s.imei2)}`:""}</div>
          <div style="margin-top:8px"><b>Total:</b> ${money(s.precio)} ¬∑ <b>Ganancia:</b> ${money(gain)} ¬∑ <b>Pago:</b> ${esc(s.pago)}</div>
          <div class="muted" style="margin-top:6px">Fecha: ${new Date(s.createdAt||s.updatedAt||Date.now()).toLocaleString()}</div>
          ${s.termsAccepted ? `<div class="muted" style="margin-top:6px">‚úÖ T√©rminos aceptados</div>` : `<div class="muted" style="margin-top:6px">‚ö†Ô∏è T√©rminos NO marcados</div>`}
        </div>
        <div>
          <button class="smallBtn ok" onclick="printSale('${s.id}')">üñ®Ô∏è Ticket</button>
        </div>
      </div>
      <div class="actions">
        <button class="smallBtn" onclick="editSale('${s.id}')">‚úèÔ∏è Editar</button>
        <button class="smallBtn" onclick="openQR('sale','${s.id}')">üè∑Ô∏è QR</button>
        <button class="smallBtn danger" onclick="askPinAndRun('Borrar ${s.num}', ()=>deleteSale('${s.id}'))">üóëÔ∏è Borrar (PIN)</button>
      </div>
    `;
    box.appendChild(card);
  });
}

function editSale(id){
  const sales=getArr(LS.sales);
  const s=sales.find(x=>x.id===id);
  if(!s){ alert("No se encontr√≥ la venta"); return; }

  editingSaleId=id;
  showSalesTab("form");

  s_cliente.value=s.cliente||"";
  s_cedula.value=s.cedula||"";
  s_tel.value=s.tel||"";
  s_email.value=s.email||"";
  s_marca.value=s.marca||"";
  s_modelo.value=s.modelo||"";
  s_imei1.value=s.imei1||"";
  s_imei2.value=s.imei2||"";
  s_precio.value=s.precio||"";
  s_costo.value=s.costo||"";
  s_pago.value=s.pago||"Efectivo";
  s_nota.value=s.nota||"";
  s_terms.checked=!!s.termsAccepted;

  tempPhotos.sale = Array.isArray(s.photos)? [...s.photos] : [];
  renderTempPhotos("sale");

  calcSale();
  document.getElementById("saleNextNum").textContent = s.num + " (editando)";
}

function deleteSale(id){
  const sales=getArr(LS.sales).filter(x=>x.id!==id);
  setArr(LS.sales, sales);
  renderSales();
  renderAllLists();
}

function clearSales(){
  setArr(LS.sales, []);
  renderSales();
  renderAllLists();
  }
/* ==========================
   INVENTORY CRUD
========================== */
let editingInvId=null;

function newInv(){
  editingInvId=null;
  ["i_nombre","i_sku","i_costo","i_precio","i_stock","i_alerta"].forEach(id=>document.getElementById(id).value="");
  i_nombre.focus();
}

function saveInv(){
  const nombre=i_nombre.value.trim();
  const sku=i_sku.value.trim();
  const costo=Number(i_costo.value||0);
  const precio=Number(i_precio.value||0);
  const stock=Number(i_stock.value||0);
  const alerta=Number(i_alerta.value||0);

  if(!nombre){ alert("Nombre del producto es obligatorio"); return; }

  const inv=getArr(LS.inv);

  if(editingInvId){
    const idx=inv.findIndex(x=>x.id===editingInvId);
    if(idx<0){ alert("No encontr√© producto"); return; }
    inv[idx]={...inv[idx], nombre, sku, costo, precio, stock, alerta, updatedAt:new Date().toISOString()};
  }else{
    inv.push({
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random(),
      nombre, sku, costo, precio, stock, alerta,
      createdAt:new Date().toISOString()
    });
  }
  inv.sort((a,b)=>a.nombre.localeCompare(b.nombre,"es",{sensitivity:"base"}));
  setArr(LS.inv, inv);
  alert("Producto guardado ‚úÖ");
  newInv();
  showInvTab("list");
  renderInv();
  renderAllLists();
}

function renderInv(){
  const q = norm(document.getElementById("globalSearch").value);
  const box=document.getElementById("invListBox");
  box.innerHTML="";
  const inv=getArr(LS.inv);

  const filtered = inv.filter(p=>{
    if(!q) return true;
    const hay=[p.nombre,p.sku].join(" ").toLowerCase();
    return hay.includes(q);
  });

  if(filtered.length===0){
    box.innerHTML=`<div class="card"><b>No hay productos.</b><div class="muted">Agrega desde ‚ÄúAgregar‚Äù.</div></div>`;
    return;
  }

  filtered.forEach(p=>{
    const low = (p.alerta>0 && p.stock<=p.alerta);
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="cardTop">
        <div>
          <div class="badge">üì¶ ${esc(p.nombre)} ${p.sku?`<span class="pill">${esc(p.sku)}</span>`:""}</div>
          <div style="margin-top:8px"><b>Stock:</b> ${p.stock} ${low?`<span class="pill" style="background:#fee2e2;color:#7f1d1d">‚ö† Bajo</span>`:""}</div>
          <div class="muted">Costo: ${money(p.costo)} ¬∑ Precio: ${money(p.precio)} ¬∑ Alerta: ${p.alerta||0}</div>
        </div>
        <div>
          <button class="smallBtn" onclick="openQR('inv','${p.id}')">üè∑Ô∏è QR</button>
        </div>
      </div>
      <div class="actions">
        <button class="smallBtn" onclick="askPinAndRun('Editar producto', ()=>editInv('${p.id}'))">‚úèÔ∏è Editar (PIN)</button>
        <button class="smallBtn danger" onclick="askPinAndRun('Borrar producto', ()=>deleteInv('${p.id}'))">üóëÔ∏è Borrar (PIN)</button>
      </div>
    `;
    box.appendChild(card);
  });
}

function editInv(id){
  const inv=getArr(LS.inv);
  const p=inv.find(x=>x.id===id);
  if(!p) return;
  editingInvId=id;
  showInvTab("form");
  i_nombre.value=p.nombre||"";
  i_sku.value=p.sku||"";
  i_costo.value=p.costo||"";
  i_precio.value=p.precio||"";
  i_stock.value=p.stock||"";
  i_alerta.value=p.alerta||"";
  i_nombre.focus();
}
function deleteInv(id){
  const inv=getArr(LS.inv).filter(x=>x.id!==id);
  setArr(LS.inv, inv);
  renderInv();
  renderAllLists();
}
function clearInv(){
  setArr(LS.inv, []);
  renderInv();
  renderAllLists();
}

/* ==========================
   REPORTS
========================== */
function initReportDates(){
  if(!r_from.value) r_from.value = todayISO();
  if(!r_to.value) r_to.value = todayISO();
}
function renderReports(){
  const from = r_from.value || todayISO();
  const to = r_to.value || todayISO();
  const fromD = new Date(from+"T00:00:00");
  const toD = new Date(to+"T23:59:59");

  const sales=getArr(LS.sales);
  const rows = sales.filter(s=>{
    const d = new Date(s.createdAt||s.updatedAt||Date.now());
    return d>=fromD && d<=toD;
  }).sort((a,b)=>a.num.localeCompare(b.num,"es",{numeric:true}));

  let total=0, gain=0;
  rows.forEach(s=>{
    total += Number(s.precio||0);
    gain += (Number(s.precio||0)-Number(s.costo||0));
  });

  r_count.textContent = rows.length;
  r_total.textContent = money(total);
  r_gain.textContent = money(gain);

  const box=document.getElementById("reportList");
  box.innerHTML="";
  if(rows.length===0){
    box.innerHTML=`<div class="card"><b>Sin ventas en ese rango.</b></div>`;
    return;
  }
  rows.forEach(s=>{
    const g = (Number(s.precio||0)-Number(s.costo||0));
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="cardTop">
        <div>
          <div class="badge">üí≥ ${esc(s.num)}</div>
          <div style="margin-top:8px"><b>${esc(s.cliente)}</b> ¬∑ ${esc(s.marca)} ${esc(s.modelo)}</div>
          <div class="muted">Total: ${money(s.precio)} ¬∑ Ganancia: ${money(g)} ¬∑ Pago: ${esc(s.pago)}</div>
          <div class="muted">IMEI1: ${esc(s.imei1)} ${s.imei2?(" ¬∑ IMEI2: "+esc(s.imei2)):""}</div>
        </div>
        <div><button class="smallBtn ok" onclick="printSale('${s.id}')">üñ®Ô∏è Ticket</button></div>
      </div>
    `;
    box.appendChild(card);
  });
}

/* ==========================
   GLOBAL LIST RENDER
========================== */
function renderAllLists(){
  // si est√°s dentro de secciones, refresca listados sin molestar
  if(!document.getElementById("orders").classList.contains("hidden")) renderOrders();
  if(!document.getElementById("sales").classList.contains("hidden")) renderSales();
  if(!document.getElementById("inventory").classList.contains("hidden")) renderInv();
}

/* ==========================
   QR (simple)
   - Genera QR usando servicio p√∫blico (requiere internet)
   - Si luego quieres 100% offline, te lo cambio a QR local (m√°s c√≥digo).
========================== */
function openQR(type, id){
  let data="";
  if(type==="order"){
    const o=getArr(LS.orders).find(x=>x.id===id); if(!o) return;
    data = `${o.num} | ${o.cliente} | ${o.marca} ${o.modelo} | ${o.tel}`;
  }
  if(type==="sale"){
    const s=getArr(LS.sales).find(x=>x.id===id); if(!s) return;
    data = `${s.num} | ${s.cliente} | ${s.marca} ${s.modelo} | IMEI1:${s.imei1} ${s.imei2?("IMEI2:"+s.imei2):""}`;
  }
  if(type==="inv"){
    const p=getArr(LS.inv).find(x=>x.id===id); if(!p) return;
    data = `INV | ${p.nombre} | SKU:${p.sku||""}`;
  }
  const url = "https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=" + encodeURIComponent(data);
  const w = window.open("");
  w.document.write(`<title>QR</title><div style="font-family:system-ui;padding:14px">
    <h2>QR</h2>
    <div style="color:#334155;margin-bottom:10px">${esc(data)}</div>
    <img src="${url}" style="border:1px solid #e5e7eb;border-radius:14px">
    <div style="margin-top:12px"><button onclick="window.print()" style="padding:10px 12px;border-radius:12px;border:none;background:#1d4ed8;color:#fff;font-weight:800">Imprimir</button></div>
  </div>`);
}

/* ==========================
   PRINT TICKETS
========================== */
function printOrder(id){
  const o=getArr(LS.orders).find(x=>x.id===id);
  if(!o) return;
  const html = `
  <div style="font-family:system-ui;max-width:380px">
    <h2 style="margin:0">Technology Expert's</h2>
    <div style="color:#475569;margin-bottom:10px">Ticket Orden de Servicio</div>
    <hr>
    <b>${esc(o.num)}</b><br>
    <b>Cliente:</b> ${esc(o.cliente)}<br>
    <b>C√©dula:</b> ${esc(o.cedula)}<br>
    <b>Tel:</b> ${esc(o.tel)}<br>
    <b>Email:</b> ${esc(o.email)}<br><br>
    <b>Equipo:</b> ${esc(o.marca)} ${esc(o.modelo)}<br>
    <b>Falla:</b> ${esc(o.falla)}<br>
    <div style="color:#475569;margin-top:8px">Fecha: ${new Date(o.createdAt||Date.now()).toLocaleString()}</div>
    <hr>
    <div><b>Firma:</b></div>
    <img src="${o.firma||""}" style="width:100%;border:1px solid #e5e7eb;border-radius:10px;margin-top:6px">
    ${o.photos?.length?`<hr><div><b>Fotos:</b></div>${o.photos.map(p=>`<img src="${p}" style="width:100%;border:1px solid #e5e7eb;border-radius:10px;margin-top:8px">`).join("")}`:""}
  </div>`;
  openPrint(html);
}
function printSale(id){
  const s=getArr(LS.sales).find(x=>x.id===id);
  if(!s) return;
  const gain = (Number(s.precio||0)-Number(s.costo||0));
  const terms = `El comprador acepta que Technology Expert's no se hace responsable si no registra el/los IMEI ante el operador que va a usar.`;
  const html = `
  <div style="font-family:system-ui;max-width:380px">
    <h2 style="margin:0">Technology Expert's</h2>
    <div style="color:#475569;margin-bottom:10px">Ticket de Venta</div>
    <hr>
    <b>${esc(s.num)}</b><br>
    <b>Cliente:</b> ${esc(s.cliente)}<br>
    <b>C√©dula:</b> ${esc(s.cedula)}<br>
    <b>Tel:</b> ${esc(s.tel)}<br>
    <b>Email:</b> ${esc(s.email)}<br><br>
    <b>Equipo:</b> ${esc(s.marca)} ${esc(s.modelo)}<br>
    <b>IMEI1:</b> ${esc(s.imei1)}<br>
    ${s.imei2?`<b>IMEI2:</b> ${esc(s.imei2)}<br>`:""}
    <hr>
    <b>Total:</b> ${money(s.precio)}<br>
    <b>Pago:</b> ${esc(s.pago)}<br>
    <b>Ganancia:</b> ${money(gain)}<br>
    <div style="color:#475569;margin-top:8px">Fecha: ${new Date(s.createdAt||Date.now()).toLocaleString()}</div>
    <hr>
    <div style="font-size:12px;color:#334155">
      <b>T√©rminos:</b> ${esc(terms)}<br>
      <b>Aceptado:</b> ${s.termsAccepted?"SI":"NO"}
    </div>
    ${s.photos?.length?`<hr><div><b>Fotos:</b></div>${s.photos.map(p=>`<img src="${p}" style="width:100%;border:1px solid #e5e7eb;border-radius:10px;margin-top:8px">`).join("")}`:""}
  </div>`;
  openPrint(html);
}
function openPrint(html){
  const w = window.open("");
  w.document.write(`
    <html><head><title>Imprimir</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head><body>${html}
    <script>setTimeout(()=>window.print(), 300)<\/script>
    </body></html>
  `);
}

/* ==========================
   EXPORT / IMPORT
========================== */
function downloadJSON(){
  if(!askPin()){ alert("PIN incorrecto"); return; }
  const data = {
    orders:getArr(LS.orders),
    sales:getArr(LS.sales),
    inventory:getArr(LS.inv),
    counters:getCounters(),
    brands:getArr(LS.brands),
    pin:getPin(),
    exportedAt:new Date().toISOString(),
    app:"Technology Expert's"
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="TE_backup.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function importJSON(ev){
  if(!askPin()){ alert("PIN incorrecto"); ev.target.value=""; return; }
  const file=ev.target.files?.[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const data=JSON.parse(reader.result);
      if(!confirm("Esto reemplazar√° tus datos actuales. ¬øSeguro?")) return;
      setArr(LS.orders, data.orders||[]);
      setArr(LS.sales, data.sales||[]);
      setArr(LS.inv, data.inventory||[]);
      setObj(LS.counters, data.counters||{order:1,sale:1});
      setArr(LS.brands, data.brands||[]);
      buildBrandDatalist();
      alert("Backup importado ‚úÖ");
      renderAllLists();
      updateNextNumbers();
    }catch(e){
      alert("JSON inv√°lido");
    }finally{
      ev.target.value="";
    }
  };
  reader.readAsText(file);
}

function toCSV(rows, headers){
  const escCSV = (v)=>{
    const s=(v??"").toString().replace(/"/g,'""');
    return `"${s}"`;
  };
  const lines=[];
  lines.push(headers.map(escCSV).join(","));
  rows.forEach(r=>{
    lines.push(headers.map(h=>escCSV(r[h])).join(","));
  });
  return lines.join("\n");
}

function downloadCSV(type){
  if(!askPin()){ alert("PIN incorrecto"); return; }
  if(type==="orders"){
    const rows=getArr(LS.orders).map(o=>({
      num:o.num, cliente:o.cliente, cedula:o.cedula, tel:o.tel, email:o.email,
      marca:o.marca, modelo:o.modelo, falla:o.falla,
      createdAt:o.createdAt||"", updatedAt:o.updatedAt||"",
      photos:(o.photos||[]).length, firma: o.firma? "SI":"NO"
    }));
    const headers=["num","cliente","cedula","tel","email","marca","modelo","falla","createdAt","updatedAt","photos","firma"];
    const csv=toCSV(rows,headers);
    dl(csv,"TE_ordenes.csv");
  }
  if(type==="sales"){
    const rows=getArr(LS.sales).map(s=>({
      num:s.num, cliente:s.cliente, cedula:s.cedula, tel:s.tel, email:s.email,
      marca:s.marca, modelo:s.modelo, imei1:s.imei1, imei2:s.imei2,
      precio:s.precio, costo:s.costo, pago:s.pago, nota:s.nota,
      termsAccepted:s.termsAccepted?"SI":"NO",
      createdAt:s.createdAt||"", updatedAt:s.updatedAt||"",
      photos:(s.photos||[]).length
    }));
    const headers=["num","cliente","cedula","tel","email","marca","modelo","imei1","imei2","precio","costo","pago","nota","termsAccepted","createdAt","updatedAt","photos"];
    const csv=toCSV(rows,headers);
    dl(csv,"TE_ventas.csv");
  }
}
function dl(text, filename){
  const blob=new Blob([text],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ==========================
   INIT
========================== */
updateNextNumbers();
newOrder();
newSale();
newInv();
goHome();

</script>
</body>
</html>



